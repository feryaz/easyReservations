(function(h,G){var g=h(".er-timeline-tooltip"),m=h(".er-timeline"),p=h("#timeline-datepicker"),r=m.find("div.sidebar"),l=m.find("div.timeline"),w=m.find("div.header"),x=m.find("div.resources table"),C=w.find(".date"),y=l.find("table"),k=l.find("thead tr"),a=y.find("tbody"),B=[],v=new Date(),A=new Date(),i=new Date(),e=false,I=false,f=false,o=false,s=false,d=0,b=0,F=true,E=false,c=false,H=false,n={height:34,width:96},j=0,q=0,D=0,z=G.default_interval;m.insertAfter("hr.wp-header-end");g.insertAfter("hr.wp-header-end");r.hide();A.setHours(0,0,0,0);w.on("click",".expand-sidebar",function(){r.addClass("expanded").show();h(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){r.removeClass("expanded").hide(300,"linear");h(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".date",function(){u.toggle()}).on("click",".today",function(){t.jump_to_date(A)});p.bind("change",function(J){console.log(J);console.log(h(this).val());t.jump_to_date(h(this).datepicker("getDate"))});l.find("thead").on({mousedown:function(J){E=l.scrollLeft()+J.pageX}});h(window).mouseup(function(){k.css("cursor","grab");clearInterval(c);c=false;E=false;t.clear_scroll_timeout()});m.mousemove(function(J){d=J.pageX;b=J.pageY;if(E&&J.which===1){l.scrollLeft(E-J.pageX<1?1:E-J.pageX);if(H===false){k.css("cursor","grabbing");t.start_scroll_add_interval()}}if(j!==J.target){j=J.target;if(j.getAttribute("data-date")){t.highlight_current(new Date(parseInt(J.target.getAttribute("data-date"),10)))}if(j.getAttribute("data-space")){o=h(j).offset().top}else{if(j.getAttribute("data-id")){o=h(j).parent().offset().top}}}}).mouseleave(function(){k.css("cursor","grab");clearInterval(c);c=false;E=false;t.clear_scroll_timeout()}).on("mousedown",".next",function(){if(c===false){c=setInterval(function(){if(c!==false){l.scrollLeft(l.scrollLeft()+n.width);t.start_scroll_add_interval()}},100)}}).on("mousedown",".prev",function(){if(c===false){c=setInterval(function(){if(c!==false){l.scrollLeft(l.scrollLeft()-n.width);t.start_scroll_add_interval()}},100)}});l.scroll(function(){t.set_current_date();if(c!==false){k.css("cursor","grabbing")}});var u={is_open:function(){return r.hasClass("expanded")},open:function(){if(!u.is_open()){w.find(".expand-sidebar").click()}},close:function(){if(u.is_open()){w.find(".contract-sidebar").click()}},toggle:function(){if(u.is_open()){w.find(".contract-sidebar").click()}else{w.find(".expand-sidebar").click()}}};u.open();var t={init:function(){var J,K;if(z==="86400"){i.setHours(0,0,0,0)}else{i.setHours(i.getHours(),0,0,0)}y.find("td,th").remove();B=[];i=t.manipulate_date_without_offset(i,(15*z*1000)*-1);J=i;D=new Date(J.getTime());q=new Date(J.getTime());for(K=0;K<50;K++){e=t.manipulate_date_without_offset(J,K*z*1000);t.generate_column(e)}t.load_remaining();l.scrollLeft(k.find("th:nth-child(15)").offset().left-l.offset().left+l.scrollLeft()+1);t.set_current_date()},remove_offset:function(J){return new Date(J.getTime()-J.getTimezoneOffset()*1000*60)},manipulate_date_without_offset:function(J,K){var L=new Date(J.getTime()+K);return new Date(L.getTime()+L.getTimezoneOffset()*1000*60-J.getTimezoneOffset()*1000*60)},highlight_current:function(J){h(".er-timeline .hover").removeClass("hover");h('*[data-date="'+J.getTime()+'"]').addClass("hover")},set_current_date:function(){k.find("th.current").removeClass("current");v=t.manipulate_date_without_offset(i,((l.scrollLeft()/n.width+1)*z*1000));if(z==="3600"){v.setHours(i.getHours(),0,0,0);C.html(v.getDate()+" "+er_date_picker_params.month_names[v.getMonth()]+" "+v.getFullYear())}else{v.setHours(0,0,0,0);C.html(er_date_picker_params.month_names[v.getMonth()]+" "+v.getFullYear())}k.find('th[data-date="'+v.getTime()+'"]').addClass("current");p.datepicker("setDate",v)},start_scroll_add_interval:function(){if(H===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){H=setInterval(function(){if(H!==false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){t.add_new_column(l.scrollLeft()<2);t.set_current_date()}},38)}},jump_to_date:function(K){if(K<i||K>e){i=K;t.init()}else{var M=(v.getTime()-K.getTime()+K.getTimezoneOffset()*1000*60-v.getTimezoneOffset()*1000*60)/(z*1000),J=Math.abs(M);console.log(M);for(var L=1;L<=J;L++){t.add_new_column(M>0)}t.set_current_date()}},add_new_column:function(J){if(J){i=t.manipulate_date_without_offset(i,z*1000*-1);t.generate_column(i,true);y.find("th:last-child,td:last-child").remove();D=t.manipulate_date_without_offset(D,z*1000*-1);e=t.manipulate_date_without_offset(e,z*1000*-1)}else{e=t.manipulate_date_without_offset(e,z*1000);t.generate_column(e);y.find("th:first-child").remove();y.find("td:first-child").each(function(){var K=h(this).data("reservations");if(K&&K.length>0){h.each(K,function(L,M){if(B[M]&&typeof B[M]!=="undefined"){B[M].changed=true}})}}).remove();q=t.manipulate_date_without_offset(q,z*1000);i=t.manipulate_date_without_offset(i,z*1000)}},clear_scroll_timeout:function(){if(H!==false){clearInterval(H);H=false;t.load_remaining()}},load_remaining:function(){if(q===0||q>i){t.load_data(i,q);q=new Date(i.getTime())}else{if(D<e){var J=t.manipulate_date_without_offset(e,z*1000);t.load_data(D,J);D=J}else{}}},load_data:function(K,J){h.ajax({url:G.ajax_url,data:{action:"easyreservations_timeline_data",security:G.nonce,start:K.getDate()+"."+(K.getMonth()+1)+"."+K.getFullYear(),start_hour:K.getHours(),end:J.getDate()+"."+(J.getMonth()+1)+"."+J.getFullYear(),end_hour:J.getHours(),interval:z},type:"POST",success:function(L){if(L.data){h.each(L.data,function(O,N){var M=G.resources[O].quantity;h.each(N,function(T,P){var R=new Date(parseInt(T,10)*1000),Q="",S="";if(P<0){Q="unavailable";S=0}else{S=M-P}h('td[data-date="'+(R.getTime()+(R.getTimezoneOffset()*1000*60))+'"][data-resource="'+O+'"]').removeClass("loading").addClass(Q);h('tr.resource td[data-date="'+(R.getTime()+(R.getTimezoneOffset()*1000*60))+'"][data-resource="'+O+'"]').html("<div><span>"+S+"</span></div>").addClass(P==M?"unavailable":"")})})}if(L.reservations){h.each(L.reservations,function(M,N){t.add_reservation(N)});t.draw_reservations()}}})},draw_reservations:function(){var J=[];h.each(B,function(K,L){if(L&&L.changed){J.push(L.id)}});J.sort(function(L,K){return B[L].arrival<B[K].arrival?-1:1});h.each(J,function(K,L){if(L){if(!t.draw_reservation(B[L])){t.draw_reservations();return false}}})},recursively_remove_reservation:function(M){var N=parseInt(M.id,10),L=new Date(M.arrival.getTime()),K=new Date(M.departure.getTime());if(z==="86400"){L.setHours(0,0,0);K.setHours(0,0,0)}else{L.setHours(L.getHours(),0,0);K.setHours(K.getHours(),0,0)}while(L<=K){var J=h('td[data-date="'+(L.getTime())+'"][data-resource="'+M.resource+'"][data-space="'+M.space+'"]');if(J.length>0){t.recursively_remove_reservations(J,M.depths,N)}L=t.manipulate_date_without_offset(L,z*1000)}return false},recursively_remove_reservations:function(K,O,P){var J=K.data("reservations"),N=[],L=false,M=0;if(J&&J.length>0){h.each(J,function(Q,R){if(R){if(R===P||B[R].depths>=O){if(L===false){L=B[R].depths}L=Math.min(L,B[R].depths);s=true;B[R].changed=true}else{N.push(R);M=Math.max(M,B[R].depths)}}})}K.data("reservations",N);if(L!==false){return t.recursively_remove_reservations(K.next(),L,P)}return true},draw_reservation:function(L){var J=parseInt(L.id,10),M=new Date(L.arrival.getTime()),O=new Date(L.departure.getTime()),P=h('<div class="reservation">'),K=(L.departure.getTime()-L.arrival.getTime()),R=(((K/1000)/z)*n.width)-(z==="86400"?2:1),U=false,V=[],S=0;s=false;if(z==="86400"){M.setHours(0,0,0);O.setHours(0,0,0)}else{M.setHours(M.getHours(),0,0);O.setHours(O.getHours(),0,0)}while(M<=O){var T=h('td[data-date="'+(M.getTime())+'"][data-resource="'+L.resource+'"][data-space="'+L.space+'"]');if(T&&T.length>0){var Q=T.data("reservations");if(Q.length>0){h.each(Q,function(W,X){if(X&&X!==J){if(B[X].arrival>L.arrival&&B[X].arrival<L.departure&&B[X].departure>L.arrival){t.recursively_remove_reservations(T,S,X)}else{if(B[X].departure<=L.arrival||B[X].arrival>=L.departure){}else{V[B[X].depths]=1}}}})}if(U===false){P.css("left",(((L.arrival.getTime()-M.getTime())/1000/z*n.width)-1)+"px");U=T}if(h.inArray(J,Q)<0){Q.push(J);T.data("reservations",Q)}}M=t.manipulate_date_without_offset(M,z*1000)}if(U===false){return true}else{if(s){return false}else{P.html('<span class="wrapper"><span>#'+J+" "+L.title+"</span></span>").draggable({snap:F?false:"td.cell,.reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",containment:a,revert:function(W,X){if(W){return W}if(h(this).data("uiDraggable")){}h(this).data("uiDraggable").originalPosition={top:I.top-1,left:I.left};return !W},stack:".reservation",scope:"reservations",start:function(W,X){I=X.originalPosition;f=X.offset},drag:function(Y,Z){var ac=parseInt(Z.helper.attr("data-id"),10),W=B[ac],ab=z/n.width*(Z.position.left-I.left),X=d-l.offset().left;if(F){var aa=Math.round((Z.position.left-I.left)/n.width);ab=aa*z;Z.position.left=I.left+(aa*n.width)}g.html(easyFormatTime(t.manipulate_date_without_offset(W.arrival,ab*1000))+" - "+easyFormatTime(t.manipulate_date_without_offset(W.departure,ab*1000))).css({top:b,left:Math.min(d-130,l.width())}).show();if(o!==false){Z.position.top=o-f.top+I.top}if(X<10||l.width()-X<10){if(c===false){c=setInterval(function(){if(c!==false){if(H===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){t.add_new_column(l.scrollLeft()<2);I.left=I.left+(l.scrollLeft()<2?n.width:n.width*-1)}l.scrollLeft(Math.max(1,l.scrollLeft()+(d-l.offset().left<10?n.width*-1:n.width)))}},130)}}else{if(c!==false){clearInterval(c);c=false;t.load_remaining()}}},stop:function(){g.hide();if(c!==false){clearInterval(c);c=false;t.load_remaining()}}}).resizable({handles:"e, w",grid:F?[96,28]:false,maxWidth:n.width*50,scroll:0,minHeight:0,minWidth:4,start:function(X,ad){var Y=parseInt(ad.originalElement.attr("data-id"),10),Z=h(this),ae=ad.originalElement.parent(),ac=h(j).hasClass("ui-resizable-w");if(er_both_params.resources[B[Y].resource].availability_by==="unit"){var ab=ae.data("reservations"),W=[],aa;if(ac&&ab.length>0){ab.reverse()}h.each(ab,function(af,ag){if(aa||ag===Y){aa=true;W.push(ag)}});while(ae.length>0){if(W.length>0){h.each(W,function(af,ag){if(ag!==Y){if(ac){}else{}ae={length:0};return false}})}if(ae.length>0){if(ac){ae=ae.prev()}else{ae=ae.next()}W=ae.data("reservations")}}}ad.helper.attr("style","left: "+ad.helper.css("left")+";top: "+ad.helper.css("top")+";width: "+ad.helper.css("width"))},resize:function(Z,ab){var ac=parseInt(ab.element.attr("data-id"),10),X=B[ac],W=z/n.width*(ab.position.left-ab.originalPosition.left),aa=z/n.width*(ab.size.width+2),Y="";if(ab.position.left-ab.originalPosition.left!==0){Y=easyFormatTime(t.manipulate_date_without_offset(X.arrival,W*1000))}else{if(ab.size.width-ab.originalSize.width!==0){Y=easyFormatTime(t.manipulate_date_without_offset(X.arrival,aa*1000))}else{Y=easyFormatTime(t.manipulate_date_without_offset(X.arrival,W*1000));Y+=" - ";Y+=easyFormatTime(t.manipulate_date_without_offset(X.arrival,aa*1000))}}g.html(Y).css({top:b,left:Math.min(d-130,l.width())}).show()},stop:function(Y,aa){var ab=parseInt(aa.element.attr("data-id"),10),W=z/n.width*(aa.position.left-aa.originalPosition.left),Z=z/n.width*(aa.size.width+2),X={id:ab,arrival:t.manipulate_date_without_offset(B[ab].arrival,W*1000),departure:t.manipulate_date_without_offset(B[ab].arrival,(W*1000)+(Z*1000)),resource:B[ab].resource,space:B[ab].space};if(er_both_params.resources[B[ab].resource].availability_by!=="unit"||t.check_availability(X)){t.recursively_remove_reservation(B[ab]);B[ab].arrival=X.arrival;B[ab].departure=X.departure;B[ab].changed=true;t.draw_reservations()}else{aa.helper.animate({width:aa.originalSize.width,left:aa.originalPosition.left},500,function(){})}g.hide()}}).css("min-width",R+"px").css("max-width",R+"px").css("top","0px").css("position","absolute").attr("data-tip",L.id).attr("data-id",L.id);var N=h('.reservation[data-id="'+J+'"]').remove();if(N.length>0){console.log(N.length);P.addClass("fade-in-fast")}U.append(P);while(V[S]===1){S++}if(S>0){if(U.height()<n.height+(n.height-3)*S){U.height(n.height+(n.height-3)*S)}P.css("top",(n.height-3)*S+"px")}L.depths=S;L.changed=false;console.log("did draw "+J+"at depths "+S);B[J]=L}}return U},add_reservation:function(J){var K=parseInt(J.id,10);J.id=K;J.arrival=new Date(J.arrival);J.departure=new Date(J.departure);J.resource=parseInt(J.resource,10);J.space=parseInt(J.space,10);if(typeof B[K]==="undefined"){J.changed=true}else{J.changed=B[K].changed;J.depths=B[K].depths}B[K]=J},check_availability:function(J){var L=parseInt(J.id,10),K=true;h.each(B,function(M,N){if(N&&N.resource===J.resource&&N.space===J.space&&N.id!==L&&(J.arrival<N.departure&&J.departure>N.arrival)){console.log("checkAvailabilty false because of");console.log(N);K=false;return false}});return K},generate_column:function(N,Q){var K="",T="",L=1,O=0,R=N.getDay()===0?6:N.getDay()-1;if(z==="86400"){K=h('<th><div class="date"><span>'+easyFormatDate(N,"d")+"</span><div>"+er_date_picker_params.day_names_min[R]+"</div></div></th>");if(N.getDate()===1){T="first"}}else{K=h("<th>"+easyFormatDate(N,"H")+"</th>");if(N.getHours()===0){T="first"}}if(T==="first"){K.append(h('<div class="first-of-month"></div>'))}if(N.getDate()===A.getDate()&&N.getMonth()===A.getMonth()&&N.getFullYear()===A.getFullYear()&&(z==="86400"||N.getHours()===A.getHours())){var S=h('<div class="today"></div>'),J=h('<div class="overlay"></div>'),M=0;if(z==="86400"){M=n.width/86400*(A.getHours()*3600+A.getMinutes()*60)}else{M=n.width/3600*(A.getMinutes()*60)}S.css("left",M);J.css("left",M).css("width",M).css("margin-left",-M);K.append(S).append(J);T+=" today"}else{if(N<A){T+=" past"}}if(z==="86400"&&(N.getDay()===0||N.getDay()===6)){T+=" weekend"}K.addClass(T).attr("data-date",N.getTime());T+=" loading";if(Q){k.prepend(K)}else{k.append(K)}h.each(G.resources,function(X,W){var V=h('<td class="resource"><div></div></td>').addClass(T).attr("data-resource",X).attr("data-date",N.getTime());if(Q){a.find("tr:nth-child("+L+")").prepend(V)}else{a.find("tr:nth-child("+L+")").append(V)}for(O=1;O<=(W.availability_by==="unit"?W.quantity:1);O++){var U=h('<td class="cell"></td>').addClass(T).attr("data-resource",X).data("reservations",[]).attr("data-space",O).attr("data-date",N.getTime());L++;if(Q){a.find("tr:nth-child("+L+")").prepend(U)}else{a.find("tr:nth-child("+L+")").append(U)}U.droppable({scope:"reservations",tolerance:"pointer",drop:function(aa,ab){var Y=h(this);if(j.getAttribute("data-space")){Y=h(j)}var ad=parseInt(ab.draggable.attr("data-id"),10),ac=z/n.width*(ab.position.left-I.left),Z={id:ad,arrival:t.manipulate_date_without_offset(B[ad].arrival,ac*1000),departure:t.manipulate_date_without_offset(B[ad].departure,ac*1000),resource:parseInt(Y.attr("data-resource"),10),space:parseInt(Y.attr("data-space"),10)};if(er_both_params.resources[Z.resource].availability_by!=="unit"||t.check_availability(Z)){t.recursively_remove_reservation(B[ad]);B[ad].arrival=Z.arrival;B[ad].departure=Z.departure;B[ad].resource=Z.resource;B[ad].space=Z.space;B[ad].changed=true;ab.helper.remove();t.draw_reservations()}else{}},over:function(Y,Z){}})}L++});if(Q){if(q===0||q.getTime()-(z*1000*10)>N.getTime()){t.load_data(i,q);q=new Date(i.getTime())}}else{if(D.getTime()+(z*1000*10)<N.getTime()){var P=new Date(t.manipulate_date_without_offset(e,z*1000).getTime());t.load_data(D,P);D=P}}}};t.init()})(jQuery,er_timeline_params);