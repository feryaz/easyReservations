(function(G,Q){var I=G(".er-timeline-tooltip"),m=G(".er-timeline"),D=G("#timeline-datepicker"),j=m.find("div.timeline-container"),p=m.find("div.sidebar"),g=m.find("div.timeline"),d=m.find("div.header"),i=m.find("div.resources"),J=i.find("table tbody"),y=d.find(".date"),u=g.find("table"),k=u.find("thead.main tr"),z=u.find("thead:not(.main)"),L=u.find("tbody"),c=[],A=false,l=moment(),w=moment(),q=false,K=false,O=false,E=false,h=false,H=false,s=false,e=0,b=0,F=true,f=false,B=false,x=false,o={height:32,width:96},C=false,r=0,P=0,M=0,t=50,a=Q.default_interval,N=a==="86400"?"days":"hours";d.on("click",".expand-sidebar",function(){p.addClass("expanded").show();G(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){p.removeClass("expanded").hide(300,"linear");G(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".hourly",function(){if(!G(this).hasClass("active")){g.addClass("hourly");d.find(".daily").removeClass("active");G(this).addClass("active");w=moment(A);a="3600";N="hours";v.init()}}).on("click",".daily",function(){if(!G(this).hasClass("active")){g.removeClass("hourly");d.find(".hourly").removeClass("active");G(this).addClass("active");w=moment(A);a="86400";N="days";v.init()}}).on("click",".pending",function(){n.toggle_pending()}).on("click",".date",function(){n.toggle_calendar()}).on("click",".today",function(){v.jump_to_date(l)}).on("click","a.start-add",function(){H=G(this).attr("data-target")}).on("click",".cancel-add",function(){H=false});D.bind("change",function(R){v.jump_to_date(moment(G(this).datepicker("getDate")))});k.on("mousedown","th",function(R){f=g.scrollLeft()+R.pageX});G(window).mouseup(function(V){k.css("cursor","grab");clearInterval(B);B=false;f=false;v.clear_scroll_add_interval();I.css("display","none");if(C){var U=C.attr("data-direction"),T=parseInt(C.css("width"),10)/o.width*a,W=moment(parseInt(C.attr("data-start"),10)*1000),S=U==="left"?moment(W).subtract(T,"seconds"):moment(W).add(T,"seconds"),R={add:H,arrival:easyFormatDate(W<S?W:S,"full"),departure:easyFormatDate(S>W?S:W,"full"),resource:parseInt(C.attr("data-resource"),10),space:parseInt(C.attr("data-space"),10)};if(a==="86400"){W.startOf("day");S.startOf("day")}else{W.startOf("hour");S.startOf("hour")}if(S>W){S.add(1,N)}else{W.subtract(1,N)}v.load_data(W<S?W:S,S>W?S:W,R);C.remove();C=false;H=false}});m.on("click",".resource-handler",function(){var S=G(this).parent().parent().parent().next(),R=S.index()/2-1;if(G(this).hasClass("retracted")){G(this).removeClass("retracted");S.removeClass("retracted");G(L[R]).removeClass("retracted").show();S.show()}else{G(this).addClass("retracted");S.addClass("retracted");G(L[R]).addClass("retracted").hide();S.hide()}}).on("mousedown",".next",function(){if(B===false){v.add_new_column(false);v.set_current_date();B=setInterval(function(){v.add_new_column(false);v.set_current_date()},100)}}).on("mousedown",".prev",function(){if(B===false){v.add_new_column(true);v.set_current_date();B=setInterval(function(){v.add_new_column(true);v.set_current_date()},100)}});g.mousemove(function(U){e=U.pageX;b=U.pageY;if(f&&U.which===1){g.scrollLeft(Math.min(f-U.pageX<1?1:f-U.pageX,u.width()-g.width()-o.width));v.set_current_date();if(x===false){k.css("cursor","grabbing");v.start_scroll_add_interval()}}if(C){var T=-K.left+e-parseInt(C.attr("data-pageX"),10),V=moment(parseInt(C.attr("data-start"),10)*1000),W=(T)/o.width*a,S="",R="";console.log(V);if(-K.left+T>0){C.attr("data-direction","right").css("margin-left",K.left).css("width",T+(-K.left));S=easyFormatTime(V);R=easyFormatTime(V.add(W,"seconds"))}else{C.attr("data-direction","left").css("margin-left",T).css("width",(-T)+K.left);R=easyFormatTime(V);S=easyFormatTime(V.add(W,"seconds"))}I.html(S+" - "+R).css({top:b,left:Math.min(e-130,g.width()),display:"block"});v.scroll_dragging()}else{if(H&&U.target.getAttribute("data-space")){I.html(easyFormatTime(moment(w).add(a/o.width*(Math.floor(U.target.offsetLeft+U.offsetX)+1),"seconds"))).css({top:b,left:Math.min(e-130,g.width()),display:"block"})}}if(r!==U.target){r=U.target;if(r.getAttribute("data-resource")){v.highlight_current(moment(parseInt(U.target.getAttribute("data-date"),10)*1000),parseInt(U.target.getAttribute("data-resource"),10),parseInt(U.target.getAttribute("data-space"),10))}else{k.find("th.hover").removeClass("hover")}if(r.getAttribute("data-space")){E=G(r).offset().top}else{if(r.getAttribute("data-id")){E=G(r).parent().offset().top}}}}).mouseleave(function(){k.css("cursor","grab");k.find("th.hover").removeClass("hover");J.find("td.hover").removeClass("hover");clearInterval(B);B=false;f=false;r=false;I.css("display","none");v.clear_scroll_add_interval();if(C){C.remove();C=false}}).on("mousedown",".cell",function(T){if(H){var S=moment(parseInt(G(this).attr("data-date"),10)*1000).add(a/(o.width)*Math.floor(T.offsetX+1),"seconds"),R=this;C=G('<div class="placeholder">');K={top:0,left:0};if(H==="resource"){R=this.parentNode.parentNode}else{if(H==="global"){R=this.parentNode.parentNode.parentNode}}C.css("top",R.offsetTop).css("left",this.offsetLeft+T.offsetX+1).css("height",G(R).height()).attr("data-pageX",T.pageX).attr("data-resource",G(this).attr("data-resource")).attr("data-space",G(this).attr("data-space")).attr("data-start",S.unix());g.append(C)}}).on("click",".reservation",function(){var R=parseInt(G(this).attr("data-id"),10);g.find(".reservation.selected").removeClass("selected");G(this).addClass("selected");n.draw_reservation(c[R])}).on("keydown",".reservation .title",function(R){if(R.keyCode===13){var S=G(this).parents(".reservation").attr("data-id");c[S].title=G(this).html();G(this).blur();n.draw_reservation(c[S]);return false}});p.on("click",".allow-edit",function(){var R=parseInt(G(this).attr("data-reservation-id"),10);if(h){v.update_reservation(R);n.stop_edit(h.id)}h=JSON.parse(JSON.stringify(c[R]));H=false;p.find("> .reservation-details .edit-actions").show();v.reservation_allow_edit(g.find('.reservation[data-id="'+R+'"]'));G(this).html(Q.i18n_stop_edit).addClass("stop-edit").removeClass("allow-edit")}).on("click",".stop-edit",function(){var R=parseInt(G(this).attr("data-reservation-id"),10);v.update_reservation(R);n.stop_edit(R)}).on("click",".status",function(){if(!G(this).hasClass("reservation-status")){var S=parseInt(G(this).parent().parent().attr("data-reservation-id"),10),R=G(this).attr("data-status");c[S].status=R;g.find('.reservation[data-id="'+S+'"]').removeClass("approved checked completed").addClass(R);n.draw_reservation(c[S]);v.update_reservation(S)}}).on("click",".snapping",function(){if(G(this).hasClass("enabled")){F=false;G(this).removeClass("enabled")}else{F=true;G(this).addClass("enabled")}}).on("click",".revert",function(){var R=parseInt(G(this).attr("data-reservation-id"),10);v.recursively_remove_reservation(c[R]);g.find('.reservation[data-id="'+R+'"]').remove();h.changed=true;v.add_reservation(h);v.draw_reservations();n.stop_edit(R)});var n={init:function(){},is_open:function(){return p.hasClass("expanded")},open:function(){if(!n.is_open()){d.find(".expand-sidebar").click()}},close:function(){if(n.is_open()){d.find(".contract-sidebar").click()}},toggle:function(){if(n.is_open()){d.find(".contract-sidebar").click();return false}else{d.find(".expand-sidebar").click();return true}},toggle_calendar:function(){if(!p.find("> .calendar").hasClass("visible")){n.display_calendar();n.open()}else{n.toggle()}},toggle_pending:function(){if(!p.find("> .pending").hasClass("visible")){n.display_pending();n.open()}else{n.toggle()}},clear:function(){p.find("> .visible").hide().removeClass("visible")},display_calendar:function(){var R=p.find("> .calendar");n.clear();R.show().addClass("visible")},display_pending:function(){var R=p.find("> .pending");n.clear();R.show().addClass("visible")},stop_edit:function(R){p.find("> .reservation-details .edit-actions").hide();p.find("> .reservation-details .stop-edit").html(Q.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");if(h){v.reservation_stop_edit(G('.reservation[data-id="'+R+'"]'));h=false}},draw_today:function(){var U=p.find("> .calendar .arrivals"),V=p.find("> .calendar .departures"),S,T,W,R=er_both_params.time_format.charAt(er_both_params.time_format.length-1);U.html("");V.html("");G.each(c,function(X,Z){if(Z){T=false;W=false;if(Z.arrival.date()===A.date()&&Z.arrival.month()===A.month()&&Z.arrival.year()===A.year()){T="arrival";S=Z.arrival;W=Z.departure.date()===S.date()&&Z.departure.month()===S.month()&&Z.departure.year()===S.year()}else{if(Z.departure.date()===A.date()&&Z.departure.month()===A.month()&&Z.departure.year()===A.year()){T="departure";S=Z.departure}}if(T){var Y=G('<div class="today-reservation">');Y.attr("data-id",Z.id).append('<span class="date"><span class="hour">'+easyAddZero(S.hour())+'</span><span class="minute">'+easyAddZero(S.minute())+'</span><span class="ampm">'+(R==="a"?(S.hour()>=12?"pm":"am"):(R==="A"?(S.hour()>=12?"PM":"AM"):""))+"</span></span>").append('<div><div class="title"><span class="id reservation-status background status-'+Z.status+'">'+Z.id+"</span>"+Z.title+'</div><div class="resource">'+(Z.resource>0?Q.resources[Z.resource].post_title:Q.i18n_no_resource)+'</div><div class="date"><span class="'+T+'"></span>'+(W?easyFormatTime(Z.departure):easyFormatDate(T==="arrival"?Z.departure:Z.arrival,"full"))+"</div></div>").bind("click",function(){var aa=parseInt(G(this).attr("data-id"),10);g.find('.reservation[data-id="'+aa+'"]').trigger("click")});if(T==="arrival"){U.append(Y)}else{V.append(Y)}}}});if(U.is(":empty")){U.html('<div class="today-reservation">'+Q.i18n_no_arrivals+"</div>")}if(V.is(":empty")){V.html('<div class="today-reservation">'+Q.i18n_no_departures+"</div>")}},draw_pending:function(){if(Q.pending&&Q.pending.length>0){d.find(".pending").html("<span>"+Q.pending.length+"</span>");var R=p.find("> .pending").find(".reservations");R.html("");G.each(Q.pending,function(S,U){var T=G('<div class="pending-reservation">'),W=parseInt(U.resource,10),V=false;U.id=parseInt(U.id,10);U.arrival=moment(U.arrival);U.departure=moment(U.departure);if(!U.title){U.title="No title"}T.html('<span class="id">'+U.id+'</span><div><div class="title">'+U.title+'</div><div class="resource">'+(U.resource>0?Q.resources[U.resource].post_title:Q.i18n_no_resource)+'</div><div class="date">'+easyFormatDate(U.arrival,"full")+'</div><div class="date">'+easyFormatDate(U.departure,"full")+"</div></div>");T.bind("click",function(){v.jump_to_date(U.arrival);if(W>0){i.find('.resource-handler:not([data-resource="'+U.resource+'"],.retracted),.resource-handler.retracted[data-resource="'+U.resource+'"]').click()}G.each(Q.resources,function(X,Z){if(!V&&(W===0||W===Z.ID)){if(Z.availability_by==="unit"){U.resource=Z.ID;U.space=1;V=true;return false}else{U.resource=Z.ID;for(var Y=1;Y<=Z.quantity;Y++){U.space=1;if(v.check_availability(U)){V=true;break}}}}});if(V){if(h){v.update_reservation(h.id);n.stop_edit(h.id)}h=JSON.parse(JSON.stringify(U));U.status="approved";v.add_reservation(U);v.draw_reservations();n.draw_reservation(U);Q.pending.splice(S,1);G(this).remove();n.draw_pending()}});R.append(T)})}else{d.find(".pending").html("");p.find("> .pending").find(".reservations").html(Q.i18n_no_pending)}},draw_reservation:function(T){var S=p.find("> .reservation-details"),R=S.find("h2"),U=Q.resources[T.resource];R.find(".title").html(T.title);R.find(".reservation-status").attr("class","reservation-status status-"+T.status).html(T.id);S.attr("data-reservation-id",T.id);S.find(".reservation-preview").attr("data-reservation-id",T.id).data("reservation-data",false);S.find(".snapping").removeClass("enabled");S.find(".revert").attr("data-reservation-id",T.id);S.find(".input-box.reservation-status").removeClass("reservation-status");S.find(".input-box.status-"+T.status).addClass("reservation-status");S.find(".reservation-arrival").html(easyFormatDate(T.arrival,"full"));S.find(".reservation-departure").html(easyFormatDate(T.departure,"full"));S.find(".reservation-resource").html(U.post_title);S.find(".reservation-adults").html(T.adults);S.find(".reservation-children").html(T.children);if(h&&h.id===T.id){S.find(".edit-actions").show();S.find(".allow-edit").html(Q.i18n_stop_edit).removeClass("allow-edit").addClass("stop-edit");S.find(".stop-edit").attr("data-reservation-id",T.id)}else{S.find(".stop-edit").html(Q.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");S.find(".allow-edit").attr("data-reservation-id",T.id);S.find(".edit-actions").hide()}if(U.availability_by!=="unit"){S.find(".reservation-space").hide()}else{S.find(".reservation-space").show().html(typeof U.spaces[T.space]==="undefined"?T.space:U.spaces[T.space])}if(T.order_id==="0"){S.find(".reservation-order").html(Q.i18n_no_order)}else{S.find(".reservation-order").html(Q.i18n_order.replace("%s",'<a href="'+Q.order_url.replace("%s",T.order_id)+'" target="_blank">#'+T.order_id+"</a>"))}if(F){S.find(".snapping").addClass("enabled")}n.clear();S.show().addClass("visible");n.open()}};var v={init:function(){l=moment();c=[];A=false;if(a==="86400"){o.width=96;l.startOf("day");w.startOf("day")}else{o.width=48;l.startOf("hour");if(l.date()===w.date()&&l.month()===w.month()&&l.year()===w.year()){w.hours(l.hour()).minutes(0).seconds(0).milliseconds(0)}else{w.startOf("day")}}u.find("td,th").remove();w.subtract(15,N);q=moment(w);M=moment(w);P=moment(w);for(var R=0;R<t;R++){v.generate_column(q,false);if(R<t-1){q.add(1,N)}}v.load_remaining();g.scrollLeft(k.find("th:nth-child(15)").offset().left-g.offset().left+g.scrollLeft()+1);v.set_current_date();v.sync_cell_heights()},highlight_current:function(R,T,S){k.find("th.hover").removeClass("hover");k.find('th[data-date="'+R.unix()+'"]').addClass("hover");J.find("td.hover, th.hover").removeClass("hover");if(S){J.find('td[data-resource="'+T+'"][data-space="'+S+'"]').addClass("hover")}else{J.find('th[data-resource="'+T+'"]').addClass("hover")}},set_current_date:function(){var R=moment(w).add(Math.round(g.scrollLeft()/o.width)+1,N);if(a==="3600"){R.startOf("hour")}else{R.startOf("day")}if(!A||R.date()!==A.date()||R.month()!==A.month()||R.year()!==A.year()){A=R;if(a==="3600"){y.html(A.date()+" "+er_date_picker_params.month_names[A.month()]+" "+A.year())}else{y.html(er_date_picker_params.month_names[A.month()]+" "+A.year())}k.find("th.current").removeClass("current");k.find('th[data-date="'+A.unix()+'"]').addClass("current");D.datepicker("setDate",new Date(A.format("YYYY-MM-DDTHH:mm:ssZ")));n.draw_today()}else{if(a==="3600"&&R.hour()!==A.hour()){A=R;k.find("th.current").removeClass("current");k.find('th[data-date="'+A.unix()+'"]').addClass("current")}}},scroll_dragging:function(){var R=e-g.offset().left;if((R>0&&R<15)||g.width()-R<15){if(B===false){B=setInterval(function(){if(B!==false){var S=e-g.offset().left;if(x===false&&((S>0&&S<15)||g.width()-S<15)){v.add_new_column(S<15);K.left=K.left+(S<15?o.width:o.width*-1)}g.scrollLeft(Math.max(1,g.scrollLeft()+(S<15?o.width*-1:o.width)))}},130)}}else{if(B!==false){clearInterval(B);B=false;v.load_remaining()}}},start_scroll_add_interval:function(){if(x===false&&(g.scrollLeft()<2||u.width()-(g.width()+g.scrollLeft())<5+o.width)){x=setInterval(function(){if(x!==false&&(g.scrollLeft()<2||u.width()-(g.width()+g.scrollLeft())<5+o.width)){v.add_new_column(g.scrollLeft()<2);v.set_current_date()}},45)}},clear_scroll_add_interval:function(){if(x!==false){clearInterval(x);x=false;v.load_remaining()}},jump_to_date:function(R){if(R<w||R>q){w=R;v.init()}else{var T=A.diff(R)/(a*1000);for(var S=1;S<=Math.abs(T);S++){v.add_new_column(T>0)}v.set_current_date()}},add_new_column:function(R){if(R){w.subtract(1,N);v.generate_column(w,true);u.find("th:last-child,td:last-child").remove();M.subtract(1,N);q.subtract(1,N)}else{q.add(1,N);v.generate_column(q,false);u.find("th:first-child").remove();u.find("td:first-child").each(function(){var S=G(this).data("reservations");if(S&&S.length>0){G.each(S,function(T,U){if(c[U]&&typeof c[U]!=="undefined"){c[U].changed=true}})}}).remove();P.add(1,N);w.add(1,N);v.draw_reservations()}v.sync_cell_heights()},load_remaining:function(){if(P===0||P>w){v.load_data(w,P);P=moment(w)}else{if(M<q){var R=moment(q).add(1,N);v.load_data(M,R);M=R}else{}}},load_data:function(T,R,S){G.ajax({url:Q.ajax_url,data:G.extend({action:"easyreservations_timeline_data",security:Q.nonce,start:T.date()+"."+(T.month()+1)+"."+T.year(),start_hour:T.hour(),end:R.date()+"."+(R.month()+1)+"."+R.year(),end_hour:R.hour(),interval:a},S),type:"POST",success:function(U){if(U.data){G.each(U.data,function(X,W){var V=Q.resources[X].quantity;G.each(W,function(ac,Y){var aa=moment(ac),Z="",ab;if(Y<0){Z="unavailable";ab=0}else{ab=V-Y}L.find('td[data-date="'+(aa.unix())+'"][data-resource="'+X+'"]').removeClass("loading").addClass(Z);z.find('th[data-date="'+(aa.unix())+'"][data-resource="'+X+'"]').html("<div><span>"+ab+"</span></div>").addClass(parseInt(Y,10)===V?"unavailable":"")})})}if(U.reservations){G.each(U.reservations,function(V,W){v.add_reservation(W,true)});v.draw_reservations()}if(U.message){alert(U.message)}}})},update_reservation:function(S){var R=c[S];G.ajax({url:Q.ajax_url,data:{action:"easyreservations_timeline_update_reservation",security:Q.nonce,id:S,arrival:easyFormatDate(R.arrival,"full"),departure:easyFormatDate(R.departure,"full"),status:R.status,resource:R.resource,space:R.space,title:R.title},type:"POST",success:function(T){if(T.reservation){console.log(T.reservation)}if(T.message){alert(T.message)}}})},draw_reservations:function(){var R=[],S=true;G.each(c,function(T,U){if(U&&U.changed&&U.status!=="pending"){R.push(U.id)}});R.sort(function(U,T){return c[U].arrival<c[T].arrival?-1:1});G.each(R,function(T,U){if(U){if(!v.draw_reservation(c[U])){v.draw_reservations();S=false;return false}}});if(S&&R.length>0){v.sync_cell_heights()}},recursively_remove_reservation:function(U){var V=parseInt(U.id,10),T=moment(U.arrival),S=moment(U.departure);if(a==="86400"){T.startOf("day");S.startOf("day")}else{T.startOf("hour");S.startOf("hour")}while(T<=S){var R=G('td[data-date="'+(T.unix())+'"][data-resource="'+U.resource+'"][data-space="'+U.space+'"]');if(R.length>0){v.recursively_remove_reservations(R,U.depths,V)}T.add(1,N)}},recursively_remove_reservations:function(S,W,X){var R=S.data("reservations"),V=[],T=false,U=0;if(R&&R.length>0){G.each(R,function(Y,Z){if(Z){if(Z===X||c[Z].depths>=W){if(T===false){T=c[Z].depths}T=Math.min(T,c[Z].depths);s=true;c[Z].changed=true}else{V.push(Z);U=Math.max(U,c[Z].depths)}}})}S.data("reservations",V);if(T!==false){v.recursively_remove_reservations(S.next(),T,X)}},reservation_stop_edit:function(R){R.draggable("destroy").resizable("destroy");R.find(".title").attr("contenteditable","false")},reservation_allow_edit:function(R){R.draggable({snap:F?false:".reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",stack:".reservation",scope:"reservations",cancel:".title",revert:function(S,T){if(S){return S}G(this).data("uiDraggable").originalPosition={top:K.top-1,left:K.left};return !S},start:function(S,T){K=T.originalPosition;O=T.offset},drag:function(U,V){var X=parseInt(V.helper.attr("data-id"),10),S=c[X],W=a/o.width*(V.position.left-K.left);if(F){var T=Math.round((V.position.left-K.left)/o.width);W=T*a;V.position.left=K.left+(T*o.width)}I.html(easyFormatTime(moment(S.arrival).add(W,"seconds"))+" - "+easyFormatTime(moment(S.departure).add(W,"seconds"))).css({top:b,left:Math.min(e-130,g.width()),display:"block"});if(E!==false){V.position.top=E-O.top+K.top}v.scroll_dragging()},stop:function(){I.css("display","none");if(B!==false){clearInterval(B);B=false;v.load_remaining()}}}).resizable({handles:"e, w",grid:F?[o.width,26]:false,minHeight:0,minWidth:4,start:function(S,T){T.originalElement.attr("style","left: "+T.originalElement.css("left")+";top: "+T.originalElement.css("top")+" !important;width: "+T.originalElement.css("width"))},resize:function(V,X){var Y=parseInt(X.element.attr("data-id"),10),T=c[Y],S=a/o.width*(X.position.left-X.originalPosition.left),W=a/o.width*(X.size.width),U;if(X.position.left-X.originalPosition.left!==0){U=easyFormatTime(moment(T.arrival).add(S,"seconds"))}else{if(X.size.width-X.originalSize.width!==0){U=easyFormatTime(moment(T.arrival).add(W,"seconds"))}else{U=easyFormatTime(moment(T.arrival).add(S,"seconds"));U+=" - ";U+=easyFormatTime(moment(T.arrival).add(W,"seconds"))}}I.html(U).css({top:b,left:Math.min(e-130,g.width()),display:"block"})},stop:function(U,W){var X=parseInt(W.element.attr("data-id"),10),S=a/o.width*(W.position.left-W.originalPosition.left),V=a/o.width*(W.size.width),T={id:X,arrival:moment(c[X].arrival).add(S,"seconds"),departure:moment(c[X].arrival).add(S+V,"seconds"),resource:c[X].resource,space:c[X].space};if(Q.resources[c[X].resource].availability_by!=="unit"||v.check_availability(T)){v.recursively_remove_reservation(c[X]);c[X].arrival=T.arrival;c[X].departure=T.departure;c[X].changed=true;v.draw_reservations()}else{W.helper.animate({width:W.originalSize.width,left:W.originalPosition.left},500,function(){})}I.css("display","none")}});R.find(".title").attr("contenteditable","true")},draw_reservation:function(T){var R=parseInt(T.id,10),U=moment(T.arrival),W=moment(T.departure),X=G('<div class="reservation">'),S=W.diff(U),Z=(((S/1000)/a)*o.width),ac=false,ad=[],aa=0;s=false;if(a==="86400"){U.startOf("day");W.startOf("day")}else{U.startOf("hour");W.startOf("hour")}while(U<=W){var ab=G('td[data-date="'+(U.unix())+'"][data-resource="'+T.resource+'"][data-space="'+T.space+'"]');if(ab&&ab.length>0){var Y=ab.data("reservations");if(Y.length>0){G.each(Y,function(ae,af){if(af&&af!==R){if(c[af].arrival>T.arrival&&c[af].arrival<T.departure&&c[af].departure>T.arrival){v.recursively_remove_reservations(ab,aa,af)}else{if(c[af].departure<=T.arrival||c[af].arrival>=T.departure){}else{ad[c[af].depths]=1}}}})}if(ac===false){X.css("left",((T.arrival.diff(U)/1000/a*o.width)-1)+"px");ac=ab}if(G.inArray(R,Y)<0){Y.push(R);ab.data("reservations",Y)}}U.add(1,N)}if(ac===false){c[R].changed=false;return true}else{if(s){return false}else{X.html('<span class="wrapper"><span class="sticky"><span class="id">'+R+'</span><div class="title">'+T.title+"</div></span></span>").css("min-width",Z+"px").css("max-width",Z+"px").css("top","0px").css("position","absolute").addClass(T.status).attr("data-tip",T.id).attr("data-id",T.id);var V=G('.reservation[data-id="'+R+'"]').remove();if(V.length>0){X.addClass("fade-in-fast")}if(h&&h.id===R){n.draw_reservation(T);v.reservation_allow_edit(X);g.find(".reservation.selected").removeClass("selected");X.addClass("selected")}ac.append(X);while(ad[aa]===1){aa++}if(aa>0){if(ac.height()<o.height+(o.height-3)*aa){ac.height(o.height+(o.height-3)*aa)}X.css("top",(o.height-3)*aa+"px")}T.depths=aa;T.changed=false;c[R]=T}}return ac},add_reservation:function(R,S){var T=parseInt(R.id,10);R.id=T;R.arrival=moment(R.arrival);R.departure=moment(R.departure);R.resource=parseInt(R.resource,10);R.space=parseInt(R.space,10);if(typeof c[T]==="undefined"){R.changed=true}else{R.changed=S?true:c[T].changed;R.depths=c[T].depths}c[T]=R},check_availability:function(R){var T=parseInt(R.id,10),S=true;G.each(c,function(U,V){if(V&&V.resource===R.resource&&V.space===R.space&&V.id!==T&&(R.arrival<V.departure&&R.departure>V.arrival)){S=false;return false}});return S},sync_cell_heights:function(){var R,S;J.each(function(T,U){R=G(U).index()/2-1;G(U).children().each(function(V,W){S=G(W).index();G(W).height(G(L[R]).children().eq(G(W).index()).height())})})},generate_column:function(V,Z){var T,ad="",R=0,W=0,aa=V.day()===0?6:V.day()-1;if(a==="86400"){T=G('<th><div class="date"><span>'+easyFormatDate(V,"d")+"</span><div>"+er_date_picker_params.day_names_min[aa]+"</div></div></th>");if(V.date()===1){T.append(G('<div class="first-of-month"></div>'))}}else{var ae=er_both_params.time_format.charAt(er_both_params.time_format.length-1),ab=easyAddZero(V.minutes());if(ae==="a"){ab=V.hours()>=12?"pm":"am"}else{if(ae==="A"){ab=V.hours()>=12?"PM":"AM"}}T=G('<th><div class="date"><span>'+easyFormatDate(V,"H")+"</span><div>"+ab+"</div></div></th>");if(V.hours()===0){T.append(G('<div class="first-of-month"></div>'))}}if(V.date()===l.date()&&V.month()===l.month()&&V.year()===l.year()&&(a==="86400"||V.hour()===l.hour())){var ac=G('<div class="today"></div>'),S=G('<div class="overlay"></div>'),Y=moment(),U;if(a==="86400"){U=o.width/86400*(Y.hour()*3600+Y.minute()*60)-1}else{U=o.width/3600*(Y.minute()*60)-1}ac.css("left",U);S.css("left",U).css("width",U).css("margin-left",-U);T.append(ac).append(S);ad+=" today"}else{if(V<l){ad+=" past"}}if(a==="86400"&&(V.day()===0||V.day()===6)){ad+=" weekend"}T.addClass(ad).attr("data-date",V.unix());ad+=" loading";if(Z){k.prepend(T)}else{k.append(T)}G.each(Q.resources,function(ai,ah){var ag=G("<th><div></div></th>").addClass(ad).attr("data-resource",ai).attr("data-date",V.unix());if(Z){G(z[R]).find("tr").prepend(ag)}else{G(z[R]).find("tr").append(ag)}for(W=1;W<=(ah.availability_by==="unit"?ah.quantity:1);W++){var af=G('<td class="cell"></td>').addClass(ad).attr("data-resource",ai).data("reservations",[]).attr("data-space",W).attr("data-date",V.unix());if(Z){G(L[R]).find("tr:nth-child("+W+")").prepend(af)}else{G(L[R]).find("tr:nth-child("+W+")").append(af)}af.droppable({scope:"reservations",tolerance:"pointer",drop:function(al,am){var aj=G(this);if(r.getAttribute("data-space")){aj=G(r)}var ao=parseInt(am.draggable.attr("data-id"),10),an=a/o.width*(am.position.left-K.left),ak={id:ao,arrival:moment(c[ao].arrival).add(an,"seconds"),departure:moment(c[ao].departure).add(an,"seconds"),resource:parseInt(aj.attr("data-resource"),10),space:parseInt(aj.attr("data-space"),10)};if(Q.resources[ak.resource].availability_by!=="unit"||v.check_availability(ak)){v.recursively_remove_reservation(c[ao]);c[ao].arrival=ak.arrival;c[ao].departure=ak.departure;c[ao].resource=ak.resource;c[ao].space=ak.space;c[ao].changed=true;if(c[ao].status==="pending"){c[ao].status="approved"}am.helper.remove();v.draw_reservations()}else{}},over:function(aj,ak){}})}R++});if(Z){if(P===0||P.valueOf()-(a*1000*10)>V.valueOf()){v.load_data(w,P,{});P=moment(w)}}else{if(M.valueOf()+(a*1000*10)<V.valueOf()){var X=moment(q).add(a,"seconds");v.load_data(M,X,{});M=X}}}};m.insertAfter("hr.wp-header-end");I.insertAfter("hr.wp-header-end");p.hide();if(a==="86400"){l.startOf("day");d.find(".daily").addClass("active")}else{l.startOf("hour");d.find(".hourly").addClass("active");g.addClass("hourly");o.width=48}n.draw_pending();n.display_calendar();m.css("display","flex");v.init()})(jQuery,er_timeline_params);