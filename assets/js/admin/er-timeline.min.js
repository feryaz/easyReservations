(function(g,y){const f=g(".er-timeline-tooltip"),n=g(".er-timeline"),l=g("#timeline-datepicker"),p=n.find("div.sidebar"),j=n.find("div.timeline"),t=n.find("div.header"),u=n.find("div.resources"),k=u.find(".vertical-scroll"),d=u.find("table tbody"),m=t.find(".date"),q=j.find("div.vertical-scroll"),s=q.find("div.horizontal-scroll"),x=j.find("div.vertical-scroll table"),w=j.find("div.horizontal-scroll"),c=j.find("thead.main tr"),v=x.find("thead:not(.main)"),b=x.find("tbody"),e=60,r={height:32,width:96},h=Object.keys(y.resources);let reservations=[],selected=false,today=moment(),start=moment(),end=false,dragStartPosition=false,dragStartOffset=false,dragSnapTop=false,editMode=false,addMode=false,changedAnyReservation=false,mousePosX=0,mousePosY=0,scrollDrag=false,scrollAction=false,scrollAdd=false,placeholder=false,lastHover=0,lastQueryStart=0,lastQueryEnd=0,snappingEnabled=y.default_snapping==="1",interval="86400",intervalString="days";h.sort(function(A,z){return y.resources[A].menu_order-y.resources[z].menu_order});t.on("click",".expand-sidebar",function(){p.addClass("expanded").show();g(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){p.removeClass("expanded").hide(300,"linear");g(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".hourly",function(){if(!g(this).hasClass("active")){j.addClass("hourly");t.find(".daily").removeClass("active");g(this).addClass("active");start=moment(selected);interval="3600";intervalString="hours";o.init()}}).on("click",".daily",function(){if(!g(this).hasClass("active")){j.removeClass("hourly");t.find(".hourly").removeClass("active");g(this).addClass("active");start=moment(selected);interval="86400";intervalString="days";o.init()}}).on("click",".pending",function(){a.toggle_pending()}).on("click",".date",function(){a.toggle_calendar()}).on("click",".today",function(){o.jump_to_date(today)}).on("click","a.start-add",function(){addMode=g(this).attr("data-target")}).on("click",".cancel-add",function(){addMode=false});l.bind("change",function(z){o.jump_to_date(moment(g(this).datepicker("getDate")))});c.on("mousedown","th",function(z){scrollDrag=w.scrollLeft()+z.pageX});q.on("scroll",function(){k.css("margin-top",-g(this).scrollTop())});g(window).mouseup(function(E){c.css("cursor","grab");clearInterval(scrollAction);scrollAction=false;scrollDrag=false;o.clear_scroll_add_interval();f.css("display","none");if(placeholder){const F=prompt(y.i18n_enter_title,"");if(F!==null){const D=placeholder.attr("data-direction"),B=parseInt(placeholder.css("width"),10)/r.width*interval,C=moment(parseInt(placeholder.attr("data-start"),10)*1000),A=D==="left"?moment(C).subtract(B,"seconds"):moment(C).add(B,"seconds"),z={add:addMode,arrival:easyFormatDate(C<A?C:A,"full"),departure:easyFormatDate(A>C?A:C,"full"),resource:parseInt(placeholder.attr("data-resource"),10),space:parseInt(placeholder.attr("data-space"),10),title:F};if(interval==="86400"){C.startOf("day");A.startOf("day")}else{C.startOf("hour");A.startOf("hour")}if(A>C){A.add(1,intervalString)}else{C.subtract(1,intervalString)}o.load_data(C<A?C:A,A>C?A:C,z)}placeholder.remove();placeholder=false;addMode=false}});n.on("click",".resource-handler",function(){const A=g(this).parent().parent().parent().parent().next(),z=(A.index()/2)-0.5;if(g(this).hasClass("retracted")){g(this).removeClass("retracted");A.removeClass("retracted");g(b[z]).removeClass("retracted").show();A.show()}else{g(this).addClass("retracted");A.addClass("retracted");g(b[z]).addClass("retracted").hide();A.hide()}}).on("mousedown",".next",function(){if(scrollAction===false){o.add_new_column(false);o.set_current_date();scrollAction=setInterval(function(){o.add_new_column(false);o.set_current_date()},100)}}).on("mousedown",".prev",function(){if(scrollAction===false){o.add_new_column(true);o.set_current_date();scrollAction=setInterval(function(){o.add_new_column(true);o.set_current_date()},100)}});j.mousemove(function(B){mousePosX=B.pageX;mousePosY=B.pageY;if(scrollDrag&&B.which===1){w.scrollLeft(Math.min(scrollDrag-B.pageX<1?1:scrollDrag-B.pageX,c.width()-j.width()-r.width));o.set_current_date();if(scrollAdd===false){c.css("cursor","grabbing");o.start_scroll_add_interval()}}if(placeholder){const z=-dragStartPosition.left+mousePosX-parseInt(placeholder.attr("data-pageX"),10),A=moment(parseInt(placeholder.attr("data-start"),10)*1000),C=(z)/r.width*interval;let tooltipFirst="",tooltipSecond="";if(-dragStartPosition.left+z>0){placeholder.attr("data-direction","right").css("margin-left",dragStartPosition.left).css("width",z+(-dragStartPosition.left));tooltipFirst=easyFormatTime(A);tooltipSecond=easyFormatTime(A.add(C,"seconds"))}else{placeholder.attr("data-direction","left").css("margin-left",z).css("width",(-z)+dragStartPosition.left);tooltipSecond=easyFormatTime(A);tooltipFirst=easyFormatTime(A.add(C,"seconds"))}f.html(tooltipFirst+" - "+tooltipSecond).css({top:mousePosY,left:Math.min(mousePosX-130,j.width()),display:"block"});o.scroll_dragging()}else{if(addMode&&B.target.getAttribute("data-space")){f.html(easyFormatTime(moment(start).add(interval/r.width*(Math.floor(B.target.offsetLeft+B.offsetX)+1),"seconds"))).css({top:mousePosY,left:Math.min(mousePosX-130,j.width()),display:"block"})}}if(lastHover!==B.target){lastHover=B.target;if(lastHover.getAttribute("data-resource")){o.highlight_current(moment(parseInt(B.target.getAttribute("data-date"),10)*1000),parseInt(B.target.getAttribute("data-resource"),10),parseInt(B.target.getAttribute("data-space"),10))}else{c.find("th.hover").removeClass("hover")}if(lastHover.getAttribute("data-space")){dragSnapTop=g(lastHover).offset().top}else{if(lastHover.getAttribute("data-id")){dragSnapTop=g(lastHover).parent().offset().top}}}}).mouseleave(function(){c.css("cursor","grab");c.find("th.hover").removeClass("hover");d.find("td.hover").removeClass("hover");clearInterval(scrollAction);scrollAction=false;scrollDrag=false;lastHover=false;f.css("display","none");o.clear_scroll_add_interval();if(placeholder){placeholder.remove();placeholder=false}}).on("mousedown",".cell",function(A){if(addMode){const z=moment(parseInt(g(this).attr("data-date"),10)*1000).add(interval/(r.width)*Math.floor(A.offsetX+1),"seconds");let attach=this;placeholder=g('<div class="placeholder">');dragStartPosition={top:0,left:0};if(addMode==="resource"){attach=this.parentNode.parentNode}else{if(addMode==="global"){attach=this.parentNode.parentNode.parentNode}}placeholder.css("top",attach.offsetTop).css("left",this.offsetLeft+A.offsetX+1).css("height",g(attach).height()).attr("data-pageX",A.pageX).attr("data-resource",g(this).attr("data-resource")).attr("data-space",g(this).attr("data-space")).attr("data-start",z.unix());s.append(placeholder)}}).on("click",".reservation",function(){const z=parseInt(g(this).attr("data-id"),10);j.find(".reservation.selected").removeClass("selected");g(this).addClass("selected");a.draw_reservation(reservations[z])}).on("keydown",".reservation .title",function(z){if(z.keyCode===13){const A=g(this).parents(".reservation").attr("data-id");reservations[A].title=g(this).html();g(this).blur();a.draw_reservation(reservations[A]);return false}});p.on("click",".allow-edit",function(){const z=parseInt(g(this).attr("data-reservation-id"),10);if(editMode){o.update_reservation(z);a.stop_edit(editMode.id)}o.set_element_as_droppable(x.find("td.cell"));editMode=JSON.parse(JSON.stringify(reservations[z]));addMode=false;p.find("> .reservation-details .edit-actions").show();o.reservation_allow_edit(x.find('.reservation[data-id="'+z+'"]'));g(this).html(y.i18n_stop_edit).addClass("stop-edit").removeClass("allow-edit")}).on("click",".stop-edit",function(){const z=parseInt(g(this).attr("data-reservation-id"),10);o.update_reservation(z);a.stop_edit(z)}).on("click",".status",function(){if(!g(this).hasClass("reservation-status")){const A=parseInt(g(this).parent().parent().attr("data-reservation-id"),10),z=g(this).attr("data-status");reservations[A].status=z;x.find('.reservation[data-id="'+A+'"]').removeClass("approved checked completed").addClass(z);a.draw_reservation(reservations[A]);o.update_reservation(A)}}).on("click",".snapping",function(){if(g(this).hasClass("enabled")){snappingEnabled=false;g(this).removeClass("enabled")}else{snappingEnabled=true;g(this).addClass("enabled")}}).on("click",".revert",function(){const z=parseInt(g(this).attr("data-reservation-id"),10);o.recursively_remove_reservation(reservations[z]);x.find('.reservation[data-id="'+z+'"]').remove();editMode.changed=true;o.add_reservation(editMode);o.draw_reservations();a.stop_edit(z)});const a={init:function(){},is_open:function(){return p.hasClass("expanded")},open:function(){if(!a.is_open()){t.find(".expand-sidebar").click()}},close:function(){if(a.is_open()){t.find(".contract-sidebar").click()}},toggle:function(){if(a.is_open()){t.find(".contract-sidebar").click();return false}t.find(".expand-sidebar").click();return true},toggle_calendar:function(){if(!p.find("> .calendar").hasClass("visible")){a.display_calendar();a.open()}else{a.toggle()}},toggle_pending:function(){if(!p.find("> .pending").hasClass("visible")){a.display_pending();a.open()}else{a.toggle()}},clear:function(){p.find("> .visible").hide().removeClass("visible")},display_calendar:function(){const z=p.find("> .calendar");a.clear();z.show().addClass("visible")},display_pending:function(){const z=p.find("> .pending");a.clear();z.show().addClass("visible")},stop_edit:function(z){p.find("> .reservation-details .edit-actions").hide();p.find("> .reservation-details .stop-edit").html(y.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");if(editMode){o.reservation_stop_edit(x.find('.reservation[data-id="'+z+'"]'));editMode=false}},draw_today:function(){const A=p.find("> .calendar .arrivals"),B=p.find("> .calendar .departures"),z=er_both_params.time_format.charAt(er_both_params.time_format.length-1);let date,add,same;A.html("");B.html("");g.each(reservations,function(C,E){if(E){add=false;same=false;if(E.arrival.date()===selected.date()&&E.arrival.month()===selected.month()&&E.arrival.year()===selected.year()){add="arrival";date=E.arrival;same=E.departure.date()===date.date()&&E.departure.month()===date.month()&&E.departure.year()===date.year()}else{if(E.departure.date()===selected.date()&&E.departure.month()===selected.month()&&E.departure.year()===selected.year()){add="departure";date=E.departure}}if(add){const D=g('<div class="today-reservation">');D.attr("data-id",E.id).append('<span class="date"><span class="hour">'+easyAddZero(date.hour())+'</span><span class="minute">'+easyAddZero(date.minute())+'</span><span class="ampm">'+(z==="a"?(date.hour()>=12?"pm":"am"):(z==="A"?(date.hour()>=12?"PM":"AM"):""))+"</span></span>").append('<div><div class="title"><span class="id reservation-status background status-'+E.status+'">'+E.id+"</span>"+E.title+'</div><div class="resource">'+(E.resource>0?y.resources[E.resource].post_title:y.i18n_no_resource)+'</div><div class="date"><span class="'+add+'"></span>'+(same?easyFormatTime(E.departure):easyFormatDate(add==="arrival"?E.departure:E.arrival,"full"))+"</div></div>").bind("click",function(){const F=parseInt(g(this).attr("data-id"),10);x.find('.reservation[data-id="'+F+'"]').trigger("click")});if(add==="arrival"){A.append(D)}else{B.append(D)}}}});if(A.is(":empty")){A.html('<div class="today-reservation">'+y.i18n_no_arrivals+"</div>")}if(B.is(":empty")){B.html('<div class="today-reservation">'+y.i18n_no_departures+"</div>")}},draw_pending:function(){if(y.pending&&y.pending.length>0){const z=p.find("> .pending").find(".reservations");t.find(".pending").html("<span>"+y.pending.length+"</span>");z.html("");g.each(y.pending,function(A,C){const B=g('<div class="pending-reservation">'),D=parseInt(C.resource,10);let foundFreeSpace=false;C.id=parseInt(C.id,10);C.arrival=moment(C.arrival);C.departure=moment(C.departure);if(!C.title){C.title="No title"}B.html('<span class="id">'+C.id+'</span><div><div class="title">'+C.title+'</div><div class="resource">'+(C.resource>0?y.resources[C.resource].post_title:y.i18n_no_resource)+'</div><div class="date">'+easyFormatDate(C.arrival,"full")+'</div><div class="date">'+easyFormatDate(C.departure,"full")+"</div></div>");B.bind("click",function(){o.jump_to_date(C.arrival);if(D>0){u.find('.resource-handler:not([data-resource="'+C.resource+'"],.retracted),.resource-handler.retracted[data-resource="'+C.resource+'"]').trigger("click")}g.each(h,function(E,F){if(!foundFreeSpace&&(D===0||D===parseInt(F,10))){C.resource=parseInt(F,10);if(y.resources[F].availability_by!=="unit"){C.space=1;foundFreeSpace=true;return false}for(let i=1;i<=y.resources[F].quantity;i++){C.space=i;if(o.check_availability(C)){foundFreeSpace=true;break}}}});if(foundFreeSpace){if(editMode){o.update_reservation(editMode.id);a.stop_edit(editMode.id)}editMode=JSON.parse(JSON.stringify(C));o.set_element_as_droppable(x.find("td.cell"));C.status="approved";o.add_reservation(C);o.draw_reservations();a.draw_reservation(C);y.pending.splice(A,1);g(this).remove();a.draw_pending()}});z.append(B)})}else{t.find(".pending").html("");p.find("> .pending").find(".reservations").html(y.i18n_no_pending)}},draw_reservation:function(A){const z=p.find("> .reservation-details"),B=z.find("h2"),C=y.resources[A.resource];B.find(".title").html(A.title);B.find(".reservation-status").attr("class","reservation-status status-"+A.status).html(A.id);z.attr("data-reservation-id",A.id);z.find(".reservation-preview").attr("data-reservation-id",A.id).data("reservation-data",false);z.find(".snapping").removeClass("enabled");z.find(".revert").attr("data-reservation-id",A.id);z.find(".input-box.reservation-status").removeClass("reservation-status");z.find(".input-box.status-"+A.status).addClass("reservation-status");z.find(".reservation-arrival").html(easyFormatDate(A.arrival,"full"));z.find(".reservation-departure").html(easyFormatDate(A.departure,"full"));z.find(".reservation-resource").html(C.post_title);z.find(".reservation-adults").html(A.adults);z.find(".reservation-children").html(A.children);if(editMode&&editMode.id===A.id){z.find(".edit-actions").show();z.find(".allow-edit").html(y.i18n_stop_edit).removeClass("allow-edit").addClass("stop-edit");z.find(".stop-edit").attr("data-reservation-id",A.id)}else{z.find(".stop-edit").html(y.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");z.find(".allow-edit").attr("data-reservation-id",A.id);z.find(".edit-actions").hide()}if(C.availability_by!=="unit"){z.find(".reservation-space").hide()}else{z.find(".reservation-space").show().html(typeof C.spaces[A.space]==="undefined"?A.space:C.spaces[A.space])}if(A.order_id==="0"){z.find(".reservation-order").html(y.i18n_no_order)}else{z.find(".reservation-order").html(y.i18n_order.replace("%s",'<a href="'+y.order_url.replace("%s",A.order_id)+'" target="_blank">#'+A.order_id+"</a>"))}if(snappingEnabled){z.find(".snapping").addClass("enabled")}a.clear();z.show().addClass("visible");a.open()}};var o={init:function(){const A=(g(window).height()-k.offset().top-5)/(y.reservation_id>0?3:1);k.css("max-height",A);q.css("max-height",A);today=moment();reservations=[];selected=false;if(interval==="86400"){r.width=96;today.startOf("day");start.startOf("day")}else{r.width=48;today.startOf("hour");if(today.date()===start.date()&&today.month()===start.month()&&today.year()===start.year()){start.hours(today.hour()).minutes(0).seconds(0).milliseconds(0)}else{start.startOf("day")}}j.find("td,th").remove();start.subtract(15,intervalString);end=moment(start);lastQueryEnd=moment(start);lastQueryStart=moment(start);for(let i=0;i<e;i++){o.generate_column(end,false);if(i<e-1){end.add(1,intervalString)}}o.load_remaining();const z=c.find("th:nth-child(15)").offset().left-j.offset().left+w.scrollLeft()+1;w.scrollLeft(z);o.set_current_date();o.sync_cell_heights()},highlight_current:function(z,B,A){c.find("th.hover").removeClass("hover");c.find('th[data-date="'+z.unix()+'"]').addClass("hover");d.find("td.hover, th.hover").removeClass("hover");if(A){d.find('td[data-resource="'+B+'"][data-space="'+A+'"]').addClass("hover")}else{d.find('th[data-resource="'+B+'"]').addClass("hover")}},set_current_date:function(){const z=moment(start).add(Math.round(w.scrollLeft()/r.width)+1,intervalString);if(interval==="3600"){z.startOf("hour")}else{z.startOf("day")}if(!selected||z.date()!==selected.date()||z.month()!==selected.month()||z.year()!==selected.year()){selected=z;if(interval==="3600"){m.html(selected.date()+" "+er_date_picker_params.month_names[selected.month()]+" "+selected.year())}else{m.html(er_date_picker_params.month_names[selected.month()]+" "+selected.year())}j.find("th.current,td.current").removeClass("current");j.find('th[data-date="'+selected.unix()+'"],td[data-date="'+selected.unix()+'"]').addClass("current");l.datepicker("setDate",new Date(selected.format("YYYY-MM-DDTHH:mm:ssZ")));a.draw_today()}else{if(interval==="3600"&&z.hour()!==selected.hour()){selected=z;j.find("th.current,td.current").removeClass("current");j.find('th[data-date="'+selected.unix()+'"],td[data-date="'+selected.unix()+'"]').addClass("current")}}},scroll_dragging:function(){const A=mousePosY-q.offset().top,z=mousePosX-j.offset().left,B=q.height();if((z>0&&z<r.width/2)||j.width()-z<r.width/2){if(scrollAction===false){scrollAction=setInterval(function(){const C=mousePosX-j.offset().left;if((C>0&&C<r.width/2)||j.width()-C<r.width/2){dragStartPosition.left=dragStartPosition.left+(C<r.width/2?r.width:r.width*-1);o.add_new_column(C<r.width/2);o.set_current_date()}},100)}}else{if(A>0&&A<20){if(scrollAction===false){scrollAction=setInterval(function(){if(scrollAction!==false){q.scrollTop(Math.max(0,q.scrollTop()-4))}},1)}}else{if(B-A<20&&A<=B){if(scrollAction===false){scrollAction=setInterval(function(){if(scrollAction!==false){q.scrollTop(Math.min(B,q.scrollTop()+4))}},1)}}else{if(scrollAction!==false){clearInterval(scrollAction);scrollAction=false;o.load_remaining()}}}}},start_scroll_add_interval:function(){if(scrollAdd===false&&(w.scrollLeft()<2||c.width()-(j.width()+w.scrollLeft())<5+r.width*2)){scrollAdd=setInterval(function(){if(scrollAdd!==false&&(w.scrollLeft()<2||c.width()-(j.width()+w.scrollLeft())<5+r.width*2)){o.add_new_column(w.scrollLeft()<2);o.set_current_date()}},45)}},clear_scroll_add_interval:function(){if(scrollAdd!==false){clearInterval(scrollAdd);scrollAdd=false;o.load_remaining()}},jump_to_date:function(A){if(A<start||A>end){start=A;o.init()}else{const z=selected.diff(A)/(interval*1000);for(let i=1;i<=Math.abs(z);i++){o.add_new_column(z>0)}o.set_current_date()}},add_new_column:function(z){if(z){start.subtract(1,intervalString);o.generate_column(start,true);j.find("th:last-child,td:last-child").remove();lastQueryEnd.subtract(1,intervalString);end.subtract(1,intervalString)}else{end.add(1,intervalString);o.generate_column(end,false);c.find("th:first-child").remove();x.find("th:first-child").remove();x.find("td:first-child").each(function(){const A=g(this).data("reservations");if(A&&A.length>0){g.each(A,function(B,C){if(reservations[C]&&typeof reservations[C]!=="undefined"){reservations[C].changed=true}})}}).remove();lastQueryStart.add(1,intervalString);start.add(1,intervalString);o.draw_reservations()}o.sync_cell_heights()},load_remaining:function(){if(lastQueryStart===0||lastQueryStart>start){o.load_data(start,lastQueryStart);lastQueryStart=moment(start)}else{if(lastQueryEnd<end){const z=moment(end).add(1,intervalString);o.load_data(lastQueryEnd,z);lastQueryEnd=z}else{}}},load_data:function(B,A,z){g.ajax({url:y.ajax_url,data:g.extend({action:"easyreservations_timeline_data",security:y.nonce,start:B.date()+"."+(B.month()+1)+"."+B.year(),start_hour:B.hour(),end:A.date()+"."+(A.month()+1)+"."+A.year(),end_hour:A.hour(),interval:interval},z),type:"POST",success:function(C){if(C.data){g.each(C.data,function(F,D){const E=y.resources[F].quantity;g.each(D,function(I,G){const H=moment(I);let cellClass="",content;if(G<0){cellClass="unavailable";content=0}else{content=E-G}b.find('td[data-date="'+(H.unix())+'"][data-resource="'+F+'"]').removeClass("loading").addClass(cellClass);v.find('th[data-date="'+(H.unix())+'"][data-resource="'+F+'"] div.count').html("<span>"+content+"</span>").addClass(parseInt(G,10)===E?"unavailable":"")})})}if(C.reservations){g.each(C.reservations,function(D,E){o.add_reservation(E,true)});o.draw_reservations()}if(C.message){alert(C.message)}}})},update_reservation:function(A){const z=reservations[A];g.ajax({url:y.ajax_url,data:{action:"easyreservations_timeline_update_reservation",security:y.nonce,id:A,arrival:easyFormatDate(z.arrival,"full"),departure:easyFormatDate(z.departure,"full"),status:z.status,resource:z.resource,space:z.space,adults:z.adults,children:z.children,title:z.title},type:"POST",success:function(B){if(B.reservation){reservations[A].arrival=moment(B.reservation.arrival.date);reservations[A].departure=moment(B.reservation.departure.date);reservations[A].adults=parseInt(B.reservation.adults,10);reservations[A].children=parseInt(B.reservation.children,10);reservations[A].resource=parseInt(B.reservation.resource_id,10);reservations[A].space=parseInt(B.reservation.space,10);reservations[A].order_id=parseInt(B.reservation.order_id,10);reservations[A].changed=true;o.draw_reservations()}if(B.message){alert(B.message)}}})},draw_reservations:function(){const z=[];let completed=true;g.each(reservations,function(A,B){if(B&&B.changed&&B.status!=="pending"){z.push(B.id)}});z.sort(function(B,A){return reservations[B].arrival<reservations[A].arrival?-1:1});g.each(z,function(A,B){if(B){if(!o.draw_reservation(reservations[B])){o.draw_reservations();completed=false;return false}}});if(completed&&z.length>0){o.sync_cell_heights()}},recursively_remove_reservation:function(B){const D=parseInt(B.id,10),A=moment(B.arrival),C=moment(B.departure);if(interval==="86400"){A.startOf("day");C.startOf("day")}else{A.startOf("hour");C.startOf("hour")}while(A<=C){const z=g('td[data-date="'+(A.unix())+'"][data-resource="'+B.resource+'"][data-space="'+B.space+'"]');if(z.length>0){o.recursively_remove_reservations(z,B.depths,D)}A.add(1,intervalString)}},recursively_remove_reservations:function(z,C,D){const A=z.data("reservations"),B=[];let foundStart=false,maxDepths=0;if(A&&A.length>0){g.each(A,function(E,F){if(F){if(F===D||reservations[F].depths>=C){if(foundStart===false){foundStart=reservations[F].depths}foundStart=Math.min(foundStart,reservations[F].depths);changedAnyReservation=true;reservations[F].changed=true}else{B.push(F);maxDepths=Math.max(maxDepths,reservations[F].depths)}}})}z.data("reservations",B);if(foundStart!==false){o.recursively_remove_reservations(z.next(),foundStart,D)}},reservation_stop_edit:function(z){z.draggable("destroy").resizable("destroy");z.find(".title").attr("contenteditable","false")},reservation_allow_edit:function(z){z.draggable({snap:snappingEnabled?false:".reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",scope:"reservations",cancel:".title",revert:function(A,B){if(A){return A}g(this).data("uiDraggable").originalPosition={top:dragStartPosition.top-1,left:dragStartPosition.left};return !A},start:function(A,B){dragStartPosition=B.originalPosition;dragStartOffset=B.offset},drag:function(C,D){const E=parseInt(D.helper.attr("data-id"),10),A=reservations[E];let difference=interval/r.width*(D.position.left-dragStartPosition.left);if(snappingEnabled){const B=Math.round((D.position.left-dragStartPosition.left)/r.width);difference=B*interval;D.position.left=dragStartPosition.left+(B*r.width)}f.html(easyFormatTime(moment(A.arrival).add(difference,"seconds"))+" - "+easyFormatTime(moment(A.departure).add(difference,"seconds"))).css({top:mousePosY,left:Math.min(mousePosX-130,j.width()),display:"block"});if(dragSnapTop!==false){D.position.top=dragSnapTop-dragStartOffset.top+dragStartPosition.top}o.scroll_dragging()},stop:function(){f.css("display","none");if(scrollAction!==false){clearInterval(scrollAction);scrollAction=false;o.load_remaining()}}}).resizable({handles:"e, w",grid:snappingEnabled?[r.width,26]:false,minHeight:0,minWidth:4,start:function(A,B){B.originalElement.attr("style","left: "+B.originalElement.css("left")+";top: "+B.originalElement.css("top")+" !important;width: "+B.originalElement.css("width"))},resize:function(D,E){const F=parseInt(E.element.attr("data-id"),10),C=reservations[F],B=interval/r.width*(E.position.left-E.originalPosition.left),A=interval/r.width*(E.size.width);let message;if(E.position.left-E.originalPosition.left!==0){message=easyFormatTime(moment(C.arrival).add(B,"seconds"))}else{if(E.size.width-E.originalSize.width!==0){message=easyFormatTime(moment(C.arrival).add(A,"seconds"))}else{message=easyFormatTime(moment(C.arrival).add(B,"seconds"));message+=" - ";message+=easyFormatTime(moment(C.arrival).add(A,"seconds"))}}f.html(message).css({top:mousePosY,left:Math.min(mousePosX-130,j.width()),display:"block"})},stop:function(D,E){const F=parseInt(E.element.attr("data-id"),10),C=interval/r.width*(E.position.left-E.originalPosition.left),A=interval/r.width*(E.size.width),B={id:F,arrival:moment(reservations[F].arrival).add(C,"seconds"),departure:moment(reservations[F].arrival).add(C+A,"seconds"),resource:reservations[F].resource,space:reservations[F].space};if(y.resources[reservations[F].resource].availability_by!=="unit"||o.check_availability(B)){o.recursively_remove_reservation(reservations[F]);reservations[F].arrival=B.arrival;reservations[F].departure=B.departure;reservations[F].changed=true;o.draw_reservations()}else{E.helper.animate({width:E.originalSize.width,left:E.originalPosition.left},500,function(){})}f.css("display","none")}});z.find(".title").attr("contenteditable","true")},draw_reservation:function(C){const z=parseInt(C.id,10),F=moment(C.arrival),A=moment(C.departure),H=g('<div class="reservation">'),G=[],B=(((A.diff(F)/1000)/interval)*r.width);let didAdd=false,depths=0;changedAnyReservation=false;if(interval==="86400"){F.startOf("day");A.startOf("day")}else{F.startOf("hour");A.startOf("hour")}while(F<=A){const I=g('td[data-date="'+(F.unix())+'"][data-resource="'+C.resource+'"][data-space="'+C.space+'"]');if(I&&I.length>0){const E=I.data("reservations");if(E.length>0){g.each(E,function(J,K){if(K&&K!==z){if(reservations[K].arrival>C.arrival&&reservations[K].arrival<C.departure&&reservations[K].departure>C.arrival){o.recursively_remove_reservations(I,depths,K)}else{if(reservations[K].departure<=C.arrival||reservations[K].arrival>=C.departure){}else{G[reservations[K].depths]=1}}}})}if(didAdd===false){H.css("left",((C.arrival.diff(F)/1000/interval*r.width)-1)+"px");didAdd=I}if(g.inArray(z,E)<0){E.push(z);I.data("reservations",E)}}F.add(1,intervalString)}if(didAdd===false){reservations[z].changed=false;return true}if(changedAnyReservation){return false}H.html('<span class="wrapper"><span class="sticky"><span class="id">'+z+'</span><div class="title">'+C.title+"</div></span></span>").css("min-width",B+"px").css("max-width",B+"px").css("top","0px").css("position","absolute").addClass(C.status).attr("data-tip",C.id).attr("data-id",C.id);const D=x.find('.reservation[data-id="'+z+'"]').remove();if(D.length>0){H.addClass("fade-in-fast")}else{if(C.fresh){delete C.fresh}else{H.addClass("no-animation")}}if(editMode&&editMode.id===z){a.draw_reservation(C);o.reservation_allow_edit(H);j.find(".reservation.selected").removeClass("selected");H.addClass("selected")}didAdd.append(H);while(G[depths]===1){depths++}if(depths>0){if(didAdd.height()<r.height+(r.height-3)*depths){didAdd.height(r.height+(r.height-3)*depths)}H.css("top",(r.height-3)*depths+"px")}C.depths=depths;C.changed=false;reservations[z]=C;return didAdd},add_reservation:function(z,A){const B=parseInt(z.id,10);z.id=B;z.arrival=moment(z.arrival);z.departure=moment(z.departure);z.resource=parseInt(z.resource,10);z.space=parseInt(z.space,10);if(typeof reservations[B]==="undefined"){z.changed=true;z.fresh=true}else{z.changed=A?true:reservations[B].changed;z.depths=reservations[B].depths}reservations[B]=z},check_availability:function(z){const A=parseInt(z.id,10);let available=true;g.each(reservations,function(B,C){if(C&&C.resource===z.resource&&C.space===z.space&&C.id!==A&&(z.arrival<C.departure&&z.departure>C.arrival)){available=false;return false}});console.log(available);return available},sync_cell_heights:function(){let tbodyIndex,trIndex;d.each(function(z,A){tbodyIndex=(g(A).index()/2)-0.5;g(A).children().each(function(B,C){trIndex=g(C).index();g(C).height(g(b[tbodyIndex]).children().eq(g(C).index()).height())})})},set_element_as_droppable:function(z){z.droppable({scope:"reservations",tolerance:"pointer",drop:function(B,C){let $this=g(this);if(lastHover&&lastHover.getAttribute("data-space")){$this=g(lastHover)}const E=parseInt(C.draggable.attr("data-id"),10),D=interval/r.width*(C.position.left-dragStartPosition.left),A={id:E,arrival:moment(reservations[E].arrival).add(D,"seconds"),departure:moment(reservations[E].departure).add(D,"seconds"),resource:parseInt($this.attr("data-resource"),10),space:parseInt($this.attr("data-space"),10)};if(y.resources[A.resource].availability_by!=="unit"||o.check_availability(A)){o.recursively_remove_reservation(reservations[E]);reservations[E].arrival=A.arrival;reservations[E].departure=A.departure;reservations[E].resource=A.resource;reservations[E].space=A.space;reservations[E].changed=true;if(reservations[E].status==="pending"){reservations[E].status="approved"}C.helper.remove();o.draw_reservations()}}})},generate_column:function(B,E){const z=B.day()===0?6:B.day()-1;let headerMain,headerClass="",tbodyNumber=0,i=0,todayMarker=false;if(interval==="86400"){headerMain=g('<th><div class="date"><div>'+easyFormatDate(B,"d")+"<span>"+er_date_picker_params.day_names_min[z]+'</span></div></div><div class="marker"></div></th>');if(B.date()===1){headerClass="first";headerMain.append(g('<div class="first">'+er_date_picker_params.month_names[B.month()]+"</div>"))}}else{const C=er_both_params.time_format.charAt(er_both_params.time_format.length-1);let description="00";if(C==="a"){description=B.hours()>=12?"pm":"am"}else{if(C==="A"){description=B.hours()>=12?"PM":"AM"}}headerMain=g('<th><div class="date"><div>'+easyFormatDate(B,"H")+"<span>"+description+'</span></div></div><div class="marker"></div></th>');if(B.hours()===0){headerClass="first";headerMain.append(g('<div class="first">'+B.date()+" "+er_date_picker_params.day_names[z]+"</div>"))}}if(B.date()===today.date()&&B.month()===today.month()&&B.year()===today.year()&&(interval==="86400"||B.hour()===today.hour())){const D=moment(),A=g('<div class="overlay"></div>');let difference;todayMarker=g('<div class="today"></div>');if(interval==="86400"){difference=(r.width/86400*((D.hour()*3600)+(D.minute()*60)))-1}else{difference=(r.width/3600*(D.minute()*60))-1}todayMarker.css("left",difference);A.css("left",difference).css("width",difference).css("margin-left",-difference);headerMain.append(todayMarker).append(A);headerClass+=" today"}else{if(B<today){headerClass+=" past"}}if((B.day()===0||B.day()===6)){headerClass+=" weekend"}headerMain.addClass(headerClass).attr("data-date",B.unix());headerClass+=" loading";if(E){c.prepend(headerMain)}else{c.append(headerMain)}g.each(h,function(H,J){const I=g('<th><div class="count"></div></th>').addClass(headerClass).attr("data-resource",J).attr("data-date",B.unix());if(E){g(v[tbodyNumber]).find("tr").prepend(I)}else{g(v[tbodyNumber]).find("tr").append(I)}for(i=1;i<=(y.resources[J].availability_by==="unit"?y.resources[J].quantity:1);i++){const G=g('<td class="cell"></td>').addClass(headerClass).attr("data-resource",J).data("reservations",[]).attr("data-space",i).attr("data-date",B.unix());if(todayMarker){G.append(todayMarker.clone());todayMarker=false}if(E){g(b[tbodyNumber]).find("tr:nth-child("+i+")").prepend(G)}else{g(b[tbodyNumber]).find("tr:nth-child("+i+")").append(G)}if(editMode){o.set_element_as_droppable(G)}}tbodyNumber++});if(E){if(lastQueryStart===0||lastQueryStart.valueOf()-(interval*1000*10)>B.valueOf()){o.load_data(start,lastQueryStart,{});lastQueryStart=moment(start)}}else{if(lastQueryEnd.valueOf()+(interval*1000*10)<B.valueOf()){const F=moment(end).add(interval,"seconds");o.load_data(lastQueryEnd,F,{});lastQueryEnd=F}}}};n.insertAfter("hr.wp-header-end");f.insertAfter("hr.wp-header-end");p.hide();if(y.default_hourly==="on"){interval="3600";intervalString="hours"}if(interval==="86400"){today.startOf("day");t.find(".daily").addClass("active")}else{today.startOf("hour");t.find(".hourly").addClass("active");j.addClass("hourly");r.width=48}setTimeout(function(){a.draw_pending();a.display_calendar();n.css("display","flex");if(y.reservation_arrival){o.jump_to_date(moment(y.reservation_arrival))}else{o.init()}},0);if(y.reservation_resource>0){u.find('.resource-handler:not([data-resource="'+y.reservation_resource+'"],.retracted),.resource-handler.retracted[data-resource="'+y.reservation_resource+'"]').click()}}(jQuery,er_timeline_params));