(function(C,J){var D=C(".er-timeline-tooltip"),i=C(".er-timeline"),z=C("#timeline-datepicker"),n=i.find("div.sidebar"),g=i.find("div.timeline"),d=i.find("div.header"),h=i.find("div.resources table"),v=d.find(".date"),r=g.find("table"),j=r.find("thead.main tr"),w=r.find("thead:not(.main)"),F=r.find("tbody"),c=[],x=new Date(),k=new Date(),t=new Date(),o=false,E=false,H=false,A=false,q=false,e=0,b=0,B=true,f=false,y=false,u=false,m={height:32,width:96},p=0,I=0,G=0,a=J.default_interval;i.insertAfter("hr.wp-header-end");D.insertAfter("hr.wp-header-end");n.hide();if(a==="86400"){k.setHours(0,0,0,0);d.find(".daily").addClass("active")}else{k.setHours(k.getHours(),0,0,0);d.find(".hourly").addClass("active")}d.on("click",".expand-sidebar",function(){n.addClass("expanded").show();C(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){n.removeClass("expanded").hide(300,"linear");C(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".hourly",function(){if(!C(this).hasClass("active")){d.find(".daily").removeClass("active");C(this).addClass("active");t=new Date(x.getTime());a="3600";s.init()}}).on("click",".daily",function(){if(!C(this).hasClass("active")){d.find(".hourly").removeClass("active");C(this).addClass("active");t=new Date(x.getTime());a="86400";s.init()}}).on("click",".date",function(){l.toggle()}).on("click",".today",function(){s.jump_to_date(k)});z.bind("change",function(K){s.jump_to_date(C(this).datepicker("getDate"))});j.on("mousedown","th",function(K){f=g.scrollLeft()+K.pageX});C(window).mouseup(function(){j.css("cursor","grab");clearInterval(y);y=false;f=false;s.clear_scroll_timeout()});i.mousemove(function(K){e=K.pageX;b=K.pageY;if(f&&K.which===1){g.scrollLeft(f-K.pageX<1?1:f-K.pageX);s.set_current_date();if(u===false){j.css("cursor","grabbing");s.start_scroll_add_interval()}}if(p!==K.target){p=K.target;if(p.getAttribute("data-date")){s.highlight_current(new Date(parseInt(K.target.getAttribute("data-date"),10)))}if(p.getAttribute("data-space")){A=C(p).offset().top}else{if(p.getAttribute("data-id")){A=C(p).parent().offset().top}}}}).mouseleave(function(){j.css("cursor","grab");clearInterval(y);y=false;f=false;s.clear_scroll_timeout()}).on("mousedown",".next",function(){if(y===false){s.add_new_column();s.set_current_date();y=setInterval(function(){s.add_new_column();s.set_current_date()},100)}}).on("mousedown",".prev",function(){if(y===false){s.add_new_column(true);s.set_current_date();y=setInterval(function(){s.add_new_column(true);s.set_current_date()},100)}});g.scroll(function(){if(y!==false){j.css("cursor","grabbing")}});var l={is_open:function(){return n.hasClass("expanded")},open:function(){if(!l.is_open()){d.find(".expand-sidebar").click()}},close:function(){if(l.is_open()){d.find(".contract-sidebar").click()}},toggle:function(){if(l.is_open()){d.find(".contract-sidebar").click()}else{d.find(".expand-sidebar").click()}}};l.open();var s={init:function(){var K,L;if(a==="86400"){t.setHours(0,0,0,0)}else{t.setHours(t.getHours(),0,0,0)}r.find("td,th").remove();c=[];t=s.manipulate_date_without_offset(t,(15*a*1000)*-1);K=t;G=new Date(K.getTime());I=new Date(K.getTime());for(L=0;L<50;L++){o=s.manipulate_date_without_offset(K,L*a*1000);s.generate_column(o)}s.load_remaining();g.scrollLeft(j.find("th:nth-child(15)").offset().left-g.offset().left+g.scrollLeft()+1);s.set_current_date()},remove_offset:function(K){return new Date(K.getTime()-K.getTimezoneOffset()*1000*60)},manipulate_date_without_offset:function(K,L){var M=new Date(K.getTime()+L);return new Date(M.getTime()+M.getTimezoneOffset()*1000*60-K.getTimezoneOffset()*1000*60)},highlight_current:function(K){C(".er-timeline .hover").removeClass("hover");C('*[data-date="'+K.getTime()+'"]').addClass("hover")},set_current_date:function(){var K=s.manipulate_date_without_offset(t,((g.scrollLeft()/m.width+1)*a*1000));if(a==="3600"){K.setHours(t.getHours(),0,0,0)}else{K.setHours(0,0,0,0)}if(K.getTime()!==x.getTime()){x=K;j.find("th.current").removeClass("current");if(a==="3600"){v.html(x.getDate()+" "+er_date_picker_params.month_names[x.getMonth()]+" "+x.getFullYear())}else{v.html(er_date_picker_params.month_names[x.getMonth()]+" "+x.getFullYear())}j.find('th[data-date="'+x.getTime()+'"]').addClass("current");z.datepicker("setDate",x)}},start_scroll_add_interval:function(){if(u===false&&(g.scrollLeft()<2||g[0].scrollWidth-(g.width()+g.scrollLeft())<2)){u=setInterval(function(){if(u!==false&&(g.scrollLeft()<2||g[0].scrollWidth-(g.width()+g.scrollLeft())<2)){s.add_new_column(g.scrollLeft()<2);s.set_current_date()}},38)}},jump_to_date:function(L){if(L<t||L>o){t=L;s.init()}else{var N=(x.getTime()-L.getTime()+L.getTimezoneOffset()*1000*60-x.getTimezoneOffset()*1000*60)/(a*1000),K=Math.abs(N);for(var M=1;M<=K;M++){s.add_new_column(N>0)}s.set_current_date()}},add_new_column:function(K){if(K){t=s.manipulate_date_without_offset(t,a*1000*-1);s.generate_column(t,true);r.find("th:last-child,td:last-child").remove();G=s.manipulate_date_without_offset(G,a*1000*-1);o=s.manipulate_date_without_offset(o,a*1000*-1)}else{o=s.manipulate_date_without_offset(o,a*1000);s.generate_column(o);r.find("th:first-child").remove();r.find("td:first-child").each(function(){var L=C(this).data("reservations");if(L&&L.length>0){C.each(L,function(M,N){if(c[N]&&typeof c[N]!=="undefined"){c[N].changed=true}})}}).remove();I=s.manipulate_date_without_offset(I,a*1000);t=s.manipulate_date_without_offset(t,a*1000)}},clear_scroll_timeout:function(){if(u!==false){clearInterval(u);u=false;s.load_remaining()}},load_remaining:function(){if(I===0||I>t){s.load_data(t,I);I=new Date(t.getTime())}else{if(G<o){var K=s.manipulate_date_without_offset(o,a*1000);s.load_data(G,K);G=K}else{}}},load_data:function(L,K){C.ajax({url:J.ajax_url,data:{action:"easyreservations_timeline_data",security:J.nonce,start:L.getDate()+"."+(L.getMonth()+1)+"."+L.getFullYear(),start_hour:L.getHours(),end:K.getDate()+"."+(K.getMonth()+1)+"."+K.getFullYear(),end_hour:K.getHours(),interval:a},type:"POST",success:function(M){if(M.data){C.each(M.data,function(P,O){var N=J.resources[P].quantity;C.each(O,function(U,Q){var S=new Date(parseInt(U,10)*1000),R="",T="";if(Q<0){R="unavailable";T=0}else{T=N-Q}F.find('td[data-date="'+(S.getTime()+(S.getTimezoneOffset()*1000*60))+'"][data-resource="'+P+'"]').removeClass("loading").addClass(R);w.find('th[data-date="'+(S.getTime()+(S.getTimezoneOffset()*1000*60))+'"][data-resource="'+P+'"]').html("<div><span>"+T+"</span></div>").addClass(Q==N?"unavailable":"")})})}if(M.reservations){C.each(M.reservations,function(N,O){s.add_reservation(O)});s.draw_reservations()}}})},draw_reservations:function(){var K=[];C.each(c,function(L,M){if(M&&M.changed){K.push(M.id)}});K.sort(function(M,L){return c[M].arrival<c[L].arrival?-1:1});C.each(K,function(L,M){if(M){if(!s.draw_reservation(c[M])){s.draw_reservations();return false}}})},recursively_remove_reservation:function(N){var O=parseInt(N.id,10),M=new Date(N.arrival.getTime()),L=new Date(N.departure.getTime());if(a==="86400"){M.setHours(0,0,0);L.setHours(0,0,0)}else{M.setHours(M.getHours(),0,0);L.setHours(L.getHours(),0,0)}while(M<=L){var K=C('td[data-date="'+(M.getTime())+'"][data-resource="'+N.resource+'"][data-space="'+N.space+'"]');if(K.length>0){s.recursively_remove_reservations(K,N.depths,O)}M=s.manipulate_date_without_offset(M,a*1000)}return false},recursively_remove_reservations:function(L,P,Q){var K=L.data("reservations"),O=[],M=false,N=0;if(K&&K.length>0){C.each(K,function(R,S){if(S){if(S===Q||c[S].depths>=P){if(M===false){M=c[S].depths}M=Math.min(M,c[S].depths);q=true;c[S].changed=true}else{O.push(S);N=Math.max(N,c[S].depths)}}})}L.data("reservations",O);if(M!==false){return s.recursively_remove_reservations(L.next(),M,Q)}return true},draw_reservation:function(M){var K=parseInt(M.id,10),N=new Date(M.arrival.getTime()),P=new Date(M.departure.getTime()),Q=C('<div class="reservation">'),L=(M.departure.getTime()-M.arrival.getTime()),S=(((L/1000)/a)*m.width)-(a==="86400"?2:1),V=false,W=[],T=0;q=false;if(a==="86400"){N.setHours(0,0,0);P.setHours(0,0,0)}else{N.setHours(N.getHours(),0,0);P.setHours(P.getHours(),0,0)}while(N<=P){var U=C('td[data-date="'+(N.getTime())+'"][data-resource="'+M.resource+'"][data-space="'+M.space+'"]');if(U&&U.length>0){var R=U.data("reservations");if(R.length>0){C.each(R,function(X,Y){if(Y&&Y!==K){if(c[Y].arrival>M.arrival&&c[Y].arrival<M.departure&&c[Y].departure>M.arrival){s.recursively_remove_reservations(U,T,Y)}else{if(c[Y].departure<=M.arrival||c[Y].arrival>=M.departure){}else{W[c[Y].depths]=1}}}})}if(V===false){Q.css("left",(((M.arrival.getTime()-N.getTime())/1000/a*m.width)-1)+"px");V=U}if(C.inArray(K,R)<0){R.push(K);U.data("reservations",R)}}N=s.manipulate_date_without_offset(N,a*1000)}if(V===false){return true}else{if(q){return false}else{Q.html('<span class="wrapper"><span>#'+K+" "+M.title+"</span></span>").draggable({snap:B?false:"td.cell,.reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",containment:F,revert:function(X,Y){if(X){return X}if(C(this).data("uiDraggable")){}C(this).data("uiDraggable").originalPosition={top:E.top-1,left:E.left};return !X},stack:".reservation",scope:"reservations",start:function(X,Y){E=Y.originalPosition;H=Y.offset},drag:function(Z,aa){var ad=parseInt(aa.helper.attr("data-id"),10),X=c[ad],ac=a/m.width*(aa.position.left-E.left),Y=e-g.offset().left;if(B){var ab=Math.round((aa.position.left-E.left)/m.width);ac=ab*a;aa.position.left=E.left+(ab*m.width)}D.html(easyFormatTime(s.manipulate_date_without_offset(X.arrival,ac*1000))+" - "+easyFormatTime(s.manipulate_date_without_offset(X.departure,ac*1000))).css({top:b,left:Math.min(e-130,g.width())}).show();if(A!==false){aa.position.top=A-H.top+E.top}if(Y<10||g.width()-Y<10){if(y===false){y=setInterval(function(){if(y!==false){if(u===false&&(g.scrollLeft()<2||g[0].scrollWidth-(g.width()+g.scrollLeft())<2)){s.add_new_column(g.scrollLeft()<2);E.left=E.left+(g.scrollLeft()<2?m.width:m.width*-1)}g.scrollLeft(Math.max(1,g.scrollLeft()+(e-g.offset().left<10?m.width*-1:m.width)))}},130)}}else{if(y!==false){clearInterval(y);y=false;s.load_remaining()}}},stop:function(){D.hide();if(y!==false){clearInterval(y);y=false;s.load_remaining()}}}).resizable({handles:"e, w",grid:B?[96,28]:false,maxWidth:m.width*50,scroll:0,minHeight:0,minWidth:4,start:function(ac,ad){var ae=parseInt(ad.originalElement.attr("data-id"),10),X=ad.originalElement.parent(),aa=C(p).hasClass("ui-resizable-w");if(er_both_params.resources[c[ae].resource].availability_by==="unit"){var ab=X.data("reservations"),Z=[],Y;if(aa&&ab.length>0){ab.reverse()}C.each(ab,function(af,ag){if(Y||ag===ae){Y=true;Z.push(ag)}});while(X.length>0){if(Z.length>0){C.each(Z,function(af,ag){if(ag!==ae){if(aa){}else{}X={length:0};return false}})}if(X.length>0){if(aa){X=X.prev()}else{X=X.next()}Z=X.data("reservations")}}}ad.helper.attr("style","left: "+ad.helper.css("left")+";top: "+ad.helper.css("top")+";width: "+ad.helper.css("width"))},resize:function(aa,ac){var ad=parseInt(ac.element.attr("data-id"),10),Y=c[ad],X=a/m.width*(ac.position.left-ac.originalPosition.left),ab=a/m.width*(ac.size.width+2),Z="";if(ac.position.left-ac.originalPosition.left!==0){Z=easyFormatTime(s.manipulate_date_without_offset(Y.arrival,X*1000))}else{if(ac.size.width-ac.originalSize.width!==0){Z=easyFormatTime(s.manipulate_date_without_offset(Y.arrival,ab*1000))}else{Z=easyFormatTime(s.manipulate_date_without_offset(Y.arrival,X*1000));Z+=" - ";Z+=easyFormatTime(s.manipulate_date_without_offset(Y.arrival,ab*1000))}}D.html(Z).css({top:b,left:Math.min(e-130,g.width())}).show()},stop:function(Z,ab){var ac=parseInt(ab.element.attr("data-id"),10),X=a/m.width*(ab.position.left-ab.originalPosition.left),aa=a/m.width*(ab.size.width+2),Y={id:ac,arrival:s.manipulate_date_without_offset(c[ac].arrival,X*1000),departure:s.manipulate_date_without_offset(c[ac].arrival,(X*1000)+(aa*1000)),resource:c[ac].resource,space:c[ac].space};if(er_both_params.resources[c[ac].resource].availability_by!=="unit"||s.check_availability(Y)){s.recursively_remove_reservation(c[ac]);c[ac].arrival=Y.arrival;c[ac].departure=Y.departure;c[ac].changed=true;s.draw_reservations()}else{ab.helper.animate({width:ab.originalSize.width,left:ab.originalPosition.left},500,function(){})}D.hide()}}).css("min-width",S+"px").css("max-width",S+"px").css("top","0px").css("position","absolute").attr("data-tip",M.id).attr("data-id",M.id);var O=C('.reservation[data-id="'+K+'"]').remove();if(O.length>0){console.log(O.length);Q.addClass("fade-in-fast")}V.append(Q);while(W[T]===1){T++}if(T>0){if(V.height()<m.height+(m.height-3)*T){V.height(m.height+(m.height-3)*T)}Q.css("top",(m.height-3)*T+"px")}M.depths=T;M.changed=false;console.log("did draw "+K+"at depths "+T);c[K]=M}}return V},add_reservation:function(K){var L=parseInt(K.id,10);K.id=L;K.arrival=new Date(K.arrival);K.departure=new Date(K.departure);K.resource=parseInt(K.resource,10);K.space=parseInt(K.space,10);if(typeof c[L]==="undefined"){K.changed=true}else{K.changed=c[L].changed;K.depths=c[L].depths}c[L]=K},check_availability:function(K){var M=parseInt(K.id,10),L=true;C.each(c,function(N,O){if(O&&O.resource===K.resource&&O.space===K.space&&O.id!==M&&(K.arrival<O.departure&&K.departure>O.arrival)){console.log("checkAvailabilty false because of");console.log(O);L=false;return false}});return L},generate_column:function(O,S){var M="",V="",K=0,P=0,T=O.getDay()===0?6:O.getDay()-1;if(a==="86400"){M=C('<th><div class="date"><span>'+easyFormatDate(O,"d")+"</span><div>"+er_date_picker_params.day_names_min[T]+"</div></div></th>");if(O.getDate()===1){V="first"}}else{M=C("<th>"+easyFormatDate(O,"H")+"</th>");if(O.getHours()===0){V="first"}}if(V==="first"){M.append(C('<div class="first-of-month"></div>'))}if(O.getDate()===k.getDate()&&O.getMonth()===k.getMonth()&&O.getFullYear()===k.getFullYear()&&(a==="86400"||O.getHours()===k.getHours())){var U=C('<div class="today"></div>'),L=C('<div class="overlay"></div>'),N=0,R=new Date();if(a==="86400"){N=m.width/86400*(R.getHours()*3600+R.getMinutes()*60)-1}else{N=m.width/3600*(R.getMinutes()*60)-1}U.css("left",N);L.css("left",N).css("width",N).css("margin-left",-N);M.append(U).append(L);V+=" today"}else{if(O<k){V+=" past"}}if(a==="86400"&&(O.getDay()===0||O.getDay()===6)){V+=" weekend"}M.addClass(V).attr("data-date",O.getTime());V+=" loading";if(S){j.prepend(M)}else{j.append(M)}C.each(J.resources,function(Z,Y){var X=C("<th><div></div></th>").addClass(V).attr("data-resource",Z).attr("data-date",O.getTime());if(S){C(w[K]).find("tr").prepend(X)}else{C(w[K]).find("tr").append(X)}for(P=1;P<=(Y.availability_by==="unit"?Y.quantity:1);P++){var W=C('<td class="cell"></td>').addClass(V).attr("data-resource",Z).data("reservations",[]).attr("data-space",P).attr("data-date",O.getTime());if(S){C(F[K]).find("tr:nth-child("+P+")").prepend(W)}else{C(F[K]).find("tr:nth-child("+P+")").append(W)}W.droppable({scope:"reservations",tolerance:"pointer",drop:function(ac,ad){var aa=C(this);if(p.getAttribute("data-space")){aa=C(p)}var af=parseInt(ad.draggable.attr("data-id"),10),ae=a/m.width*(ad.position.left-E.left),ab={id:af,arrival:s.manipulate_date_without_offset(c[af].arrival,ae*1000),departure:s.manipulate_date_without_offset(c[af].departure,ae*1000),resource:parseInt(aa.attr("data-resource"),10),space:parseInt(aa.attr("data-space"),10)};if(er_both_params.resources[ab.resource].availability_by!=="unit"||s.check_availability(ab)){s.recursively_remove_reservation(c[af]);c[af].arrival=ab.arrival;c[af].departure=ab.departure;c[af].resource=ab.resource;c[af].space=ab.space;c[af].changed=true;ad.helper.remove();s.draw_reservations()}else{}},over:function(aa,ab){}})}K++});if(S){if(I===0||I.getTime()-(a*1000*10)>O.getTime()){s.load_data(t,I);I=new Date(t.getTime())}}else{if(G.getTime()+(a*1000*10)<O.getTime()){var Q=new Date(s.manipulate_date_without_offset(o,a*1000).getTime());s.load_data(G,Q);G=Q}}}};s.init()})(jQuery,er_timeline_params);