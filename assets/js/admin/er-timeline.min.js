(function(g,x){const f=g(".er-timeline-tooltip"),m=g(".er-timeline"),k=g("#timeline-datepicker"),o=m.find("div.sidebar"),h=m.find("div.timeline"),s=m.find("div.header"),t=m.find("div.resources"),j=t.find(".vertical-scroll"),d=t.find("table tbody"),l=s.find(".date"),p=h.find("div.vertical-scroll"),r=p.find("div.horizontal-scroll"),w=h.find("div.vertical-scroll table"),v=h.find("div.horizontal-scroll"),c=h.find("thead.main tr"),u=w.find("thead:not(.main)"),b=w.find("tbody"),e=60,q={height:32,width:96};let reservations=[],selected=false,today=moment(),start=moment(),end=false,dragStartPosition=false,dragStartOffset=false,dragSnapTop=false,editMode=false,addMode=false,changedAnyReservation=false,mousePosX=0,mousePosY=0,scrollDrag=false,scrollAction=false,scrollAdd=false,placeholder=false,lastHover=0,lastQueryStart=0,lastQueryEnd=0,snappingEnabled=x.default_snapping==="1",interval="86400",intervalString="days";s.on("click",".expand-sidebar",function(){o.addClass("expanded").show();g(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){o.removeClass("expanded").hide(300,"linear");g(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".hourly",function(){if(!g(this).hasClass("active")){h.addClass("hourly");s.find(".daily").removeClass("active");g(this).addClass("active");start=moment(selected);interval="3600";intervalString="hours";n.init()}}).on("click",".daily",function(){if(!g(this).hasClass("active")){h.removeClass("hourly");s.find(".hourly").removeClass("active");g(this).addClass("active");start=moment(selected);interval="86400";intervalString="days";n.init()}}).on("click",".pending",function(){a.toggle_pending()}).on("click",".date",function(){a.toggle_calendar()}).on("click",".today",function(){n.jump_to_date(today)}).on("click","a.start-add",function(){addMode=g(this).attr("data-target")}).on("click",".cancel-add",function(){addMode=false});k.bind("change",function(y){n.jump_to_date(moment(g(this).datepicker("getDate")))});c.on("mousedown","th",function(y){scrollDrag=v.scrollLeft()+y.pageX});p.on("scroll",function(){j.css("margin-top",-g(this).scrollTop())});g(window).mouseup(function(D){c.css("cursor","grab");clearInterval(scrollAction);scrollAction=false;scrollDrag=false;n.clear_scroll_add_interval();f.css("display","none");if(placeholder){const E=prompt(x.i18n_enter_title,"");if(E!==null){const C=placeholder.attr("data-direction"),A=parseInt(placeholder.css("width"),10)/q.width*interval,B=moment(parseInt(placeholder.attr("data-start"),10)*1000),z=C==="left"?moment(B).subtract(A,"seconds"):moment(B).add(A,"seconds"),y={add:addMode,arrival:easyFormatDate(B<z?B:z,"full"),departure:easyFormatDate(z>B?z:B,"full"),resource:parseInt(placeholder.attr("data-resource"),10),space:parseInt(placeholder.attr("data-space"),10),title:E};if(interval==="86400"){B.startOf("day");z.startOf("day")}else{B.startOf("hour");z.startOf("hour")}if(z>B){z.add(1,intervalString)}else{B.subtract(1,intervalString)}n.load_data(B<z?B:z,z>B?z:B,y)}placeholder.remove();placeholder=false;addMode=false}});m.on("click",".resource-handler",function(){const z=g(this).parent().parent().parent().parent().next(),y=(z.index()/2)-0.5;if(g(this).hasClass("retracted")){g(this).removeClass("retracted");z.removeClass("retracted");g(b[y]).removeClass("retracted").show();z.show()}else{g(this).addClass("retracted");z.addClass("retracted");g(b[y]).addClass("retracted").hide();z.hide()}}).on("mousedown",".next",function(){if(scrollAction===false){n.add_new_column(false);n.set_current_date();scrollAction=setInterval(function(){n.add_new_column(false);n.set_current_date()},100)}}).on("mousedown",".prev",function(){if(scrollAction===false){n.add_new_column(true);n.set_current_date();scrollAction=setInterval(function(){n.add_new_column(true);n.set_current_date()},100)}});h.mousemove(function(A){mousePosX=A.pageX;mousePosY=A.pageY;if(scrollDrag&&A.which===1){v.scrollLeft(Math.min(scrollDrag-A.pageX<1?1:scrollDrag-A.pageX,c.width()-h.width()-q.width));n.set_current_date();if(scrollAdd===false){c.css("cursor","grabbing");n.start_scroll_add_interval()}}if(placeholder){const y=-dragStartPosition.left+mousePosX-parseInt(placeholder.attr("data-pageX"),10),z=moment(parseInt(placeholder.attr("data-start"),10)*1000),B=(y)/q.width*interval;let tooltipFirst="",tooltipSecond="";if(-dragStartPosition.left+y>0){placeholder.attr("data-direction","right").css("margin-left",dragStartPosition.left).css("width",y+(-dragStartPosition.left));tooltipFirst=easyFormatTime(z);tooltipSecond=easyFormatTime(z.add(B,"seconds"))}else{placeholder.attr("data-direction","left").css("margin-left",y).css("width",(-y)+dragStartPosition.left);tooltipSecond=easyFormatTime(z);tooltipFirst=easyFormatTime(z.add(B,"seconds"))}f.html(tooltipFirst+" - "+tooltipSecond).css({top:mousePosY,left:Math.min(mousePosX-130,h.width()),display:"block"});n.scroll_dragging()}else{if(addMode&&A.target.getAttribute("data-space")){f.html(easyFormatTime(moment(start).add(interval/q.width*(Math.floor(A.target.offsetLeft+A.offsetX)+1),"seconds"))).css({top:mousePosY,left:Math.min(mousePosX-130,h.width()),display:"block"})}}if(lastHover!==A.target){lastHover=A.target;if(lastHover.getAttribute("data-resource")){n.highlight_current(moment(parseInt(A.target.getAttribute("data-date"),10)*1000),parseInt(A.target.getAttribute("data-resource"),10),parseInt(A.target.getAttribute("data-space"),10))}else{c.find("th.hover").removeClass("hover")}if(lastHover.getAttribute("data-space")){dragSnapTop=g(lastHover).offset().top}else{if(lastHover.getAttribute("data-id")){dragSnapTop=g(lastHover).parent().offset().top}}}}).mouseleave(function(){c.css("cursor","grab");c.find("th.hover").removeClass("hover");d.find("td.hover").removeClass("hover");clearInterval(scrollAction);scrollAction=false;scrollDrag=false;lastHover=false;f.css("display","none");n.clear_scroll_add_interval();if(placeholder){placeholder.remove();placeholder=false}}).on("mousedown",".cell",function(z){if(addMode){const y=moment(parseInt(g(this).attr("data-date"),10)*1000).add(interval/(q.width)*Math.floor(z.offsetX+1),"seconds");let attach=this;placeholder=g('<div class="placeholder">');dragStartPosition={top:0,left:0};if(addMode==="resource"){attach=this.parentNode.parentNode}else{if(addMode==="global"){attach=this.parentNode.parentNode.parentNode}}placeholder.css("top",attach.offsetTop).css("left",this.offsetLeft+z.offsetX+1).css("height",g(attach).height()).attr("data-pageX",z.pageX).attr("data-resource",g(this).attr("data-resource")).attr("data-space",g(this).attr("data-space")).attr("data-start",y.unix());r.append(placeholder)}}).on("click",".reservation",function(){const y=parseInt(g(this).attr("data-id"),10);h.find(".reservation.selected").removeClass("selected");g(this).addClass("selected");a.draw_reservation(reservations[y])}).on("keydown",".reservation .title",function(y){if(y.keyCode===13){const z=g(this).parents(".reservation").attr("data-id");reservations[z].title=g(this).html();g(this).blur();a.draw_reservation(reservations[z]);return false}});o.on("click",".allow-edit",function(){const y=parseInt(g(this).attr("data-reservation-id"),10);if(editMode){n.update_reservation(y);a.stop_edit(editMode.id)}n.set_element_as_droppable(w.find("td.cell"));editMode=JSON.parse(JSON.stringify(reservations[y]));addMode=false;o.find("> .reservation-details .edit-actions").show();n.reservation_allow_edit(w.find('.reservation[data-id="'+y+'"]'));g(this).html(x.i18n_stop_edit).addClass("stop-edit").removeClass("allow-edit")}).on("click",".stop-edit",function(){const y=parseInt(g(this).attr("data-reservation-id"),10);n.update_reservation(y);a.stop_edit(y)}).on("click",".status",function(){if(!g(this).hasClass("reservation-status")){const z=parseInt(g(this).parent().parent().attr("data-reservation-id"),10),y=g(this).attr("data-status");reservations[z].status=y;w.find('.reservation[data-id="'+z+'"]').removeClass("approved checked completed").addClass(y);a.draw_reservation(reservations[z]);n.update_reservation(z)}}).on("click",".snapping",function(){if(g(this).hasClass("enabled")){snappingEnabled=false;g(this).removeClass("enabled")}else{snappingEnabled=true;g(this).addClass("enabled")}}).on("click",".revert",function(){const y=parseInt(g(this).attr("data-reservation-id"),10);n.recursively_remove_reservation(reservations[y]);w.find('.reservation[data-id="'+y+'"]').remove();editMode.changed=true;n.add_reservation(editMode);n.draw_reservations();a.stop_edit(y)});const a={init:function(){},is_open:function(){return o.hasClass("expanded")},open:function(){if(!a.is_open()){s.find(".expand-sidebar").click()}},close:function(){if(a.is_open()){s.find(".contract-sidebar").click()}},toggle:function(){if(a.is_open()){s.find(".contract-sidebar").click();return false}s.find(".expand-sidebar").click();return true},toggle_calendar:function(){if(!o.find("> .calendar").hasClass("visible")){a.display_calendar();a.open()}else{a.toggle()}},toggle_pending:function(){if(!o.find("> .pending").hasClass("visible")){a.display_pending();a.open()}else{a.toggle()}},clear:function(){o.find("> .visible").hide().removeClass("visible")},display_calendar:function(){const y=o.find("> .calendar");a.clear();y.show().addClass("visible")},display_pending:function(){const y=o.find("> .pending");a.clear();y.show().addClass("visible")},stop_edit:function(y){o.find("> .reservation-details .edit-actions").hide();o.find("> .reservation-details .stop-edit").html(x.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");if(editMode){n.reservation_stop_edit(w.find('.reservation[data-id="'+y+'"]'));editMode=false}},draw_today:function(){const z=o.find("> .calendar .arrivals"),A=o.find("> .calendar .departures"),y=er_both_params.time_format.charAt(er_both_params.time_format.length-1);let date,add,same;z.html("");A.html("");g.each(reservations,function(B,D){if(D){add=false;same=false;if(D.arrival.date()===selected.date()&&D.arrival.month()===selected.month()&&D.arrival.year()===selected.year()){add="arrival";date=D.arrival;same=D.departure.date()===date.date()&&D.departure.month()===date.month()&&D.departure.year()===date.year()}else{if(D.departure.date()===selected.date()&&D.departure.month()===selected.month()&&D.departure.year()===selected.year()){add="departure";date=D.departure}}if(add){const C=g('<div class="today-reservation">');C.attr("data-id",D.id).append('<span class="date"><span class="hour">'+easyAddZero(date.hour())+'</span><span class="minute">'+easyAddZero(date.minute())+'</span><span class="ampm">'+(y==="a"?(date.hour()>=12?"pm":"am"):(y==="A"?(date.hour()>=12?"PM":"AM"):""))+"</span></span>").append('<div><div class="title"><span class="id reservation-status background status-'+D.status+'">'+D.id+"</span>"+D.title+'</div><div class="resource">'+(D.resource>0?x.resources[D.resource].post_title:x.i18n_no_resource)+'</div><div class="date"><span class="'+add+'"></span>'+(same?easyFormatTime(D.departure):easyFormatDate(add==="arrival"?D.departure:D.arrival,"full"))+"</div></div>").bind("click",function(){const E=parseInt(g(this).attr("data-id"),10);w.find('.reservation[data-id="'+E+'"]').trigger("click")});if(add==="arrival"){z.append(C)}else{A.append(C)}}}});if(z.is(":empty")){z.html('<div class="today-reservation">'+x.i18n_no_arrivals+"</div>")}if(A.is(":empty")){A.html('<div class="today-reservation">'+x.i18n_no_departures+"</div>")}},draw_pending:function(){if(x.pending&&x.pending.length>0){const y=o.find("> .pending").find(".reservations");s.find(".pending").html("<span>"+x.pending.length+"</span>");y.html("");g.each(x.pending,function(z,B){const A=g('<div class="pending-reservation">'),C=parseInt(B.resource,10);let foundFreeSpace=false;B.id=parseInt(B.id,10);B.arrival=moment(B.arrival);B.departure=moment(B.departure);if(!B.title){B.title="No title"}A.html('<span class="id">'+B.id+'</span><div><div class="title">'+B.title+'</div><div class="resource">'+(B.resource>0?x.resources[B.resource].post_title:x.i18n_no_resource)+'</div><div class="date">'+easyFormatDate(B.arrival,"full")+'</div><div class="date">'+easyFormatDate(B.departure,"full")+"</div></div>");A.bind("click",function(){n.jump_to_date(B.arrival);if(C>0){t.find('.resource-handler:not([data-resource="'+B.resource+'"],.retracted),.resource-handler.retracted[data-resource="'+B.resource+'"]').click()}g.each(x.resources,function(D,E){if(!foundFreeSpace&&(C===0||C===E.ID)){if(E.availability_by==="unit"){B.resource=E.ID;B.space=1;foundFreeSpace=true;return false}B.resource=E.ID;for(let i=1;i<=E.quantity;i++){B.space=1;if(n.check_availability(B)){foundFreeSpace=true;break}}}});if(foundFreeSpace){if(editMode){n.update_reservation(editMode.id);a.stop_edit(editMode.id)}editMode=JSON.parse(JSON.stringify(B));n.set_element_as_droppable(w.find("td.cell"));B.status="approved";n.add_reservation(B);n.draw_reservations();a.draw_reservation(B);x.pending.splice(z,1);g(this).remove();a.draw_pending()}});y.append(A)})}else{s.find(".pending").html("");o.find("> .pending").find(".reservations").html(x.i18n_no_pending)}},draw_reservation:function(z){const y=o.find("> .reservation-details"),A=y.find("h2"),B=x.resources[z.resource];A.find(".title").html(z.title);A.find(".reservation-status").attr("class","reservation-status status-"+z.status).html(z.id);y.attr("data-reservation-id",z.id);y.find(".reservation-preview").attr("data-reservation-id",z.id).data("reservation-data",false);y.find(".snapping").removeClass("enabled");y.find(".revert").attr("data-reservation-id",z.id);y.find(".input-box.reservation-status").removeClass("reservation-status");y.find(".input-box.status-"+z.status).addClass("reservation-status");y.find(".reservation-arrival").html(easyFormatDate(z.arrival,"full"));y.find(".reservation-departure").html(easyFormatDate(z.departure,"full"));y.find(".reservation-resource").html(B.post_title);y.find(".reservation-adults").html(z.adults);y.find(".reservation-children").html(z.children);if(editMode&&editMode.id===z.id){y.find(".edit-actions").show();y.find(".allow-edit").html(x.i18n_stop_edit).removeClass("allow-edit").addClass("stop-edit");y.find(".stop-edit").attr("data-reservation-id",z.id)}else{y.find(".stop-edit").html(x.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");y.find(".allow-edit").attr("data-reservation-id",z.id);y.find(".edit-actions").hide()}if(B.availability_by!=="unit"){y.find(".reservation-space").hide()}else{y.find(".reservation-space").show().html(typeof B.spaces[z.space]==="undefined"?z.space:B.spaces[z.space])}if(z.order_id==="0"){y.find(".reservation-order").html(x.i18n_no_order)}else{y.find(".reservation-order").html(x.i18n_order.replace("%s",'<a href="'+x.order_url.replace("%s",z.order_id)+'" target="_blank">#'+z.order_id+"</a>"))}if(snappingEnabled){y.find(".snapping").addClass("enabled")}a.clear();y.show().addClass("visible");a.open()}};var n={init:function(){console.log(312);const z=(g(window).height()-j.offset().top-5)/(x.reservation_id>0?3:1);j.css("max-height",z);p.css("max-height",z);today=moment();reservations=[];selected=false;if(interval==="86400"){q.width=96;today.startOf("day");start.startOf("day")}else{q.width=48;today.startOf("hour");if(today.date()===start.date()&&today.month()===start.month()&&today.year()===start.year()){start.hours(today.hour()).minutes(0).seconds(0).milliseconds(0)}else{start.startOf("day")}}h.find("td,th").remove();start.subtract(15,intervalString);end=moment(start);lastQueryEnd=moment(start);lastQueryStart=moment(start);var B=performance.now();for(let i=0;i<e;i++){n.generate_column(end,false);if(i<e-1){end.add(1,intervalString)}}var A=performance.now();console.log("Call to doSomething took "+(A-B)+" milliseconds.");n.load_remaining();const y=c.find("th:nth-child(15)").offset().left-h.offset().left+v.scrollLeft()+1;v.scrollLeft(y);n.set_current_date();n.sync_cell_heights()},highlight_current:function(y,A,z){c.find("th.hover").removeClass("hover");c.find('th[data-date="'+y.unix()+'"]').addClass("hover");d.find("td.hover, th.hover").removeClass("hover");if(z){d.find('td[data-resource="'+A+'"][data-space="'+z+'"]').addClass("hover")}else{d.find('th[data-resource="'+A+'"]').addClass("hover")}},set_current_date:function(){const y=moment(start).add(Math.round(v.scrollLeft()/q.width)+1,intervalString);if(interval==="3600"){y.startOf("hour")}else{y.startOf("day")}if(!selected||y.date()!==selected.date()||y.month()!==selected.month()||y.year()!==selected.year()){selected=y;if(interval==="3600"){l.html(selected.date()+" "+er_date_picker_params.month_names[selected.month()]+" "+selected.year())}else{l.html(er_date_picker_params.month_names[selected.month()]+" "+selected.year())}h.find("th.current,td.current").removeClass("current");h.find('th[data-date="'+selected.unix()+'"],td[data-date="'+selected.unix()+'"]').addClass("current");k.datepicker("setDate",new Date(selected.format("YYYY-MM-DDTHH:mm:ssZ")));a.draw_today()}else{if(interval==="3600"&&y.hour()!==selected.hour()){selected=y;h.find("th.current,td.current").removeClass("current");h.find('th[data-date="'+selected.unix()+'"],td[data-date="'+selected.unix()+'"]').addClass("current")}}},scroll_dragging:function(){const z=mousePosY-p.offset().top,y=mousePosX-h.offset().left,A=p.height();if((y>0&&y<q.width/2)||h.width()-y<q.width/2){if(scrollAction===false){scrollAction=setInterval(function(){const B=mousePosX-h.offset().left;if((B>0&&B<q.width/2)||h.width()-B<q.width/2){dragStartPosition.left=dragStartPosition.left+(B<q.width/2?q.width:q.width*-1);n.add_new_column(B<q.width/2);n.set_current_date()}},100)}}else{if(z>0&&z<20){if(scrollAction===false){scrollAction=setInterval(function(){if(scrollAction!==false){p.scrollTop(Math.max(0,p.scrollTop()-4))}},1)}}else{if(A-z<20&&z<=A){if(scrollAction===false){scrollAction=setInterval(function(){if(scrollAction!==false){p.scrollTop(Math.min(A,p.scrollTop()+4))}},1)}}else{if(scrollAction!==false){clearInterval(scrollAction);scrollAction=false;n.load_remaining()}}}}},start_scroll_add_interval:function(){if(scrollAdd===false&&(v.scrollLeft()<2||c.width()-(h.width()+v.scrollLeft())<5+q.width*2)){scrollAdd=setInterval(function(){if(scrollAdd!==false&&(v.scrollLeft()<2||c.width()-(h.width()+v.scrollLeft())<5+q.width*2)){n.add_new_column(v.scrollLeft()<2);n.set_current_date()}},45)}},clear_scroll_add_interval:function(){if(scrollAdd!==false){clearInterval(scrollAdd);scrollAdd=false;n.load_remaining()}},jump_to_date:function(z){if(z<start||z>end){start=z;n.init()}else{const y=selected.diff(z)/(interval*1000);for(let i=1;i<=Math.abs(y);i++){n.add_new_column(y>0)}n.set_current_date()}},add_new_column:function(y){if(y){start.subtract(1,intervalString);n.generate_column(start,true);h.find("th:last-child,td:last-child").remove();lastQueryEnd.subtract(1,intervalString);end.subtract(1,intervalString)}else{end.add(1,intervalString);n.generate_column(end,false);c.find("th:first-child").remove();w.find("th:first-child").remove();w.find("td:first-child").each(function(){const z=g(this).data("reservations");if(z&&z.length>0){g.each(z,function(A,B){if(reservations[B]&&typeof reservations[B]!=="undefined"){reservations[B].changed=true}})}}).remove();lastQueryStart.add(1,intervalString);start.add(1,intervalString);n.draw_reservations()}n.sync_cell_heights()},load_remaining:function(){if(lastQueryStart===0||lastQueryStart>start){n.load_data(start,lastQueryStart);lastQueryStart=moment(start)}else{if(lastQueryEnd<end){const y=moment(end).add(1,intervalString);n.load_data(lastQueryEnd,y);lastQueryEnd=y}else{}}},load_data:function(A,z,y){g.ajax({url:x.ajax_url,data:g.extend({action:"easyreservations_timeline_data",security:x.nonce,start:A.date()+"."+(A.month()+1)+"."+A.year(),start_hour:A.hour(),end:z.date()+"."+(z.month()+1)+"."+z.year(),end_hour:z.hour(),interval:interval},y),type:"POST",success:function(B){if(B.data){g.each(B.data,function(E,C){const D=x.resources[E].quantity;g.each(C,function(H,F){const G=moment(H);let cellClass="",content;if(F<0){cellClass="unavailable";content=0}else{content=D-F}b.find('td[data-date="'+(G.unix())+'"][data-resource="'+E+'"]').removeClass("loading").addClass(cellClass);u.find('th[data-date="'+(G.unix())+'"][data-resource="'+E+'"] div.count').html("<span>"+content+"</span>").addClass(parseInt(F,10)===D?"unavailable":"")})})}if(B.reservations){g.each(B.reservations,function(C,D){n.add_reservation(D,true)});n.draw_reservations()}if(B.message){alert(B.message)}}})},update_reservation:function(z){const y=reservations[z];g.ajax({url:x.ajax_url,data:{action:"easyreservations_timeline_update_reservation",security:x.nonce,id:z,arrival:easyFormatDate(y.arrival,"full"),departure:easyFormatDate(y.departure,"full"),status:y.status,resource:y.resource,space:y.space,adults:y.adults,children:y.children,title:y.title},type:"POST",success:function(A){if(A.reservation){reservations[z].arrival=moment(A.reservation.arrival.date);reservations[z].departure=moment(A.reservation.departure.date);reservations[z].adults=parseInt(A.reservation.adults,10);reservations[z].children=parseInt(A.reservation.children,10);reservations[z].resource=parseInt(A.reservation.resource_id,10);reservations[z].space=parseInt(A.reservation.space,10);reservations[z].order_id=parseInt(A.reservation.order_id,10);reservations[z].changed=true;n.draw_reservations()}if(A.message){alert(A.message)}}})},draw_reservations:function(){const y=[];let completed=true;g.each(reservations,function(z,A){if(A&&A.changed&&A.status!=="pending"){y.push(A.id)}});y.sort(function(A,z){return reservations[A].arrival<reservations[z].arrival?-1:1});g.each(y,function(z,A){if(A){if(!n.draw_reservation(reservations[A])){n.draw_reservations();completed=false;return false}}});if(completed&&y.length>0){n.sync_cell_heights()}},recursively_remove_reservation:function(A){const C=parseInt(A.id,10),z=moment(A.arrival),B=moment(A.departure);if(interval==="86400"){z.startOf("day");B.startOf("day")}else{z.startOf("hour");B.startOf("hour")}while(z<=B){const y=g('td[data-date="'+(z.unix())+'"][data-resource="'+A.resource+'"][data-space="'+A.space+'"]');if(y.length>0){n.recursively_remove_reservations(y,A.depths,C)}z.add(1,intervalString)}},recursively_remove_reservations:function(y,B,C){const z=y.data("reservations"),A=[];let foundStart=false,maxDepths=0;if(z&&z.length>0){g.each(z,function(D,E){if(E){if(E===C||reservations[E].depths>=B){if(foundStart===false){foundStart=reservations[E].depths}foundStart=Math.min(foundStart,reservations[E].depths);changedAnyReservation=true;reservations[E].changed=true}else{A.push(E);maxDepths=Math.max(maxDepths,reservations[E].depths)}}})}y.data("reservations",A);if(foundStart!==false){n.recursively_remove_reservations(y.next(),foundStart,C)}},reservation_stop_edit:function(y){y.draggable("destroy").resizable("destroy");y.find(".title").attr("contenteditable","false")},reservation_allow_edit:function(y){y.draggable({snap:snappingEnabled?false:".reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",scope:"reservations",cancel:".title",revert:function(z,A){if(z){return z}g(this).data("uiDraggable").originalPosition={top:dragStartPosition.top-1,left:dragStartPosition.left};return !z},start:function(z,A){dragStartPosition=A.originalPosition;dragStartOffset=A.offset},drag:function(B,C){const D=parseInt(C.helper.attr("data-id"),10),z=reservations[D];let difference=interval/q.width*(C.position.left-dragStartPosition.left);if(snappingEnabled){const A=Math.round((C.position.left-dragStartPosition.left)/q.width);difference=A*interval;C.position.left=dragStartPosition.left+(A*q.width)}f.html(easyFormatTime(moment(z.arrival).add(difference,"seconds"))+" - "+easyFormatTime(moment(z.departure).add(difference,"seconds"))).css({top:mousePosY,left:Math.min(mousePosX-130,h.width()),display:"block"});if(dragSnapTop!==false){C.position.top=dragSnapTop-dragStartOffset.top+dragStartPosition.top}n.scroll_dragging()},stop:function(){f.css("display","none");if(scrollAction!==false){clearInterval(scrollAction);scrollAction=false;n.load_remaining()}}}).resizable({handles:"e, w",grid:snappingEnabled?[q.width,26]:false,minHeight:0,minWidth:4,start:function(z,A){A.originalElement.attr("style","left: "+A.originalElement.css("left")+";top: "+A.originalElement.css("top")+" !important;width: "+A.originalElement.css("width"))},resize:function(C,D){const E=parseInt(D.element.attr("data-id"),10),B=reservations[E],A=interval/q.width*(D.position.left-D.originalPosition.left),z=interval/q.width*(D.size.width);let message;if(D.position.left-D.originalPosition.left!==0){message=easyFormatTime(moment(B.arrival).add(A,"seconds"))}else{if(D.size.width-D.originalSize.width!==0){message=easyFormatTime(moment(B.arrival).add(z,"seconds"))}else{message=easyFormatTime(moment(B.arrival).add(A,"seconds"));message+=" - ";message+=easyFormatTime(moment(B.arrival).add(z,"seconds"))}}f.html(message).css({top:mousePosY,left:Math.min(mousePosX-130,h.width()),display:"block"})},stop:function(C,D){const E=parseInt(D.element.attr("data-id"),10),B=interval/q.width*(D.position.left-D.originalPosition.left),z=interval/q.width*(D.size.width),A={id:E,arrival:moment(reservations[E].arrival).add(B,"seconds"),departure:moment(reservations[E].arrival).add(B+z,"seconds"),resource:reservations[E].resource,space:reservations[E].space};if(x.resources[reservations[E].resource].availability_by!=="unit"||n.check_availability(A)){n.recursively_remove_reservation(reservations[E]);reservations[E].arrival=A.arrival;reservations[E].departure=A.departure;reservations[E].changed=true;n.draw_reservations()}else{D.helper.animate({width:D.originalSize.width,left:D.originalPosition.left},500,function(){})}f.css("display","none")}});y.find(".title").attr("contenteditable","true")},draw_reservation:function(B){const y=parseInt(B.id,10),E=moment(B.arrival),z=moment(B.departure),G=g('<div class="reservation">'),F=[],A=(((z.diff(E)/1000)/interval)*q.width);let didAdd=false,depths=0;changedAnyReservation=false;if(interval==="86400"){E.startOf("day");z.startOf("day")}else{E.startOf("hour");z.startOf("hour")}while(E<=z){const H=g('td[data-date="'+(E.unix())+'"][data-resource="'+B.resource+'"][data-space="'+B.space+'"]');if(H&&H.length>0){const D=H.data("reservations");if(D.length>0){g.each(D,function(I,J){if(J&&J!==y){if(reservations[J].arrival>B.arrival&&reservations[J].arrival<B.departure&&reservations[J].departure>B.arrival){n.recursively_remove_reservations(H,depths,J)}else{if(reservations[J].departure<=B.arrival||reservations[J].arrival>=B.departure){}else{F[reservations[J].depths]=1}}}})}if(didAdd===false){G.css("left",((B.arrival.diff(E)/1000/interval*q.width)-1)+"px");didAdd=H}if(g.inArray(y,D)<0){D.push(y);H.data("reservations",D)}}E.add(1,intervalString)}if(didAdd===false){reservations[y].changed=false;return true}if(changedAnyReservation){return false}G.html('<span class="wrapper"><span class="sticky"><span class="id">'+y+'</span><div class="title">'+B.title+"</div></span></span>").css("min-width",A+"px").css("max-width",A+"px").css("top","0px").css("position","absolute").addClass(B.status).attr("data-tip",B.id).attr("data-id",B.id);const C=w.find('.reservation[data-id="'+y+'"]').remove();if(C.length>0){G.addClass("fade-in-fast")}else{if(B.fresh){delete B.fresh}else{G.addClass("no-animation")}}if(editMode&&editMode.id===y){a.draw_reservation(B);n.reservation_allow_edit(G);h.find(".reservation.selected").removeClass("selected");G.addClass("selected")}didAdd.append(G);while(F[depths]===1){depths++}if(depths>0){if(didAdd.height()<q.height+(q.height-3)*depths){didAdd.height(q.height+(q.height-3)*depths)}G.css("top",(q.height-3)*depths+"px")}B.depths=depths;B.changed=false;reservations[y]=B;return didAdd},add_reservation:function(y,z){const A=parseInt(y.id,10);y.id=A;y.arrival=moment(y.arrival);y.departure=moment(y.departure);y.resource=parseInt(y.resource,10);y.space=parseInt(y.space,10);if(typeof reservations[A]==="undefined"){y.changed=true;y.fresh=true}else{y.changed=z?true:reservations[A].changed;y.depths=reservations[A].depths}reservations[A]=y},check_availability:function(y){const z=parseInt(y.id,10);let available=true;g.each(reservations,function(A,B){if(B&&B.resource===y.resource&&B.space===y.space&&B.id!==z&&(y.arrival<B.departure&&y.departure>B.arrival)){available=false;return false}});return available},sync_cell_heights:function(){let tbodyIndex,trIndex;d.each(function(y,z){tbodyIndex=(g(z).index()/2)-0.5;g(z).children().each(function(A,B){trIndex=g(B).index();g(B).height(g(b[tbodyIndex]).children().eq(g(B).index()).height())})})},set_element_as_droppable:function(y){y.droppable({scope:"reservations",tolerance:"pointer",drop:function(A,B){let $this=g(this);if(lastHover&&lastHover.getAttribute("data-space")){$this=g(lastHover)}const D=parseInt(B.draggable.attr("data-id"),10),C=interval/q.width*(B.position.left-dragStartPosition.left),z={id:D,arrival:moment(reservations[D].arrival).add(C,"seconds"),departure:moment(reservations[D].departure).add(C,"seconds"),resource:parseInt($this.attr("data-resource"),10),space:parseInt($this.attr("data-space"),10)};if(x.resources[z.resource].availability_by!=="unit"||n.check_availability(z)){n.recursively_remove_reservation(reservations[D]);reservations[D].arrival=z.arrival;reservations[D].departure=z.departure;reservations[D].resource=z.resource;reservations[D].space=z.space;reservations[D].changed=true;if(reservations[D].status==="pending"){reservations[D].status="approved"}B.helper.remove();n.draw_reservations()}}})},generate_column:function(A,D){const y=A.day()===0?6:A.day()-1;let headerMain,headerClass="",tbodyNumber=0,i=0,todayMarker=false;if(interval==="86400"){headerMain=g('<th><div class="date"><div>'+easyFormatDate(A,"d")+"<span>"+er_date_picker_params.day_names_min[y]+'</span></div></div><div class="marker"></div></th>');if(A.date()===1){headerClass="first";headerMain.append(g('<div class="first">'+er_date_picker_params.month_names[A.month()]+"</div>"))}}else{const B=er_both_params.time_format.charAt(er_both_params.time_format.length-1);let description="00";if(B==="a"){description=A.hours()>=12?"pm":"am"}else{if(B==="A"){description=A.hours()>=12?"PM":"AM"}}headerMain=g('<th><div class="date"><div>'+easyFormatDate(A,"H")+"<span>"+description+'</span></div></div><div class="marker"></div></th>');if(A.hours()===0){headerClass="first";headerMain.append(g('<div class="first">'+A.date()+" "+er_date_picker_params.day_names[y]+"</div>"))}}if(A.date()===today.date()&&A.month()===today.month()&&A.year()===today.year()&&(interval==="86400"||A.hour()===today.hour())){const C=moment(),z=g('<div class="overlay"></div>');let difference;todayMarker=g('<div class="today"></div>');if(interval==="86400"){difference=(q.width/86400*((C.hour()*3600)+(C.minute()*60)))-1}else{difference=(q.width/3600*(C.minute()*60))-1}todayMarker.css("left",difference);z.css("left",difference).css("width",difference).css("margin-left",-difference);headerMain.append(todayMarker).append(z);headerClass+=" today"}else{if(A<today){headerClass+=" past"}}if((A.day()===0||A.day()===6)){headerClass+=" weekend"}headerMain.addClass(headerClass).attr("data-date",A.unix());headerClass+=" loading";if(D){c.prepend(headerMain)}else{c.append(headerMain)}g.each(x.resources,function(I,G){const H=g('<th><div class="count"></div></th>').addClass(headerClass).attr("data-resource",I).attr("data-date",A.unix());if(D){g(u[tbodyNumber]).find("tr").prepend(H)}else{g(u[tbodyNumber]).find("tr").append(H)}for(i=1;i<=(G.availability_by==="unit"?G.quantity:1);i++){const F=g('<td class="cell"></td>').addClass(headerClass).attr("data-resource",I).data("reservations",[]).attr("data-space",i).attr("data-date",A.unix());if(todayMarker){F.append(todayMarker.clone());todayMarker=false}if(D){g(b[tbodyNumber]).find("tr:nth-child("+i+")").prepend(F)}else{g(b[tbodyNumber]).find("tr:nth-child("+i+")").append(F)}if(editMode){n.set_element_as_droppable(F)}}tbodyNumber++});if(D){if(lastQueryStart===0||lastQueryStart.valueOf()-(interval*1000*10)>A.valueOf()){n.load_data(start,lastQueryStart,{});lastQueryStart=moment(start)}}else{if(lastQueryEnd.valueOf()+(interval*1000*10)<A.valueOf()){const E=moment(end).add(interval,"seconds");n.load_data(lastQueryEnd,E,{});lastQueryEnd=E}}}};m.insertAfter("hr.wp-header-end");f.insertAfter("hr.wp-header-end");o.hide();if(x.default_hourly==="on"){interval="3600";intervalString="hours"}if(interval==="86400"){today.startOf("day");s.find(".daily").addClass("active")}else{today.startOf("hour");s.find(".hourly").addClass("active");h.addClass("hourly");q.width=48}setTimeout(function(){a.draw_pending();a.display_calendar();m.css("display","flex");if(x.reservation_arrival){n.jump_to_date(moment(x.reservation_arrival))}else{n.init()}},0);if(x.reservation_resource>0){t.find('.resource-handler:not([data-resource="'+x.reservation_resource+'"],.retracted),.resource-handler.retracted[data-resource="'+x.reservation_resource+'"]').click()}}(jQuery,er_timeline_params));