(function(h,D){var g=h(".er-timeline-tooltip"),m=h(".er-timeline"),p=h("#timeline-datepicker"),l=m.find("div.timeline"),t=m.find("div.header"),u=m.find("div.resources table"),z=t.find(".date"),v=l.find("table"),k=l.find("thead tr"),a=v.find("tbody"),y=[],x=new Date(),i=new Date(),e=false,F=false,f=false,o=false,r=false,d=0,b=0,C=true,B=false,c=false,E=false,n={height:27,width:96},j=0,q=0,A=0,w=D.default_interval;m.insertAfter("hr.wp-header-end");g.insertAfter("hr.wp-header-end");t.bind("click",function(){p.datepicker("show")});p.bind("change",function(){i=h(this).datepicker("getDate");s.init()});l.find("thead").on({mousedown:function(G){B=l.scrollLeft()+G.pageX}});h(window).mouseup(function(){k.css("cursor","grab");clearInterval(c);c=false;B=false;s.clear_scroll_timeout()});m.mousemove(function(G){d=G.pageX;b=G.pageY;if(B&&G.which===1){l.scrollLeft(B-G.pageX<1?1:B-G.pageX);if(E===false){k.css("cursor","grabbing");s.start_scroll_add_interval()}}if(j!==G.target){j=G.target;if(j.getAttribute("data-date")){s.highlight_current(new Date(parseInt(G.target.getAttribute("data-date"),10)))}if(j.getAttribute("data-space")){o=h(j).offset().top}else{if(j.getAttribute("data-id")){o=h(j).parent().offset().top}}}}).mouseleave(function(){k.css("cursor","grab");clearInterval(c);c=false;B=false;s.clear_scroll_timeout()}).on("mousedown",".next",function(){if(c===false){c=setInterval(function(){if(c!==false){l.scrollLeft(l.scrollLeft()+n.width);s.start_scroll_add_interval()}},100)}}).on("mousedown",".prev",function(){if(c===false){c=setInterval(function(){if(c!==false){l.scrollLeft(l.scrollLeft()-n.width);s.start_scroll_add_interval()}},100)}});l.scroll(function(){if(c!==false){k.css("cursor","grabbing")}});var s={init:function(){if(w==="86400"){i.setHours(0,0,0,0)}else{i.setHours(i.getHours(),0,0,0)}l.scrollLeft(1);var G=i,H;s.set_current_date(x);v.find("td,th").remove();G.setTime(G.getTime()-(10*w*1000));A=G.getTime();q=G.getTime();for(H=0;H<50;H++){e=new Date(G.getTime()+(H*w*1000));s.generate_column(e)}s.load_remaining();l.scrollLeft(k.find("th:nth-child(9)").offset().left-l.offset().left+l.scrollLeft()+1)},slide_current:function(H){var G=k.find("th:nth-child("+(Math.round(l.scrollLeft()/n.width)+(3))+")");s.highlight_current(new Date(G.data("date")))},highlight_current:function(G){s.set_current_date(G);h(".er-timeline .current").removeClass("current");h('*[data-date="'+G.getTime()+'"]').addClass("current")},set_current_date:function(G){if(w==="3600"){z.html(G.getDate()+" "+er_date_picker_params.month_names[G.getMonth()]+" "+G.getFullYear())}else{z.html(er_date_picker_params.month_names[G.getMonth()]+" "+G.getFullYear())}p.val(G.getDate()+"."+(G.getMonth()+1)+"."+G.getFullYear())},start_scroll_add_interval:function(){if(E===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){E=setInterval(function(){if(E!==false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){s.add_new_column(l.scrollLeft()<2)}},38)}},add_new_column:function(G){if(G){i.setTime(i.getTime()-(w*1000));s.generate_column(i,true);s.set_current_date(i);v.find("th:last-child,td:last-child").remove();A-=(w*1000);e.setTime(e.getTime()-(w*1000))}else{e.setTime(e.getTime()+(w*1000));s.generate_column(e);s.set_current_date(e);v.find("th:first-child").remove();v.find("td:first-child").each(function(){var H=h(this).data("reservations");if(H&&H.length>0){h.each(H,function(I,J){if(y[J]&&typeof y[J]!=="undefined"){y[J].changed=true}})}}).remove();q+=(w*1000);i.setTime(i.getTime()+(w*1000))}},clear_scroll_timeout:function(){if(E!==false){clearInterval(E);E=false;s.load_remaining()}},load_remaining:function(){if(q===0||q>i.getTime()){s.load_data(i,new Date(q));q=i.getTime()}else{if(A<e.getTime()){s.load_data(new Date(A),new Date(e.getTime()+(w*1000)));A=e.getTime()}else{}}},load_data:function(H,G){h.ajax({url:D.ajax_url,data:{action:"easyreservations_timeline_data",security:D.nonce,start:H.getDate()+"."+(H.getMonth()+1)+"."+H.getFullYear(),start_hour:H.getHours(),end:G.getDate()+"."+(G.getMonth()+1)+"."+G.getFullYear(),end_hour:G.getHours(),interval:w},type:"POST",success:function(I){if(I.data){h.each(I.data,function(L,K){var J=D.resources[L].quantity;h.each(K,function(Q,M){var O=new Date(parseInt(Q,10)*1000),N="",P="";if(M<0){N="unavailable";P=0}else{P=J-M}h('td[data-date="'+(O.getTime()+(O.getTimezoneOffset()*1000*60))+'"][data-resource="'+L+'"]').removeClass("loading").addClass(N);h('tr.resource td[data-date="'+(O.getTime()+(O.getTimezoneOffset()*1000*60))+'"][data-resource="'+L+'"]').html('<div style="pointer-events:none">'+P+"</div>").addClass(M==J?"unavailable":"")})})}if(I.reservations){h.each(I.reservations,function(J,K){K.changed=true;s.add_reservation(K)});s.draw_reservations()}}})},draw_reservations:function(){var G=[];h.each(y,function(H,I){if(I&&I.changed){G.push(I.id)}});G.sort(function(I,H){return y[I].arrival<y[H].arrival?-1:1});h.each(G,function(H,I){if(I){if(!s.draw_reservation(y[I])){s.draw_reservations();return false}}})},recursively_remove_reservation:function(J){var K=parseInt(J.id,10),I=new Date(J.arrival),H=new Date(J.departure);if(w==="86400"){I.setHours(0,0,0);H.setHours(0,0,0)}else{I.setHours(I.getHours(),0,0);H.setHours(H.getHours(),0,0)}while(I<=H){var G=h('td[data-date="'+(I.getTime())+'"][data-resource="'+J.resource+'"][data-space="'+J.space+'"]');if(G.length>0){s.recursively_remove_reservations(G,J.depths,K)}I.setTime(I.getTime()+(w*1000))}return false},recursively_remove_reservations:function(H,L,M){var G=H.data("reservations"),K=[],I=false,J=0;if(G&&G.length>0){h.each(G,function(N,O){if(O){if(O===M||y[O].depths>=L){if(I===false){I=y[O].depths}I=Math.min(I,y[O].depths);r=true;y[O].changed=true}else{K.push(O);J=Math.max(J,y[O].depths)}}})}H.data("reservations",K);H.height(n.height+n.height*J);if(I!==false){return s.recursively_remove_reservations(H.next(),I,M)}return true},draw_reservation:function(I){var G=parseInt(I.id,10),J=new Date(I.arrival),K=new Date(I.departure),L=h('<div class="reservation">'),H=(I.departure-I.arrival),N=(((H/1000)/w)*n.width)-(w==="86400"?2:1),Q=false,R=[],O=0;r=false;h('.reservation[data-id="'+G+'"]').remove();if(w==="86400"){J.setHours(0,0,0);K.setHours(0,0,0)}else{J.setHours(J.getHours(),0,0);K.setHours(K.getHours(),0,0)}while(J<=K){var P=h('td[data-date="'+(J.getTime())+'"][data-resource="'+I.resource+'"][data-space="'+I.space+'"]');if(P&&P.length>0){var M=P.data("reservations");if(M.length>0){h.each(M,function(S,T){if(T&&T!==G){if(y[T].arrival>I.arrival&&y[T].arrival<I.departure&&y[T].departure>I.arrival){s.recursively_remove_reservations(P,O,T)}else{if(y[T].departure<=I.arrival||y[T].arrival>=I.departure){}else{R[y[T].depths]=1}}}})}if(Q===false){L.css("left",((((I.arrival-J.getTime())/1000)/w)*n.width)-1+"px");Q=P}if(h.inArray(G,M)<0){M.push(G);P.data("reservations",M)}}J.setTime(J.getTime()+(w*1000))}if(Q===false){return true}else{if(r){return false}else{L.html('<span class="wrapper"><span>#'+G+" "+I.title+"</span></span>").draggable({snap:C?false:"td.cell,.reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",containment:a,revert:function(S,T){if(S){return S}if(h(this).data("uiDraggable")){}h(this).data("uiDraggable").originalPosition={top:F.top-1,left:F.left};return !S},stack:".reservation",scope:"reservations",start:function(S,T){F=T.originalPosition;f=T.offset},drag:function(U,V){var Y=parseInt(V.helper.attr("data-id"),10),S=y[Y],X=w/n.width*(V.position.left-F.left),T=d-l.offset().left;if(C){var W=Math.round((V.position.left-F.left)/n.width);X=W*w;V.position.left=F.left+(W*n.width)}g.html(easyFormatTime(new Date(S.arrival+(X*1000)))+" - "+easyFormatTime(new Date(S.departure+(X*1000)))).css({top:b,left:Math.min(d-130,l.width())}).show();if(o!==false){V.position.top=o-f.top+F.top+1}if(T<10||l.width()-T<10){if(c===false){c=setInterval(function(){if(c!==false){if(E===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){s.add_new_column(l.scrollLeft()<2);F.left=F.left+(l.scrollLeft()<2?n.width:n.width*-1)}l.scrollLeft(Math.max(1,l.scrollLeft()+(d-l.offset().left<10?n.width*-1:n.width)))}},130)}}else{if(c!==false){clearInterval(c);c=false;s.load_remaining()}}},stop:function(){g.hide();if(c!==false){clearInterval(c);c=false;s.load_remaining()}}}).resizable({handles:"e, w",grid:C?[96,28]:false,maxWidth:n.width*50,scroll:0,minHeight:0,minWidth:4,start:function(T,Z){var U=parseInt(Z.originalElement.attr("data-id"),10),V=h(this),aa=Z.originalElement.parent(),Y=h(j).hasClass("ui-resizable-w");if(er_both_params.resources[y[U].resource].availability_by==="unit"){var X=aa.data("reservations"),S=[],W;if(Y&&X.length>0){X.reverse()}h.each(X,function(ab,ac){if(W||ac===U){W=true;S.push(ac)}});while(aa.length>0){if(S.length>0){h.each(S,function(ab,ac){if(ac!==U){if(Y){}else{}aa={length:0};return false}})}if(aa.length>0){if(Y){aa=aa.prev()}else{aa=aa.next()}S=aa.data("reservations")}}}Z.helper.attr("style","left: "+Z.helper.css("left")+";top: "+Z.helper.css("top")+";width: "+Z.helper.css("width"))},resize:function(V,X){var Y=parseInt(X.element.attr("data-id"),10),T=y[Y],S=w/n.width*(X.position.left-X.originalPosition.left),W=w/n.width*(X.size.width+2),U="";if(X.position.left-X.originalPosition.left!==0){U=easyFormatTime(new Date(T.arrival+(S*1000)))}else{if(X.size.width-X.originalSize.width!==0){U=easyFormatTime(new Date(T.arrival+(W*1000)))}else{U=easyFormatTime(new Date(T.arrival+(S*1000)));U+=" - ";U+=easyFormatTime(new Date(T.arrival+(W*1000)))}}g.html(U).css({top:b,left:Math.min(d-130,l.width())}).show()},stop:function(U,W){var X=parseInt(W.element.attr("data-id"),10),S=w/n.width*(W.position.left-W.originalPosition.left),V=w/n.width*(W.size.width+2),T={id:X,arrival:y[X].arrival+(S*1000),departure:y[X].arrival+(S*1000)+(V*1000),resource:y[X].resource,space:y[X].space};if(er_both_params.resources[y[X].resource].availability_by!=="unit"||s.check_availability(T)){s.recursively_remove_reservation(y[X]);y[X].arrival=T.arrival;y[X].departure=T.departure;y[X].changed=true;s.draw_reservations()}else{W.helper.animate({width:W.originalSize.width,left:W.originalPosition.left},500,function(){})}g.hide()}}).css("min-width",N+"px").css("max-width",N+"px").css("top","0px").css("position","absolute").attr("data-tip",I.id).attr("data-id",I.id);Q.append(L);while(R[O]===1){O++}if(O>0){if(Q.height()<n.height+n.height*O){Q.height(n.height+n.height*O+1)}L.css("top",(n.height+1)*O+"px")}I.depths=O;I.changed=false;console.log("did draw "+G+"at depths "+O);y[G]=I}}return Q},add_reservation:function(G){var H=parseInt(G.id,10);if(!h.isNumeric(G.arrival)){G.id=H;G.arrival=new Date(G.arrival).getTime();G.departure=new Date(G.departure).getTime();G.resource=parseInt(G.resource,10);G.space=parseInt(G.space,10)}G.changed=true;y[H]=G},check_availability:function(G){var I=parseInt(G.id,10),H=true;h.each(y,function(J,K){if(K&&K.resource===G.resource&&K.space===G.space&&K.id!==I&&(G.arrival<K.departure&&G.departure>K.arrival)){console.log("checkAvailabilty false because of");console.log(K);H=false;return false}});return H},generate_column:function(L,K){var H="",P="",I=1,M=0,N=L.getDay()===0?6:L.getDay()-1;if(w==="86400"){H=h('<th><div class="date"><div>'+easyFormatDate(L,"d")+"</div><span>"+er_date_picker_params.day_names_min[N]+"</span></div></th>");if(L.getDate()===1){P="first"}}else{H=h("<th>"+easyFormatDate(L,"H")+"</th>");if(L.getHours()===0){P="first"}}if(P==="first"){H.append(h('<div class="first-of-month"></div>'))}if(L.getDate()===x.getDate()&&L.getMonth()===x.getMonth()&&L.getFullYear()===x.getFullYear()&&(w==="86400"||L.getHours()===x.getHours())){var O=h('<div class="today"></div>'),G=h('<div class="overlay"></div>'),J=0;if(w==="86400"){J=n.width/86400*(x.getHours()*3600+x.getMinutes()*60)}else{J=n.width/3600*(x.getMinutes()*60)}O.css("left",J);G.css("left",J).css("width",J).css("margin-left",-J);H.append(O).append(G);P+=" today"}else{if(L<x){P+=" past"}}if(w==="86400"&&(L.getDay()===0||L.getDay()===6)){P+=" weekend"}H.addClass(P).attr("data-date",L.getTime()+(L.getTimezoneOffset()*1000*60)+3600000);P+=" loading";if(K){k.prepend(H)}else{k.append(H)}h.each(D.resources,function(T,S){var R=h('<td class="resource"><div style="height:20px;pointer-events:none"></div></td>').addClass(P).attr("data-resource",T).attr("data-date",L.getTime()+(L.getTimezoneOffset()*1000*60)+3600000);if(K){a.find("tr:nth-child("+I+")").prepend(R)}else{a.find("tr:nth-child("+I+")").append(R)}for(M=1;M<=(S.availability_by==="unit"?S.quantity:1);M++){var Q=h('<td class="cell"></td>').addClass(P).attr("data-resource",T).data("reservations",[]).attr("data-space",M).attr("data-date",L.getTime()+(L.getTimezoneOffset()*1000*60)+3600000);I++;if(K){a.find("tr:nth-child("+I+")").prepend(Q)}else{a.find("tr:nth-child("+I+")").append(Q)}Q.droppable({scope:"reservations",tolerance:"pointer",drop:function(W,X){var U=h(this);if(j.getAttribute("data-space")){U=h(j)}console.log(X.helper.position());console.log(X.helper.offset());console.log(X);var Z=parseInt(X.draggable.attr("data-id"),10),Y=w/n.width*(X.position.left-F.left),V={id:Z,arrival:y[Z].arrival+(Y*1000),departure:y[Z].departure+(Y*1000),resource:parseInt(U.attr("data-resource"),10),space:parseInt(U.attr("data-space"),10)};console.log(new Date(V.arrival));if(er_both_params.resources[V.resource].availability_by!=="unit"||s.check_availability(V)){s.recursively_remove_reservation(y[Z]);y[Z].arrival=V.arrival;y[Z].departure=V.departure;y[Z].resource=V.resource;y[Z].space=V.space;y[Z].changed=true;X.helper.remove();s.draw_reservations()}else{}},over:function(U,V){}})}I++});if(K){if(q===0||q-(w*1000*10)>L.getTime()){s.load_data(i,new Date(q));q=L.getTime()}}else{if(A+(w*1000*10)<L.getTime()){s.load_data(new Date(A),new Date(e.getTime()+(w*1000)));A=L.getTime()}}}};s.init()})(jQuery,er_timeline_params);