(function(B,J){var C=B(".er-timeline-tooltip"),h=B(".er-timeline"),y=B("#timeline-datepicker"),m=h.find("div.sidebar"),g=h.find("div.timeline"),d=h.find("div.header"),D=h.find("div.resources table tbody"),u=d.find(".date"),q=g.find("table"),i=q.find("thead.main tr"),v=q.find("thead:not(.main)"),F=q.find("tbody"),c=[],w=false,j=new Date(),s=new Date(),n=false,E=false,H=false,z=false,p=false,e=0,b=0,A=true,f=false,x=false,t=false,l={height:32,width:96},o=0,I=0,G=0,a=J.default_interval;d.on("click",".expand-sidebar",function(){m.addClass("expanded").show();B(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){m.removeClass("expanded").hide(300,"linear");B(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".hourly",function(){if(!B(this).hasClass("active")){d.find(".daily").removeClass("active");B(this).addClass("active");s=new Date(w.getTime());a="3600";r.init()}}).on("click",".daily",function(){if(!B(this).hasClass("active")){d.find(".hourly").removeClass("active");B(this).addClass("active");s=new Date(w.getTime());a="86400";r.init()}}).on("click",".pending",function(){k.toggle_pending()}).on("click",".date",function(){k.toggle_calendar()}).on("click",".today",function(){r.jump_to_date(j)});y.bind("change",function(K){r.jump_to_date(B(this).datepicker("getDate"))});i.on("mousedown","th",function(K){f=g.scrollLeft()+K.pageX});B(window).mouseup(function(){i.css("cursor","grab");clearInterval(x);x=false;f=false;r.clear_scroll_add_interval()});h.mousemove(function(K){e=K.pageX;b=K.pageY;if(f&&K.which===1){g.scrollLeft(f-K.pageX<1?1:f-K.pageX);r.set_current_date();if(t===false){i.css("cursor","grabbing");r.start_scroll_add_interval()}}if(o!==K.target){o=K.target;if(o.getAttribute("data-date")){r.highlight_current(new Date(parseInt(K.target.getAttribute("data-date"),10)))}if(o.getAttribute("data-space")){z=B(o).offset().top}else{if(o.getAttribute("data-id")){z=B(o).parent().offset().top}}}}).mouseleave(function(){i.css("cursor","grab");clearInterval(x);x=false;f=false;r.clear_scroll_add_interval()}).on("mousedown",".next",function(){if(x===false){r.add_new_column();r.set_current_date();x=setInterval(function(){r.add_new_column();r.set_current_date()},100)}}).on("mousedown",".prev",function(){if(x===false){r.add_new_column(true);r.set_current_date();x=setInterval(function(){r.add_new_column(true);r.set_current_date()},100)}}).on("click",".resource-handler",function(){var L=B(this).parent().parent().parent().next(),K=L.index()/2-1;if(B(this).hasClass("retracted")){B(this).removeClass("retracted");B(F[K]).show();L.show()}else{B(this).addClass("retracted");B(F[K]).hide();L.hide()}}).on("click",".reservation",function(){var K=parseInt(B(this).attr("data-id"),10);g.find(".reservation.selected").removeClass("selected");B(this).addClass("selected");k.display_reservation(c[K])}).on("click",".title",function(K){});var k={init:function(){if(J.pending&&J.pending.length>0){d.find(".pending").html("<span>"+J.pending.length+"</span>");var K=m.find("> .pending").find(".reservations");K.html("");B.each(J.pending,function(L,N){var M=B('<div class="pending-reservation">'),P=parseInt(N.resource,10),O=false;N.arrival=new Date(N.arrival);N.departure=new Date(N.departure);if(!N.title){N.title="No title"}M.html("<span>#"+N.id+" "+N.title+"</span>");M.bind("click",function(){r.jump_to_date(N.arrival);if(P>0){h.find('.resource-handler:not([data-resource="'+N.resource+'"],.retracted)').click()}B.each(J.resources,function(Q,S){if(!O&&(P===0||P===S.ID)){if(S.availability_by==="unit"){N.resource=S.ID;N.space=1;O=true;return false}else{N.resource=S.ID;for(var R=1;R<=S.quantity;R++){N.space=1;if(r.check_availability(N)){O=true;break}}}}});if(O){N.status="approved";r.add_reservation(N);r.draw_reservations();J.pending.splice(L);B(this).remove();k.init()}});K.append(M)})}else{d.find(".pending").html("");m.find("> .pending").find(".reservations").html(J.i18n_no_pending)}k.display_calendar()},is_open:function(){return m.hasClass("expanded")},open:function(){if(!k.is_open()){d.find(".expand-sidebar").click()}},close:function(){if(k.is_open()){d.find(".contract-sidebar").click()}},toggle:function(){if(k.is_open()){d.find(".contract-sidebar").click();return false}else{d.find(".expand-sidebar").click();return true}},toggle_calendar:function(){if(!m.find("> .calendar").hasClass("visible")){k.display_calendar();k.open()}else{k.toggle()}},toggle_pending:function(){if(!m.find("> .pending").hasClass("visible")){k.display_pending();k.open()}else{k.toggle()}},clear:function(){m.find("> .visible").hide().removeClass("visible")},display_calendar:function(){var K=m.find("> .calendar");k.clear();K.show().addClass("visible")},display_pending:function(){var K=m.find("> .pending");k.clear();K.show().addClass("visible")},display_reservation:function(M){var L=m.find("> .reservation-details"),K=L.find(".reservation-header");K.find(".title").html(M.title);K.find(".reservation-status").attr("class","reservation-status status-"+M.status);L.find(".reservation-preview").attr("data-reservation-id",M.id).data("reservation-data",false);L.find(".input-box.status- "+M.status).remove().addClass("reservation-status");k.clear();L.show().addClass("visible");k.open()}};var r={init:function(){j=new Date();c=[];w=false;if(a==="86400"){j.setHours(0,0,0,0);s.setHours(0,0,0,0)}else{j.setHours(j.getHours(),0,0,0);if(j.getDate()===s.getDate()&&j.getMonth()===s.getMonth()&&j.getFullYear()===s.getFullYear()){s.setHours(j.getHours(),0,0,0)}else{s.setHours(0,0,0,0)}}q.find("td,th").remove();s=r.manipulate_date_without_offset(s,(15*a*1000)*-1);G=new Date(s.getTime());I=new Date(s.getTime());for(var K=0;K<50;K++){n=r.manipulate_date_without_offset(s,K*a*1000);r.generate_column(n,false)}r.load_remaining();g.scrollLeft(i.find("th:nth-child(15)").offset().left-g.offset().left+g.scrollLeft()+1);r.set_current_date();r.sync_cell_heights()},manipulate_date_without_offset:function(K,L){var M=new Date(K.getTime()+L);return new Date(M.getTime()+M.getTimezoneOffset()*1000*60-K.getTimezoneOffset()*1000*60)},highlight_current:function(K){q.find("td.hover, th.hover").removeClass("hover");q.find('td[data-date="'+K.getTime()+'"], th[data-date="'+K.getTime()+'"]').addClass("hover")},set_current_date:function(){var K=r.manipulate_date_without_offset(s,((g.scrollLeft()/l.width+1)*a*1000));if(a==="3600"){K.setHours(K.getHours(),0,0,0)}else{K.setHours(0,0,0,0)}if(!w||K.getDate()!==w.getDate()||K.getMonth()!==w.getMonth()||K.getFullYear()!==w.getFullYear()){w=K;if(a==="3600"){u.html(w.getDate()+" "+er_date_picker_params.month_names[w.getMonth()]+" "+w.getFullYear())}else{u.html(er_date_picker_params.month_names[w.getMonth()]+" "+w.getFullYear())}i.find("th.current").removeClass("current");i.find('th[data-date="'+w.getTime()+'"]').addClass("current");y.datepicker("setDate",w)}else{if(a==="3600"&&K.getHours()!==w.getHours()){w=K;i.find("th.current").removeClass("current");i.find('th[data-date="'+w.getTime()+'"]').addClass("current")}}},start_scroll_add_interval:function(){if(t===false&&(g.scrollLeft()<2||g[0].scrollWidth-(g.width()+g.scrollLeft())<2)){t=setInterval(function(){if(t!==false&&(g.scrollLeft()<2||g[0].scrollWidth-(g.width()+g.scrollLeft())<2)){r.add_new_column(g.scrollLeft()<2);r.set_current_date()}},38)}},clear_scroll_add_interval:function(){if(t!==false){clearInterval(t);t=false;r.load_remaining()}},jump_to_date:function(K){if(K<s||K>n){s=K;r.init()}else{var M=(w.getTime()-K.getTime()+K.getTimezoneOffset()*1000*60-w.getTimezoneOffset()*1000*60)/(a*1000);for(var L=1;L<=Math.abs(M);L++){r.add_new_column(M>0)}r.set_current_date()}},add_new_column:function(K){if(K){s=r.manipulate_date_without_offset(s,a*1000*-1);r.generate_column(s,true);q.find("th:last-child,td:last-child").remove();G=r.manipulate_date_without_offset(G,a*1000*-1);n=r.manipulate_date_without_offset(n,a*1000*-1)}else{n=r.manipulate_date_without_offset(n,a*1000);r.generate_column(n,false);q.find("th:first-child").remove();q.find("td:first-child").each(function(){var L=B(this).data("reservations");if(L&&L.length>0){B.each(L,function(M,N){if(c[N]&&typeof c[N]!=="undefined"){c[N].changed=true}})}}).remove();I=r.manipulate_date_without_offset(I,a*1000);s=r.manipulate_date_without_offset(s,a*1000)}r.sync_cell_heights()},load_remaining:function(){if(I===0||I>s){r.load_data(s,I);I=new Date(s.getTime())}else{if(G<n){var K=r.manipulate_date_without_offset(n,a*1000);r.load_data(G,K);G=K}else{}}},load_data:function(L,K){B.ajax({url:J.ajax_url,data:{action:"easyreservations_timeline_data",security:J.nonce,start:L.getDate()+"."+(L.getMonth()+1)+"."+L.getFullYear(),start_hour:L.getHours(),end:K.getDate()+"."+(K.getMonth()+1)+"."+K.getFullYear(),end_hour:K.getHours(),interval:a},type:"POST",success:function(M){if(M.data){B.each(M.data,function(P,O){var N=J.resources[P].quantity;B.each(O,function(U,Q){var S=new Date(parseInt(U,10)*1000),R="",T;if(Q<0){R="unavailable";T=0}else{T=N-Q}F.find('td[data-date="'+(S.getTime()+(S.getTimezoneOffset()*1000*60))+'"][data-resource="'+P+'"]').removeClass("loading").addClass(R);v.find('th[data-date="'+(S.getTime()+(S.getTimezoneOffset()*1000*60))+'"][data-resource="'+P+'"]').html("<div><span>"+T+"</span></div>").addClass(parseInt(Q,10)===N?"unavailable":"")})})}if(M.reservations){B.each(M.reservations,function(N,O){r.add_reservation(O)});r.draw_reservations()}}})},draw_reservations:function(){var K=[],L=true;B.each(c,function(M,N){if(N&&N.changed&&N.status!=="pending"){K.push(N.id)}});K.sort(function(N,M){return c[N].arrival<c[M].arrival?-1:1});B.each(K,function(M,N){if(N){if(!r.draw_reservation(c[N])){r.draw_reservations();L=false;return false}}});if(L&&K.length>0){r.sync_cell_heights()}},recursively_remove_reservation:function(N){var O=parseInt(N.id,10),M=new Date(N.arrival.getTime()),L=new Date(N.departure.getTime());if(a==="86400"){M.setHours(0,0,0);L.setHours(0,0,0)}else{M.setHours(M.getHours(),0,0);L.setHours(L.getHours(),0,0)}while(M<=L){var K=B('td[data-date="'+(M.getTime())+'"][data-resource="'+N.resource+'"][data-space="'+N.space+'"]');if(K.length>0){r.recursively_remove_reservations(K,N.depths,O)}M=r.manipulate_date_without_offset(M,a*1000)}},recursively_remove_reservations:function(L,P,Q){var K=L.data("reservations"),O=[],M=false,N=0;if(K&&K.length>0){B.each(K,function(R,S){if(S){if(S===Q||c[S].depths>=P){if(M===false){M=c[S].depths}M=Math.min(M,c[S].depths);p=true;c[S].changed=true}else{O.push(S);N=Math.max(N,c[S].depths)}}})}L.data("reservations",O);if(M!==false){r.recursively_remove_reservations(L.next(),M,Q)}},set_draggable:function(K){K.draggable({snap:A?false:"td.cell,.reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",stack:".reservation",scope:"reservations",cancel:".title",revert:function(L,M){if(L){return L}B(this).data("uiDraggable").originalPosition={top:E.top-1,left:E.left};return !L},start:function(L,M){E=M.originalPosition;H=M.offset},drag:function(O,P){var R=parseInt(P.helper.attr("data-id"),10),L=c[R],Q=a/l.width*(P.position.left-E.left),M=e-g.offset().left;if(A){var N=Math.round((P.position.left-E.left)/l.width);Q=N*a;P.position.left=E.left+(N*l.width)}C.html(easyFormatTime(r.manipulate_date_without_offset(L.arrival,Q*1000))+" - "+easyFormatTime(r.manipulate_date_without_offset(L.departure,Q*1000))).css({top:b,left:Math.min(e-130,g.width()),display:"block"});if(z!==false){P.position.top=z-H.top+E.top}if((M>0&&M<15)||g.width()-M<15){if(x===false){x=setInterval(function(){if(x!==false){var S=e-g.offset().left;if(t===false&&((S>0&&S<15)||g.width()-S<15)){r.add_new_column(S<15);E.left=E.left+(S<15?l.width:l.width*-1)}g.scrollLeft(Math.max(1,g.scrollLeft()+(S<15?l.width*-1:l.width)))}},130)}}else{if(x!==false){clearInterval(x);x=false;r.load_remaining()}}},stop:function(){C.css("display","none");if(x!==false){clearInterval(x);x=false;r.load_remaining()}}})},draw_reservation:function(M){var K=parseInt(M.id,10),N=new Date(M.arrival.getTime()),P=new Date(M.departure.getTime()),Q=B('<div class="reservation">'),L=(M.departure.getTime()-M.arrival.getTime()),S=(((L/1000)/a)*l.width)-2,V=false,W=[],T=0;p=false;if(a==="86400"){N.setHours(0,0,0);P.setHours(0,0,0)}else{N.setHours(N.getHours(),0,0);P.setHours(P.getHours(),0,0)}while(N<=P){var U=B('td[data-date="'+(N.getTime())+'"][data-resource="'+M.resource+'"][data-space="'+M.space+'"]');if(U&&U.length>0){var R=U.data("reservations");if(R.length>0){B.each(R,function(X,Y){if(Y&&Y!==K){if(c[Y].arrival>M.arrival&&c[Y].arrival<M.departure&&c[Y].departure>M.arrival){r.recursively_remove_reservations(U,T,Y)}else{if(c[Y].departure<=M.arrival||c[Y].arrival>=M.departure){}else{W[c[Y].depths]=1}}}})}if(V===false){Q.css("left",(((M.arrival.getTime()-N.getTime())/1000/a*l.width)-1)+"px");V=U}if(B.inArray(K,R)<0){R.push(K);U.data("reservations",R)}}N=r.manipulate_date_without_offset(N,a*1000)}if(V===false){c[K].changed=false;return true}else{if(p){return false}else{Q.html('<span class="wrapper"><span class="sticky"><span class="id">'+K+'</span><div class="title" contenteditable="true">'+M.title+"</div></span></span>").resizable({handles:"e, w",grid:A?[96,26]:false,maxWidth:l.width*50,scroll:0,minHeight:0,minWidth:4,start:function(X,Y){Y.originalElement.attr("style","left: "+Y.originalElement.css("left")+";top: "+Y.originalElement.css("top")+" !important;width: "+Y.originalElement.css("width"))},resize:function(aa,ac){var ad=parseInt(ac.element.attr("data-id"),10),Y=c[ad],X=a/l.width*(ac.position.left-ac.originalPosition.left),ab=a/l.width*(ac.size.width+2),Z;if(ac.position.left-ac.originalPosition.left!==0){Z=easyFormatTime(r.manipulate_date_without_offset(Y.arrival,X*1000))}else{if(ac.size.width-ac.originalSize.width!==0){Z=easyFormatTime(r.manipulate_date_without_offset(Y.arrival,ab*1000))}else{Z=easyFormatTime(r.manipulate_date_without_offset(Y.arrival,X*1000));Z+=" - ";Z+=easyFormatTime(r.manipulate_date_without_offset(Y.arrival,ab*1000))}}C.html(Z).css({top:b,left:Math.min(e-130,g.width()),display:"block"})},stop:function(Z,ab){var ac=parseInt(ab.element.attr("data-id"),10),X=a/l.width*(ab.position.left-ab.originalPosition.left),aa=a/l.width*(ab.size.width+2),Y={id:ac,arrival:r.manipulate_date_without_offset(c[ac].arrival,X*1000),departure:r.manipulate_date_without_offset(c[ac].arrival,(X*1000)+(aa*1000)),resource:c[ac].resource,space:c[ac].space};if(J.resources[c[ac].resource].availability_by!=="unit"||r.check_availability(Y)){r.recursively_remove_reservation(c[ac]);c[ac].arrival=Y.arrival;c[ac].departure=Y.departure;c[ac].changed=true;r.draw_reservations()}else{ab.helper.animate({width:ab.originalSize.width,left:ab.originalPosition.left},500,function(){})}C.css("display","none")}}).css("min-width",S+"px").css("max-width",S+"px").css("top","0px").css("position","absolute").addClass(M.status).attr("data-tip",M.id).attr("data-id",M.id);r.set_draggable(Q);var O=B('.reservation[data-id="'+K+'"]').remove();if(O.length>0){Q.addClass("fade-in-fast")}V.append(Q);while(W[T]===1){T++}if(T>0){if(V.height()<l.height+(l.height-3)*T){V.height(l.height+(l.height-3)*T)}Q.css("top",(l.height-3)*T+"px")}M.depths=T;M.changed=false;console.log("did draw "+K+"at depths "+T);c[K]=M}}return V},add_reservation:function(K){var L=parseInt(K.id,10);K.id=L;K.arrival=new Date(K.arrival);K.departure=new Date(K.departure);K.resource=parseInt(K.resource,10);K.space=parseInt(K.space,10);if(typeof c[L]==="undefined"){K.changed=true}else{K.changed=c[L].changed;K.depths=c[L].depths}c[L]=K},check_availability:function(K){var M=parseInt(K.id,10),L=true;B.each(c,function(N,O){if(O&&O.resource===K.resource&&O.space===K.space&&O.id!==M&&(K.arrival<O.departure&&K.departure>O.arrival)){L=false;return false}});return L},sync_cell_heights:function(){var K,L;D.each(function(M,N){K=B(N).index()/2-1;B(N).children().each(function(O,P){L=B(P).index();B(P).height(B(F[K]).children().eq(B(P).index()).height())})})},generate_column:function(O,S){var M,W="",K=0,P=0,T=O.getDay()===0?6:O.getDay()-1;if(a==="86400"){M=B('<th><div class="date"><span>'+easyFormatDate(O,"d")+"</span><div>"+er_date_picker_params.day_names_min[T]+"</div></div></th>");if(O.getDate()===1){M.append(B('<div class="first-of-month"></div>'))}}else{var X=er_both_params.time_format.charAt(er_both_params.time_format.length-1),U=easyAddZero(O.getMinutes());if(X==="a"){U=O.getHours()>=12?"pm":"am"}else{if(X==="a"){U=O.getHours()>=12?"PM":"AM"}}M=B('<th><div class="date"><span>'+easyFormatDate(O,"H")+"</span><div>"+U+"</div></div></th>");if(O.getHours()===0){M.append(B('<div class="first-of-month"></div>'))}}if(O.getDate()===j.getDate()&&O.getMonth()===j.getMonth()&&O.getFullYear()===j.getFullYear()&&(a==="86400"||O.getHours()===j.getHours())){var V=B('<div class="today"></div>'),L=B('<div class="overlay"></div>'),R=new Date(),N;if(a==="86400"){N=l.width/86400*(R.getHours()*3600+R.getMinutes()*60)-1}else{N=l.width/3600*(R.getMinutes()*60)-1}V.css("left",N);L.css("left",N).css("width",N).css("margin-left",-N);M.append(V).append(L);W+=" today"}else{if(O<j){W+=" past"}}if(a==="86400"&&(O.getDay()===0||O.getDay()===6)){W+=" weekend"}M.addClass(W).attr("data-date",O.getTime());W+=" loading";if(S){i.prepend(M)}else{i.append(M)}B.each(J.resources,function(ab,aa){var Z=B("<th><div></div></th>").addClass(W).attr("data-resource",ab).attr("data-date",O.getTime());if(S){B(v[K]).find("tr").prepend(Z)}else{B(v[K]).find("tr").append(Z)}for(P=1;P<=(aa.availability_by==="unit"?aa.quantity:1);P++){var Y=B('<td class="cell"></td>').addClass(W).attr("data-resource",ab).data("reservations",[]).attr("data-space",P).attr("data-date",O.getTime());if(S){B(F[K]).find("tr:nth-child("+P+")").prepend(Y)}else{B(F[K]).find("tr:nth-child("+P+")").append(Y)}Y.droppable({scope:"reservations",tolerance:"pointer",drop:function(ae,af){var ac=B(this);if(o.getAttribute("data-space")){ac=B(o)}var ah=parseInt(af.draggable.attr("data-id"),10),ag=a/l.width*(af.position.left-E.left),ad={id:ah,arrival:r.manipulate_date_without_offset(c[ah].arrival,ag*1000),departure:r.manipulate_date_without_offset(c[ah].departure,ag*1000),resource:parseInt(ac.attr("data-resource"),10),space:parseInt(ac.attr("data-space"),10)};if(J.resources[ad.resource].availability_by!=="unit"||r.check_availability(ad)){r.recursively_remove_reservation(c[ah]);c[ah].arrival=ad.arrival;c[ah].departure=ad.departure;c[ah].resource=ad.resource;c[ah].space=ad.space;c[ah].changed=true;if(c[ah].status==="pending"){c[ah].status="approved"}af.helper.remove();r.draw_reservations()}else{}},over:function(ac,ad){}})}K++});if(S){if(I===0||I.getTime()-(a*1000*10)>O.getTime()){r.load_data(s,I);I=new Date(s.getTime())}}else{if(G.getTime()+(a*1000*10)<O.getTime()){var Q=new Date(r.manipulate_date_without_offset(n,a*1000).getTime());r.load_data(G,Q);G=Q}}}};h.insertAfter("hr.wp-header-end");C.insertAfter("hr.wp-header-end");m.hide();k.toggle();if(a==="86400"){j.setHours(0,0,0,0);d.find(".daily").addClass("active")}else{j.setHours(j.getHours(),0,0,0);d.find(".hourly").addClass("active")}k.init();r.init();k.toggle_pending()})(jQuery,er_timeline_params);