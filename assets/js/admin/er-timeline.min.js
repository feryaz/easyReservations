(function(K,U){var M=K(".er-timeline-tooltip"),n=K(".er-timeline"),H=K("#timeline-datepicker"),k=n.find("div.timeline-container"),q=n.find("div.sidebar"),h=n.find("div.timeline"),e=n.find("div.header"),j=n.find("div.resources"),x=j.find(".vertical-scroll"),N=j.find("table tbody"),C=e.find(".date"),y=h.find("div.vertical-scroll"),b=y.find("div.horizontal-scroll"),w=h.find("div.vertical-scroll table"),t=h.find("div.horizontal-scroll"),l=h.find("thead.main tr"),D=w.find("thead:not(.main)"),P=w.find("tbody"),d=[],E=false,m=moment(),A=moment(),r=false,O=false,S=false,I=false,i=false,L=false,u=false,f=0,c=0,g=false,F=false,B=false,p={height:32,width:96},G=false,s=0,T=0,Q=0,v=60,J=U.default_snapping==="1",a="86400",R="days";e.on("click",".expand-sidebar",function(){q.addClass("expanded").show();K(this).removeClass("expand-sidebar").addClass("contract-sidebar")}).on("click",".contract-sidebar",function(){q.removeClass("expanded").hide(300,"linear");K(this).removeClass("contract-sidebar").addClass("expand-sidebar")}).on("click",".hourly",function(){if(!K(this).hasClass("active")){h.addClass("hourly");e.find(".daily").removeClass("active");K(this).addClass("active");A=moment(E);a="3600";R="hours";z.init()}}).on("click",".daily",function(){if(!K(this).hasClass("active")){h.removeClass("hourly");e.find(".hourly").removeClass("active");K(this).addClass("active");A=moment(E);a="86400";R="days";z.init()}}).on("click",".pending",function(){o.toggle_pending()}).on("click",".date",function(){o.toggle_calendar()}).on("click",".today",function(){z.jump_to_date(m)}).on("click","a.start-add",function(){L=K(this).attr("data-target")}).on("click",".cancel-add",function(){L=false});H.bind("change",function(V){z.jump_to_date(moment(K(this).datepicker("getDate")))});l.on("mousedown","th",function(V){g=t.scrollLeft()+V.pageX});y.on("scroll",function(){x.css("margin-top",-K(this).scrollTop())});K(window).mouseup(function(Z){l.css("cursor","grab");clearInterval(F);F=false;g=false;z.clear_scroll_add_interval();M.css("display","none");if(G){var ab=prompt(U.i18n_enter_title,"");if(ab!==null){var Y=G.attr("data-direction"),X=parseInt(G.css("width"),10)/p.width*a,aa=moment(parseInt(G.attr("data-start"),10)*1000),W=Y==="left"?moment(aa).subtract(X,"seconds"):moment(aa).add(X,"seconds"),V={add:L,arrival:easyFormatDate(aa<W?aa:W,"full"),departure:easyFormatDate(W>aa?W:aa,"full"),resource:parseInt(G.attr("data-resource"),10),space:parseInt(G.attr("data-space"),10),title:ab};if(a==="86400"){aa.startOf("day");W.startOf("day")}else{aa.startOf("hour");W.startOf("hour")}if(W>aa){W.add(1,R)}else{aa.subtract(1,R)}z.load_data(aa<W?aa:W,W>aa?W:aa,V)}G.remove();G=false;L=false}});n.on("click",".resource-handler",function(){var W=K(this).parent().parent().parent().parent().next(),V=W.index()/2-0.5;if(K(this).hasClass("retracted")){K(this).removeClass("retracted");W.removeClass("retracted");K(P[V]).removeClass("retracted").show();W.show()}else{K(this).addClass("retracted");W.addClass("retracted");K(P[V]).addClass("retracted").hide();W.hide()}}).on("mousedown",".next",function(){if(F===false){z.add_new_column(false);z.set_current_date();F=setInterval(function(){z.add_new_column(false);z.set_current_date()},100)}}).on("mousedown",".prev",function(){if(F===false){z.add_new_column(true);z.set_current_date();F=setInterval(function(){z.add_new_column(true);z.set_current_date()},100)}});h.mousemove(function(Z){f=Z.pageX;c=Z.pageY;if(g&&Z.which===1){var V=Math.min(g-Z.pageX<1?1:g-Z.pageX,l.width()-h.width()-p.width);t.scrollLeft(V);z.set_current_date();if(B===false){l.css("cursor","grabbing");z.start_scroll_add_interval()}}if(G){var Y=-O.left+f-parseInt(G.attr("data-pageX"),10),aa=moment(parseInt(G.attr("data-start"),10)*1000),ab=(Y)/p.width*a,X="",W="";if(-O.left+Y>0){G.attr("data-direction","right").css("margin-left",O.left).css("width",Y+(-O.left));X=easyFormatTime(aa);W=easyFormatTime(aa.add(ab,"seconds"))}else{G.attr("data-direction","left").css("margin-left",Y).css("width",(-Y)+O.left);W=easyFormatTime(aa);X=easyFormatTime(aa.add(ab,"seconds"))}M.html(X+" - "+W).css({top:c,left:Math.min(f-130,h.width()),display:"block"});z.scroll_dragging()}else{if(L&&Z.target.getAttribute("data-space")){M.html(easyFormatTime(moment(A).add(a/p.width*(Math.floor(Z.target.offsetLeft+Z.offsetX)+1),"seconds"))).css({top:c,left:Math.min(f-130,h.width()),display:"block"})}}if(s!==Z.target){s=Z.target;if(s.getAttribute("data-resource")){z.highlight_current(moment(parseInt(Z.target.getAttribute("data-date"),10)*1000),parseInt(Z.target.getAttribute("data-resource"),10),parseInt(Z.target.getAttribute("data-space"),10))}else{l.find("th.hover").removeClass("hover")}if(s.getAttribute("data-space")){I=K(s).offset().top}else{if(s.getAttribute("data-id")){I=K(s).parent().offset().top}}}}).mouseleave(function(){l.css("cursor","grab");l.find("th.hover").removeClass("hover");N.find("td.hover").removeClass("hover");clearInterval(F);F=false;g=false;s=false;M.css("display","none");z.clear_scroll_add_interval();if(G){G.remove();G=false}}).on("mousedown",".cell",function(X){if(L){var W=moment(parseInt(K(this).attr("data-date"),10)*1000).add(a/(p.width)*Math.floor(X.offsetX+1),"seconds"),V=this;G=K('<div class="placeholder">');O={top:0,left:0};if(L==="resource"){V=this.parentNode.parentNode}else{if(L==="global"){V=this.parentNode.parentNode.parentNode}}G.css("top",V.offsetTop).css("left",this.offsetLeft+X.offsetX+1).css("height",K(V).height()).attr("data-pageX",X.pageX).attr("data-resource",K(this).attr("data-resource")).attr("data-space",K(this).attr("data-space")).attr("data-start",W.unix());b.append(G)}}).on("click",".reservation",function(){var V=parseInt(K(this).attr("data-id"),10);h.find(".reservation.selected").removeClass("selected");K(this).addClass("selected");o.draw_reservation(d[V])}).on("keydown",".reservation .title",function(V){if(V.keyCode===13){var W=K(this).parents(".reservation").attr("data-id");d[W].title=K(this).html();K(this).blur();o.draw_reservation(d[W]);return false}});q.on("click",".allow-edit",function(){var V=parseInt(K(this).attr("data-reservation-id"),10);if(i){z.update_reservation(V);o.stop_edit(i.id)}i=JSON.parse(JSON.stringify(d[V]));L=false;q.find("> .reservation-details .edit-actions").show();z.reservation_allow_edit(w.find('.reservation[data-id="'+V+'"]'));K(this).html(U.i18n_stop_edit).addClass("stop-edit").removeClass("allow-edit")}).on("click",".stop-edit",function(){var V=parseInt(K(this).attr("data-reservation-id"),10);z.update_reservation(V);o.stop_edit(V)}).on("click",".status",function(){if(!K(this).hasClass("reservation-status")){var W=parseInt(K(this).parent().parent().attr("data-reservation-id"),10),V=K(this).attr("data-status");d[W].status=V;w.find('.reservation[data-id="'+W+'"]').removeClass("approved checked completed").addClass(V);o.draw_reservation(d[W]);z.update_reservation(W)}}).on("click",".snapping",function(){if(K(this).hasClass("enabled")){J=false;K(this).removeClass("enabled")}else{J=true;K(this).addClass("enabled")}}).on("click",".revert",function(){var V=parseInt(K(this).attr("data-reservation-id"),10);z.recursively_remove_reservation(d[V]);w.find('.reservation[data-id="'+V+'"]').remove();i.changed=true;z.add_reservation(i);z.draw_reservations();o.stop_edit(V)});var o={init:function(){},is_open:function(){return q.hasClass("expanded")},open:function(){if(!o.is_open()){e.find(".expand-sidebar").click()}},close:function(){if(o.is_open()){e.find(".contract-sidebar").click()}},toggle:function(){if(o.is_open()){e.find(".contract-sidebar").click();return false}else{e.find(".expand-sidebar").click();return true}},toggle_calendar:function(){if(!q.find("> .calendar").hasClass("visible")){o.display_calendar();o.open()}else{o.toggle()}},toggle_pending:function(){if(!q.find("> .pending").hasClass("visible")){o.display_pending();o.open()}else{o.toggle()}},clear:function(){q.find("> .visible").hide().removeClass("visible")},display_calendar:function(){var V=q.find("> .calendar");o.clear();V.show().addClass("visible")},display_pending:function(){var V=q.find("> .pending");o.clear();V.show().addClass("visible")},stop_edit:function(V){q.find("> .reservation-details .edit-actions").hide();q.find("> .reservation-details .stop-edit").html(U.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");if(i){z.reservation_stop_edit(w.find('.reservation[data-id="'+V+'"]'));i=false}},draw_today:function(){var Y=q.find("> .calendar .arrivals"),Z=q.find("> .calendar .departures"),W,X,aa,V=er_both_params.time_format.charAt(er_both_params.time_format.length-1);Y.html("");Z.html("");K.each(d,function(ab,ad){if(ad){X=false;aa=false;if(ad.arrival.date()===E.date()&&ad.arrival.month()===E.month()&&ad.arrival.year()===E.year()){X="arrival";W=ad.arrival;aa=ad.departure.date()===W.date()&&ad.departure.month()===W.month()&&ad.departure.year()===W.year()}else{if(ad.departure.date()===E.date()&&ad.departure.month()===E.month()&&ad.departure.year()===E.year()){X="departure";W=ad.departure}}if(X){var ac=K('<div class="today-reservation">');ac.attr("data-id",ad.id).append('<span class="date"><span class="hour">'+easyAddZero(W.hour())+'</span><span class="minute">'+easyAddZero(W.minute())+'</span><span class="ampm">'+(V==="a"?(W.hour()>=12?"pm":"am"):(V==="A"?(W.hour()>=12?"PM":"AM"):""))+"</span></span>").append('<div><div class="title"><span class="id reservation-status background status-'+ad.status+'">'+ad.id+"</span>"+ad.title+'</div><div class="resource">'+(ad.resource>0?U.resources[ad.resource].post_title:U.i18n_no_resource)+'</div><div class="date"><span class="'+X+'"></span>'+(aa?easyFormatTime(ad.departure):easyFormatDate(X==="arrival"?ad.departure:ad.arrival,"full"))+"</div></div>").bind("click",function(){var ae=parseInt(K(this).attr("data-id"),10);w.find('.reservation[data-id="'+ae+'"]').trigger("click")});if(X==="arrival"){Y.append(ac)}else{Z.append(ac)}}}});if(Y.is(":empty")){Y.html('<div class="today-reservation">'+U.i18n_no_arrivals+"</div>")}if(Z.is(":empty")){Z.html('<div class="today-reservation">'+U.i18n_no_departures+"</div>")}},draw_pending:function(){if(U.pending&&U.pending.length>0){e.find(".pending").html("<span>"+U.pending.length+"</span>");var V=q.find("> .pending").find(".reservations");V.html("");K.each(U.pending,function(W,Y){var X=K('<div class="pending-reservation">'),aa=parseInt(Y.resource,10),Z=false;Y.id=parseInt(Y.id,10);Y.arrival=moment(Y.arrival);Y.departure=moment(Y.departure);if(!Y.title){Y.title="No title"}X.html('<span class="id">'+Y.id+'</span><div><div class="title">'+Y.title+'</div><div class="resource">'+(Y.resource>0?U.resources[Y.resource].post_title:U.i18n_no_resource)+'</div><div class="date">'+easyFormatDate(Y.arrival,"full")+'</div><div class="date">'+easyFormatDate(Y.departure,"full")+"</div></div>");X.bind("click",function(){z.jump_to_date(Y.arrival);if(aa>0){j.find('.resource-handler:not([data-resource="'+Y.resource+'"],.retracted),.resource-handler.retracted[data-resource="'+Y.resource+'"]').click()}K.each(U.resources,function(ab,ad){if(!Z&&(aa===0||aa===ad.ID)){if(ad.availability_by==="unit"){Y.resource=ad.ID;Y.space=1;Z=true;return false}else{Y.resource=ad.ID;for(var ac=1;ac<=ad.quantity;ac++){Y.space=1;if(z.check_availability(Y)){Z=true;break}}}}});if(Z){if(i){z.update_reservation(i.id);o.stop_edit(i.id)}i=JSON.parse(JSON.stringify(Y));Y.status="approved";z.add_reservation(Y);z.draw_reservations();o.draw_reservation(Y);U.pending.splice(W,1);K(this).remove();o.draw_pending()}});V.append(X)})}else{e.find(".pending").html("");q.find("> .pending").find(".reservations").html(U.i18n_no_pending)}},draw_reservation:function(X){var W=q.find("> .reservation-details"),V=W.find("h2"),Y=U.resources[X.resource];console.log(X);V.find(".title").html(X.title);V.find(".reservation-status").attr("class","reservation-status status-"+X.status).html(X.id);W.attr("data-reservation-id",X.id);W.find(".reservation-preview").attr("data-reservation-id",X.id).data("reservation-data",false);W.find(".snapping").removeClass("enabled");W.find(".revert").attr("data-reservation-id",X.id);W.find(".input-box.reservation-status").removeClass("reservation-status");W.find(".input-box.status-"+X.status).addClass("reservation-status");W.find(".reservation-arrival").html(easyFormatDate(X.arrival,"full"));W.find(".reservation-departure").html(easyFormatDate(X.departure,"full"));W.find(".reservation-resource").html(Y.post_title);W.find(".reservation-adults").html(X.adults);W.find(".reservation-children").html(X.children);if(i&&i.id===X.id){W.find(".edit-actions").show();W.find(".allow-edit").html(U.i18n_stop_edit).removeClass("allow-edit").addClass("stop-edit");W.find(".stop-edit").attr("data-reservation-id",X.id)}else{W.find(".stop-edit").html(U.i18n_allow_edit).removeClass("stop-edit").addClass("allow-edit");W.find(".allow-edit").attr("data-reservation-id",X.id);W.find(".edit-actions").hide()}if(Y.availability_by!=="unit"){W.find(".reservation-space").hide()}else{W.find(".reservation-space").show().html(typeof Y.spaces[X.space]==="undefined"?X.space:Y.spaces[X.space])}if(X.order_id==="0"){W.find(".reservation-order").html(U.i18n_no_order)}else{W.find(".reservation-order").html(U.i18n_order.replace("%s",'<a href="'+U.order_url.replace("%s",X.order_id)+'" target="_blank">#'+X.order_id+"</a>"))}if(J){W.find(".snapping").addClass("enabled")}o.clear();W.show().addClass("visible");o.open()}};var z={init:function(){var W=(K(window).height()-x.offset().top-5)/(U.reservation_id>0?3:1);x.css("max-height",W);y.css("max-height",W);m=moment();d=[];E=false;if(a==="86400"){p.width=96;m.startOf("day");A.startOf("day")}else{p.width=48;m.startOf("hour");if(m.date()===A.date()&&m.month()===A.month()&&m.year()===A.year()){A.hours(m.hour()).minutes(0).seconds(0).milliseconds(0)}else{A.startOf("day")}}h.find("td,th").remove();A.subtract(15,R);r=moment(A);Q=moment(A);T=moment(A);for(var X=0;X<v;X++){z.generate_column(r,false);if(X<v-1){r.add(1,R)}}z.load_remaining();var V=l.find("th:nth-child(15)").offset().left-h.offset().left+t.scrollLeft()+1;t.scrollLeft(V);z.set_current_date();z.sync_cell_heights()},highlight_current:function(V,X,W){l.find("th.hover").removeClass("hover");l.find('th[data-date="'+V.unix()+'"]').addClass("hover");N.find("td.hover, th.hover").removeClass("hover");if(W){N.find('td[data-resource="'+X+'"][data-space="'+W+'"]').addClass("hover")}else{N.find('th[data-resource="'+X+'"]').addClass("hover")}},set_current_date:function(){var V=moment(A).add(Math.round(t.scrollLeft()/p.width)+1,R);if(a==="3600"){V.startOf("hour")}else{V.startOf("day")}if(!E||V.date()!==E.date()||V.month()!==E.month()||V.year()!==E.year()){E=V;if(a==="3600"){C.html(E.date()+" "+er_date_picker_params.month_names[E.month()]+" "+E.year())}else{C.html(er_date_picker_params.month_names[E.month()]+" "+E.year())}h.find("th.current,td.current").removeClass("current");h.find('th[data-date="'+E.unix()+'"],td[data-date="'+E.unix()+'"]').addClass("current");H.datepicker("setDate",new Date(E.format("YYYY-MM-DDTHH:mm:ssZ")));o.draw_today()}else{if(a==="3600"&&V.hour()!==E.hour()){E=V;h.find("th.current,td.current").removeClass("current");h.find('th[data-date="'+E.unix()+'"],td[data-date="'+E.unix()+'"]').addClass("current")}}},scroll_dragging:function(){var V=c-y.offset().top,X=f-h.offset().left,W=y.height();if((X>0&&X<p.width/2)||h.width()-X<p.width/2){if(F===false){F=setInterval(function(){var Y=f-h.offset().left;if((Y>0&&Y<p.width/2)||h.width()-Y<p.width/2){O.left=O.left+(Y<p.width/2?p.width:p.width*-1);z.add_new_column(Y<p.width/2);z.set_current_date()}},100)}}else{if(V>0&&V<20){if(F===false){F=setInterval(function(){if(F!==false){y.scrollTop(Math.max(0,y.scrollTop()-4))}},1)}}else{if(W-V<20&&V<=W){if(F===false){F=setInterval(function(){if(F!==false){y.scrollTop(Math.min(W,y.scrollTop()+4))}},1)}}else{if(F!==false){clearInterval(F);F=false;z.load_remaining()}}}}},start_scroll_add_interval:function(){if(B===false&&(t.scrollLeft()<2||l.width()-(h.width()+t.scrollLeft())<5+p.width*2)){B=setInterval(function(){if(B!==false&&(t.scrollLeft()<2||l.width()-(h.width()+t.scrollLeft())<5+p.width*2)){z.add_new_column(t.scrollLeft()<2);z.set_current_date()}},45)}},clear_scroll_add_interval:function(){if(B!==false){clearInterval(B);B=false;z.load_remaining()}},jump_to_date:function(V){if(V<A||V>r){A=V;z.init()}else{var X=E.diff(V)/(a*1000);for(var W=1;W<=Math.abs(X);W++){z.add_new_column(X>0)}z.set_current_date()}},add_new_column:function(V){if(V){A.subtract(1,R);z.generate_column(A,true);h.find("th:last-child,td:last-child").remove();Q.subtract(1,R);r.subtract(1,R)}else{r.add(1,R);z.generate_column(r,false);l.find("th:first-child").remove();w.find("th:first-child").remove();w.find("td:first-child").each(function(){var W=K(this).data("reservations");if(W&&W.length>0){K.each(W,function(X,Y){if(d[Y]&&typeof d[Y]!=="undefined"){d[Y].changed=true}})}}).remove();T.add(1,R);A.add(1,R);z.draw_reservations()}z.sync_cell_heights()},load_remaining:function(){if(T===0||T>A){z.load_data(A,T);T=moment(A)}else{if(Q<r){var V=moment(r).add(1,R);z.load_data(Q,V);Q=V}else{}}},load_data:function(X,V,W){K.ajax({url:U.ajax_url,data:K.extend({action:"easyreservations_timeline_data",security:U.nonce,start:X.date()+"."+(X.month()+1)+"."+X.year(),start_hour:X.hour(),end:V.date()+"."+(V.month()+1)+"."+V.year(),end_hour:V.hour(),interval:a},W),type:"POST",success:function(Y){if(Y.data){K.each(Y.data,function(ab,aa){var Z=U.resources[ab].quantity;K.each(aa,function(ag,ac){var ae=moment(ag),ad="",af;if(ac<0){ad="unavailable";af=0}else{af=Z-ac}P.find('td[data-date="'+(ae.unix())+'"][data-resource="'+ab+'"]').removeClass("loading").addClass(ad);D.find('th[data-date="'+(ae.unix())+'"][data-resource="'+ab+'"] div.count').html("<span>"+af+"</span>").addClass(parseInt(ac,10)===Z?"unavailable":"")})})}if(Y.reservations){K.each(Y.reservations,function(Z,aa){z.add_reservation(aa,true)});z.draw_reservations()}if(Y.message){alert(Y.message)}}})},update_reservation:function(W){var V=d[W];K.ajax({url:U.ajax_url,data:{action:"easyreservations_timeline_update_reservation",security:U.nonce,id:W,arrival:easyFormatDate(V.arrival,"full"),departure:easyFormatDate(V.departure,"full"),status:V.status,resource:V.resource,space:V.space,adults:V.adults,children:V.children,title:V.title},type:"POST",success:function(X){if(X.reservation){console.log(X.reservation.arrival.date);d[W].arrival=moment(X.reservation.arrival.date);d[W].departure=moment(X.reservation.departure.date);d[W].adults=parseInt(X.reservation.adults,10);d[W].children=parseInt(X.reservation.children,10);d[W].resource=parseInt(X.reservation.resource_id,10);d[W].space=parseInt(X.reservation.space,10);d[W].order_id=parseInt(X.reservation.order_id,10);d[W].changed=true;z.draw_reservations()}if(X.message){alert(X.message)}}})},draw_reservations:function(){var V=[],W=true;K.each(d,function(X,Y){if(Y&&Y.changed&&Y.status!=="pending"){V.push(Y.id)}});V.sort(function(Y,X){return d[Y].arrival<d[X].arrival?-1:1});K.each(V,function(X,Y){if(Y){if(!z.draw_reservation(d[Y])){z.draw_reservations();W=false;return false}}});if(W&&V.length>0){z.sync_cell_heights()}},recursively_remove_reservation:function(Y){var Z=parseInt(Y.id,10),X=moment(Y.arrival),W=moment(Y.departure);if(a==="86400"){X.startOf("day");W.startOf("day")}else{X.startOf("hour");W.startOf("hour")}while(X<=W){var V=K('td[data-date="'+(X.unix())+'"][data-resource="'+Y.resource+'"][data-space="'+Y.space+'"]');if(V.length>0){z.recursively_remove_reservations(V,Y.depths,Z)}X.add(1,R)}},recursively_remove_reservations:function(W,aa,ab){var V=W.data("reservations"),Z=[],X=false,Y=0;if(V&&V.length>0){K.each(V,function(ac,ad){if(ad){if(ad===ab||d[ad].depths>=aa){if(X===false){X=d[ad].depths}X=Math.min(X,d[ad].depths);u=true;d[ad].changed=true}else{Z.push(ad);Y=Math.max(Y,d[ad].depths)}}})}W.data("reservations",Z);if(X!==false){z.recursively_remove_reservations(W.next(),X,ab)}},reservation_stop_edit:function(V){V.draggable("destroy").resizable("destroy");V.find(".title").attr("contenteditable","false")},reservation_allow_edit:function(V){V.draggable({snap:J?false:".reservation",snapTolerance:3,scroll:false,helper:"clone",appendTo:".timeline",scope:"reservations",cancel:".title",revert:function(W,X){if(W){return W}K(this).data("uiDraggable").originalPosition={top:O.top-1,left:O.left};return !W},start:function(W,X){O=X.originalPosition;S=X.offset},drag:function(Y,Z){var ab=parseInt(Z.helper.attr("data-id"),10),W=d[ab],aa=a/p.width*(Z.position.left-O.left);if(J){var X=Math.round((Z.position.left-O.left)/p.width);aa=X*a;Z.position.left=O.left+(X*p.width)}M.html(easyFormatTime(moment(W.arrival).add(aa,"seconds"))+" - "+easyFormatTime(moment(W.departure).add(aa,"seconds"))).css({top:c,left:Math.min(f-130,h.width()),display:"block"});if(I!==false){Z.position.top=I-S.top+O.top}z.scroll_dragging()},stop:function(){M.css("display","none");if(F!==false){clearInterval(F);F=false;z.load_remaining()}}}).resizable({handles:"e, w",grid:J?[p.width,26]:false,minHeight:0,minWidth:4,start:function(W,X){X.originalElement.attr("style","left: "+X.originalElement.css("left")+";top: "+X.originalElement.css("top")+" !important;width: "+X.originalElement.css("width"))},resize:function(Z,ab){var ac=parseInt(ab.element.attr("data-id"),10),X=d[ac],W=a/p.width*(ab.position.left-ab.originalPosition.left),aa=a/p.width*(ab.size.width),Y;if(ab.position.left-ab.originalPosition.left!==0){Y=easyFormatTime(moment(X.arrival).add(W,"seconds"))}else{if(ab.size.width-ab.originalSize.width!==0){Y=easyFormatTime(moment(X.arrival).add(aa,"seconds"))}else{Y=easyFormatTime(moment(X.arrival).add(W,"seconds"));Y+=" - ";Y+=easyFormatTime(moment(X.arrival).add(aa,"seconds"))}}M.html(Y).css({top:c,left:Math.min(f-130,h.width()),display:"block"})},stop:function(Y,aa){var ab=parseInt(aa.element.attr("data-id"),10),W=a/p.width*(aa.position.left-aa.originalPosition.left),Z=a/p.width*(aa.size.width),X={id:ab,arrival:moment(d[ab].arrival).add(W,"seconds"),departure:moment(d[ab].arrival).add(W+Z,"seconds"),resource:d[ab].resource,space:d[ab].space};if(U.resources[d[ab].resource].availability_by!=="unit"||z.check_availability(X)){z.recursively_remove_reservation(d[ab]);d[ab].arrival=X.arrival;d[ab].departure=X.departure;d[ab].changed=true;z.draw_reservations()}else{aa.helper.animate({width:aa.originalSize.width,left:aa.originalPosition.left},500,function(){})}M.css("display","none")}});V.find(".title").attr("contenteditable","true")},draw_reservation:function(X){var V=parseInt(X.id,10),Y=moment(X.arrival),aa=moment(X.departure),ab=K('<div class="reservation">'),W=aa.diff(Y),ad=(((W/1000)/a)*p.width),ag=false,ah=[],ae=0;u=false;if(a==="86400"){Y.startOf("day");aa.startOf("day")}else{Y.startOf("hour");aa.startOf("hour")}while(Y<=aa){var af=K('td[data-date="'+(Y.unix())+'"][data-resource="'+X.resource+'"][data-space="'+X.space+'"]');if(af&&af.length>0){var ac=af.data("reservations");if(ac.length>0){K.each(ac,function(ai,aj){if(aj&&aj!==V){if(d[aj].arrival>X.arrival&&d[aj].arrival<X.departure&&d[aj].departure>X.arrival){z.recursively_remove_reservations(af,ae,aj)}else{if(d[aj].departure<=X.arrival||d[aj].arrival>=X.departure){}else{ah[d[aj].depths]=1}}}})}if(ag===false){ab.css("left",((X.arrival.diff(Y)/1000/a*p.width)-1)+"px");ag=af}if(K.inArray(V,ac)<0){ac.push(V);af.data("reservations",ac)}}Y.add(1,R)}if(ag===false){d[V].changed=false;return true}else{if(u){return false}else{ab.html('<span class="wrapper"><span class="sticky"><span class="id">'+V+'</span><div class="title">'+X.title+"</div></span></span>").css("min-width",ad+"px").css("max-width",ad+"px").css("top","0px").css("position","absolute").addClass(X.status).attr("data-tip",X.id).attr("data-id",X.id);var Z=w.find('.reservation[data-id="'+V+'"]').remove();if(Z.length>0){ab.addClass("fade-in-fast")}else{if(X.fresh){delete X.fresh}else{ab.addClass("no-animation")}}if(i&&i.id===V){o.draw_reservation(X);z.reservation_allow_edit(ab);h.find(".reservation.selected").removeClass("selected");ab.addClass("selected")}ag.append(ab);while(ah[ae]===1){ae++}if(ae>0){if(ag.height()<p.height+(p.height-3)*ae){ag.height(p.height+(p.height-3)*ae)}ab.css("top",(p.height-3)*ae+"px")}X.depths=ae;X.changed=false;console.log(X);d[V]=X}}return ag},add_reservation:function(V,W){var X=parseInt(V.id,10);V.id=X;V.arrival=moment(V.arrival);V.departure=moment(V.departure);V.resource=parseInt(V.resource,10);V.space=parseInt(V.space,10);if(typeof d[X]==="undefined"){V.changed=true;V.fresh=true}else{V.changed=W?true:d[X].changed;V.depths=d[X].depths}d[X]=V},check_availability:function(V){var X=parseInt(V.id,10),W=true;K.each(d,function(Y,Z){if(Z&&Z.resource===V.resource&&Z.space===V.space&&Z.id!==X&&(V.arrival<Z.departure&&V.departure>Z.arrival)){W=false;return false}});return W},sync_cell_heights:function(){var V,W;N.each(function(X,Y){V=K(Y).index()/2-0.5;K(Y).children().each(function(Z,aa){W=K(aa).index();K(aa).height(K(P[V]).children().eq(K(aa).index()).height())})})},generate_column:function(Z,ad){var X,ai="",V=0,aa=0,ae=Z.day()===0?6:Z.day()-1,ah=false;if(a==="86400"){X=K('<th><div class="date"><div>'+easyFormatDate(Z,"d")+"<span>"+er_date_picker_params.day_names_min[ae]+'</span></div></div><div class="marker"></div></th>');if(Z.date()===1){ai="first";X.append(K('<div class="first">'+er_date_picker_params.month_names[Z.month()]+"</div>"))}}else{var ag=er_both_params.time_format.charAt(er_both_params.time_format.length-1),af="00";if(ag==="a"){af=Z.hours()>=12?"pm":"am"}else{if(ag==="A"){af=Z.hours()>=12?"PM":"AM"}}X=K('<th><div class="date"><div>'+easyFormatDate(Z,"H")+"<span>"+af+'</span></div></div><div class="marker"></div></th>');if(Z.hours()===0){ai="first";X.append(K('<div class="first">'+Z.date()+" "+er_date_picker_params.day_names[ae]+"</div>"))}}if(Z.date()===m.date()&&Z.month()===m.month()&&Z.year()===m.year()&&(a==="86400"||Z.hour()===m.hour())){var ac=moment(),W=K('<div class="overlay"></div>'),Y;ah=K('<div class="today"></div>');if(a==="86400"){Y=p.width/86400*(ac.hour()*3600+ac.minute()*60)-1}else{Y=p.width/3600*(ac.minute()*60)-1}ah.css("left",Y);W.css("left",Y).css("width",Y).css("margin-left",-Y);X.append(ah).append(W);ai+=" today"}else{if(Z<m){ai+=" past"}}if((Z.day()===0||Z.day()===6)){ai+=" weekend"}X.addClass(ai).attr("data-date",Z.unix());ai+=" loading";if(ad){l.prepend(X)}else{l.append(X)}K.each(U.resources,function(am,al){var ak=K('<th><div class="count"></div></th>').addClass(ai).attr("data-resource",am).attr("data-date",Z.unix());if(ad){K(D[V]).find("tr").prepend(ak)}else{K(D[V]).find("tr").append(ak)}for(aa=1;aa<=(al.availability_by==="unit"?al.quantity:1);aa++){var aj=K('<td class="cell"></td>').addClass(ai).attr("data-resource",am).data("reservations",[]).attr("data-space",aa).attr("data-date",Z.unix());if(ah){aj.append(ah.clone());ah=false}if(ad){K(P[V]).find("tr:nth-child("+aa+")").prepend(aj)}else{K(P[V]).find("tr:nth-child("+aa+")").append(aj)}aj.droppable({scope:"reservations",tolerance:"pointer",drop:function(ap,aq){var an=K(this);if(s&&s.getAttribute("data-space")){an=K(s)}var at=parseInt(aq.draggable.attr("data-id"),10),ar=a/p.width*(aq.position.left-O.left),ao={id:at,arrival:moment(d[at].arrival).add(ar,"seconds"),departure:moment(d[at].departure).add(ar,"seconds"),resource:parseInt(an.attr("data-resource"),10),space:parseInt(an.attr("data-space"),10)};if(U.resources[ao.resource].availability_by!=="unit"||z.check_availability(ao)){z.recursively_remove_reservation(d[at]);d[at].arrival=ao.arrival;d[at].departure=ao.departure;d[at].resource=ao.resource;d[at].space=ao.space;d[at].changed=true;if(d[at].status==="pending"){d[at].status="approved"}aq.helper.remove();z.draw_reservations()}}})}V++});if(ad){if(T===0||T.valueOf()-(a*1000*10)>Z.valueOf()){z.load_data(A,T,{});T=moment(A)}}else{if(Q.valueOf()+(a*1000*10)<Z.valueOf()){var ab=moment(r).add(a,"seconds");z.load_data(Q,ab,{});Q=ab}}}};console.log(K("hr.wp-header-end"));n.insertAfter("hr.wp-header-end");M.insertAfter("hr.wp-header-end");q.hide();if(U.default_hourly==="on"){a="3600";R="hours"}if(a==="86400"){m.startOf("day");e.find(".daily").addClass("active")}else{m.startOf("hour");e.find(".hourly").addClass("active");h.addClass("hourly");p.width=48}o.draw_pending();o.display_calendar();n.css("display","flex");z.init();if(U.reservation_resource>0){j.find('.resource-handler:not([data-resource="'+U.reservation_resource+'"],.retracted),.resource-handler.retracted[data-resource="'+U.reservation_resource+'"]').click()}if(U.reservation_arrival){z.jump_to_date(moment(U.reservation_arrival))}})(jQuery,er_timeline_params);