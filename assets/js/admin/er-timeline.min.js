(function(h,D){var g=h(".er-timeline-tooltip"),m=h(".er-timeline"),o=h("#timeline-datepicker"),l=m.find("div.timeline"),u=m.find("div.header"),v=m.find("div.resources table"),A=u.find(".date"),w=l.find("table"),k=l.find("thead tr"),a=w.find("tbody"),z=[],y=new Date(),i=new Date(),e=false,E=false,f=false,q=false,r=false,d=0,c=0,C=false,b=false,t=false,n={height:27,width:96},j=0,p=0,B=0,x=D.default_interval;m.insertAfter("hr.wp-header-end");g.insertAfter("hr.wp-header-end");u.bind("click",function(){o.datepicker("show")});o.bind("change",function(){i=h(this).datepicker("getDate");s.init()});l.find("thead").on({mousedown:function(F){b=l.scrollLeft()+F.pageX}});h(window).mouseup(function(){k.css("cursor","grab");clearInterval(b);b=false;s.clear_scroll_timeout()});m.mousemove(function(F){d=F.pageX;c=F.pageY;if(b&&h.isNumeric(b)&&F.which===1){l.scrollLeft(b-F.pageX<1?1:b-F.pageX);if(t===false){k.css("cursor","grabbing");s.scroll()}}if(j!==F.target){j=F.target;if(F.target.getAttribute("data-date")){s.highlight_current(new Date(parseInt(F.target.getAttribute("data-date"),10)))}if(F.target.getAttribute("data-space")){C=h(F.target).offset().top}else{if(F.target.getAttribute("data-id")){C=h(F.target).parent().offset().top}}}}).mouseleave(function(){k.css("cursor","grab");clearInterval(b);b=false;s.clear_scroll_timeout()}).on("mousedown",".next",function(){if(b===false){b=setInterval(function(){if(b!==false){l.scrollLeft(l.scrollLeft()+n.width);s.scroll()}},100)}}).on("mousedown",".prev",function(){if(b===false){b=setInterval(function(){if(b!==false){l.scrollLeft(l.scrollLeft()-n.width);s.scroll()}},100)}});l.scroll(function(){if(b!==false){k.css("cursor","grabbing")}});var s={init:function(){if(x==="86400"){i.setHours(0,0,0,0)}else{i.setHours(i.getHours(),0,0,0)}l.scrollLeft(1);var F=i,G;s.set_current_date(y);w.find("td,th").remove();F.setTime(F.getTime()-(10*x*1000));B=F.getTime();p=F.getTime();for(G=0;G<50;G++){e=new Date(F.getTime()+(G*x*1000));s.generate_column(e)}s.load_remaining();l.scrollLeft(k.find("th:nth-child(9)").offset().left-l.offset().left+l.scrollLeft()+1)},slide_current:function(G){var F=k.find("th:nth-child("+(Math.round(l.scrollLeft()/n.width)+(3))+")");s.highlight_current(new Date(F.data("date")))},highlight_current:function(F){s.set_current_date(F);h(".er-timeline .current").removeClass("current");h('*[data-date="'+F.getTime()+'"]').addClass("current")},set_current_date:function(F){if(x==="3600"){A.html(F.getDate()+" "+er_date_picker_params.month_names[F.getMonth()]+" "+F.getFullYear())}else{A.html(er_date_picker_params.month_names[F.getMonth()]+" "+F.getFullYear())}o.val(F.getDate()+"."+(F.getMonth()+1)+"."+F.getFullYear())},scroll:function(){if(t===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){t=setInterval(function(){if(t!==false){s.add_new_column(l.scrollLeft()<2)}},38)}},add_new_column:function(F){if(F){i.setTime(i.getTime()-(x*1000));s.generate_column(i,true);s.set_current_date(i);w.find("th:last-child,td:last-child").remove();B-=(x*1000);e.setTime(e.getTime()-(x*1000))}else{e.setTime(e.getTime()+(x*1000));s.generate_column(e);s.set_current_date(e);w.find("th:first-child").remove();w.find("td:first-child").each(function(){var G=h(this).data("reservations");if(G&&G.length>0){h.each(G,function(H,I){if(z[I]&&typeof z[I]!=="undefined"){z[I].changed=true}})}}).remove();p+=(x*1000);i.setTime(i.getTime()+(x*1000))}},clear_scroll_timeout:function(){if(t!==false){clearInterval(t);t=false;s.load_remaining()}},load_remaining:function(){if(p===0||p>i.getTime()){s.load_data(i,new Date(p));p=i.getTime()}else{if(B<e.getTime()){s.load_data(new Date(B),new Date(e.getTime()+(x*1000)));B=e.getTime()}else{}}},load_data:function(G,F){h.ajax({url:D.ajax_url,data:{action:"easyreservations_timeline_data",security:D.nonce,start:G.getDate()+"."+(G.getMonth()+1)+"."+G.getFullYear(),start_hour:G.getHours(),end:F.getDate()+"."+(F.getMonth()+1)+"."+F.getFullYear(),end_hour:F.getHours(),interval:x},type:"POST",success:function(H){if(H.data){h.each(H.data,function(K,J){var I=D.resources[K].quantity;h.each(J,function(P,L){var N=new Date(parseInt(P,10)*1000),M="",O="";if(L<0){M="unavailable";O=0}else{O=I-L}h('td[data-date="'+(N.getTime()+(N.getTimezoneOffset()*1000*60))+'"][data-resource="'+K+'"]').removeClass("loading").addClass(M);h('tr.resource td[data-date="'+(N.getTime()+(N.getTimezoneOffset()*1000*60))+'"][data-resource="'+K+'"]').html('<div style="pointer-events:none">'+O+"</div>").addClass(L==I?"unavailable":"")})})}if(H.reservations){h.each(H.reservations,function(I,J){J.changed=true;s.add_reservation(J)});s.draw_reservations()}}})},draw_reservations:function(){var F=[];h.each(z,function(G,H){if(H&&H.changed){F.push(H.id)}});F.sort(function(H,G){return z[H].arrival<z[G].arrival?-1:1});h.each(F,function(G,H){if(H){if(!s.draw_reservation(z[H])){s.draw_reservations();return false}}})},recursively_remove_reservation:function(I){var J=parseInt(I.id,10),H=new Date(I.arrival),G=new Date(I.departure);if(x==="86400"){H.setHours(0,0,0);G.setHours(0,0,0)}else{H.setHours(H.getHours(),0,0);G.setHours(G.getHours(),0,0)}while(H<=G){var F=h('td[data-date="'+(H.getTime())+'"][data-resource="'+I.resource+'"][data-space="'+I.space+'"]');if(F.length>0){s.recursively_remove_reservations(F,I.depths,J)}H.setTime(H.getTime()+(x*1000))}return false},recursively_remove_reservations:function(G,J,K){var F=G.data("reservations"),H=false,I=0;if(F&&F.length>0){h.each(F,function(L,M){if(M){if(M===K||z[M].depths>=J){if(H===false){H=z[M].depths}H=Math.min(H,z[M].depths);r=true;z[M].changed=true;F.splice(L,1)}else{I=Math.max(I,z[M].depths)}}})}G.data("reservations",F);G.height(n.height+n.height*I);if(H!==false){return s.recursively_remove_reservations(G.next(),H,K)}return true},draw_reservation:function(H){var F=parseInt(H.id,10),I=new Date(H.arrival),J=new Date(H.departure),K=h('<div class="reservation">'),G=(H.departure-H.arrival),M=(((G/1000)/x)*n.width)-(x==="86400"?2:1),P=false,Q=[],N=0;r=false;h('.reservation[data-id="'+F+'"]').remove();if(x==="86400"){I.setHours(0,0,0);J.setHours(0,0,0)}else{I.setHours(I.getHours(),0,0);J.setHours(J.getHours(),0,0)}while(I<=J){var O=h('td[data-date="'+(I.getTime())+'"][data-resource="'+H.resource+'"][data-space="'+H.space+'"]');if(O&&O.length>0){var L=O.data("reservations");if(L.length>0){h.each(L,function(R,S){if(S&&S!==F){if(z[S].arrival>H.arrival&&z[S].departure>H.arrival){console.log("recursively_remove_reservations ");s.recursively_remove_reservations(O,N,S)}else{if(z[S].departure<=H.arrival){console.log("could go in "+z[S].depths+" because of "+S)}else{Q[z[S].depths]=1;console.log(F+" cannot go in "+z[S].depths+" because of "+S)}}}})}if(P===false){K.css("left",((((H.arrival-I.getTime())/1000)/x)*n.width)-1+"px");P=O}if(h.inArray(F,L)<0){L.push(F);O.data("reservations",L)}}I.setTime(I.getTime()+(x*1000))}if(P===false){delete z[F]}else{if(r){return false}else{K.html('<span class="wrapper"><span>#'+F+" "+H.title+"</span></span>").draggable({snapTolerance:3,containment:a,revert:"invalid",stack:".reservation",scope:"reservations",snap:"td.cell,.reservation",start:function(R,S){E=S.originalPosition;f=S.offset;q=S.originalPosition.left},drag:function(T,U){var X=parseInt(U.helper.attr("data-id"),10),R=z[X],W=x/n.width*(U.position.left-U.originalPosition.left),S=d-l.offset().left,V=l.scrollLeft();g.html(easyFormatTime(new Date(R.arrival+(W*1000)))+" - "+easyFormatTime(new Date(R.departure+(W*1000)))).css({top:c,left:Math.min(d-130,l.width())}).show();if(C!==false){U.position.top=C-f.top+E.top}if(S<10||l.width()-S<10){l.scrollLeft(l.scrollLeft()+(S<10?n.width*-1:n.width));q+=l.scrollLeft()-V;if(t===false){}}},stop:function(){g.hide()}}).resizable({containment:a,handles:"e",maxWidth:n.width*50,minWidth:4,start:function(U,V){var W=parseInt(V.originalElement.attr("data-id"),10),T=h(this),R=V.originalElement.parent();while(R.length>0){var S=R.find(".reservation");R=R.next();if(S.length>0){h.each(S,function(X,Y){var Z=parseInt(h(Y).attr("data-id"));if(Z!==W){T.resizable("option","maxWidth",(z[Z].arrival-z[W].departure)/(x*1000)*n.width+V.originalSize.width+1);R={length:0};return false}})}}V.helper.attr("style","left: "+V.helper.css("left"))},resize:function(S,T){var V=parseInt(T.element.attr("data-id"),10),R=z[V],U=x/n.width*(T.size.width+1);g.html(easyFormatTime(new Date(R.arrival+(U*1000)))).css({top:c,left:Math.min(d-130,h(window).width())}).show()},stop:function(S,T){var V=parseInt(T.element.attr("data-id"),10),R=z[V],U=x/n.width*(T.size.width+1);R.departure=R.arrival+(U*1000);s.draw_reservation(R);g.hide()}}).css("min-width",M+"px").css("max-width",M+"px").css("position","absolute").attr("data-tip",H.id).attr("data-id",H.id);P.append(K);while(Q[N]===1){N++}if(N>0){if(P.height()<n.height+n.height*N){P.height(n.height+n.height*N)}K.css("top",n.height*N+"px")}H.depths=N;H.changed=false;console.log("did draw "+F+"at depths "+N);z[F]=H}}return P},add_reservation:function(F){var G=parseInt(F.id,10);if(!h.isNumeric(F.arrival)){F.id=G;F.arrival=new Date(F.arrival).getTime();F.departure=new Date(F.departure).getTime();F.resource=parseInt(F.resource,10);F.space=parseInt(F.space,10)}F.changed=true;z[G]=F},check_availability:function(F){var H=parseInt(F.id,10),G=true;h.each(z,function(I,J){if(J&&J.resource===F.resource&&J.space===F.space&&J.id!==H&&(F.arrival<J.departure&&F.departure>J.arrival)){G=false;return false}});return G},generate_column:function(K,J){var G="",O="",H=1,L=0,M=K.getDay()===0?6:K.getDay()-1;if(x==="86400"){G=h('<th><div class="date"><div>'+easyFormatDate(K,"d")+"</div><span>"+er_date_picker_params.day_names_min[M]+"</span></div></th>");if(K.getDate()===1){O="first"}}else{G=h("<th>"+easyFormatDate(K,"H")+"</th>");if(K.getHours()===0){O="first"}}if(O==="first"){G.append(h('<div class="first-of-month"></div>'))}if(K.getDate()===y.getDate()&&K.getMonth()===y.getMonth()&&K.getFullYear()===y.getFullYear()&&(x==="86400"||K.getHours()===y.getHours())){var N=h('<div class="today"></div>'),F=h('<div class="overlay"></div>'),I=0;if(x==="86400"){I=n.width/86400*(y.getHours()*3600+y.getMinutes()*60)}else{I=n.width/3600*(y.getMinutes()*60)}N.css("left",I);F.css("left",I).css("width",I).css("margin-left",-I);G.append(N).append(F);O+=" today"}else{if(K<y){O+=" past"}}if(x==="86400"&&(K.getDay()===0||K.getDay()===6)){O+=" weekend"}G.addClass(O).attr("data-date",K.getTime()+(K.getTimezoneOffset()*1000*60)+3600000);O+=" loading";if(J){k.prepend(G)}else{k.append(G)}h.each(D.resources,function(S,R){var Q=h('<td class="resource"><div style="height:20px;pointer-events:none"></div></td>').addClass(O).attr("data-resource",S).attr("data-date",K.getTime()+(K.getTimezoneOffset()*1000*60)+3600000);if(J){a.find("tr:nth-child("+H+")").prepend(Q)}else{a.find("tr:nth-child("+H+")").append(Q)}for(L=1;L<=(R.availability_by==="unit"?R.quantity:1);L++){var P=h('<td class="cell" style="height:'+n.height+'px"></td>').addClass(O).attr("data-resource",S).data("reservations",[]).attr("data-space",L).attr("data-date",K.getTime()+(K.getTimezoneOffset()*1000*60)+3600000);H++;if(J){a.find("tr:nth-child("+H+")").prepend(P)}else{a.find("tr:nth-child("+H+")").append(P)}P.droppable({scope:"reservations",drop:function(U,V){var X=parseInt(V.draggable.attr("data-id"),10),W=x/n.width*(V.position.left-E.left),T={id:X,arrival:z[X].arrival+(W*1000),departure:z[X].departure+(W*1000),resource:parseInt(h(this).attr("data-resource"),10),space:parseInt(h(this).attr("data-space"),10)};if(er_both_params.resources[T.resource].availability_by!=="unit"||s.check_availability(T)){s.recursively_remove_reservation(z[X]);z[X].arrival=T.arrival;z[X].departure=T.departure;z[X].resource=T.resource;z[X].space=T.space;z[X].changed=true;V.draggable.remove();s.draw_reservations()}else{V.draggable.animate(E,500,function(){})}},over:function(T,U){}})}H++});if(J){if(p===0||p-(x*1000*10)>K.getTime()){s.load_data(i,new Date(p));p=K.getTime()}}else{if(B+(x*1000*10)<K.getTime()){s.load_data(new Date(B),new Date(e.getTime()+(x*1000)));B=K.getTime()}}}};s.init()})(jQuery,er_timeline_params);