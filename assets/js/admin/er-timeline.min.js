(function(h,D){var g=h(".er-timeline-tooltip"),m=h(".er-timeline"),o=h("#timeline-datepicker"),l=m.find("div.timeline"),t=m.find("div.header"),u=m.find("div.resources table"),z=t.find(".date"),v=l.find("table"),k=l.find("thead tr"),a=v.find("tbody"),y=[],x=new Date(),i=new Date(),e=false,E=false,f=false,q=false,d=0,c=0,C=true,B=false,b=false,s=false,n={height:27,width:96},j=0,p=0,A=0,w=D.default_interval;m.insertAfter("hr.wp-header-end");g.insertAfter("hr.wp-header-end");t.bind("click",function(){o.datepicker("show")});o.bind("change",function(){i=h(this).datepicker("getDate");r.init()});l.find("thead").on({mousedown:function(F){b=l.scrollLeft()+F.pageX}});h(window).mouseup(function(){k.css("cursor","grab");clearInterval(b);b=false;r.clear_scroll_timeout()});m.mousemove(function(F){d=F.pageX;c=F.pageY;if(b&&h.isNumeric(b)&&F.which===1){l.scrollLeft(b-F.pageX<1?1:b-F.pageX);if(s===false){k.css("cursor","grabbing");r.scroll()}}if(j!==F.target){j=F.target;console.log(j);if(j.getAttribute("data-date")){r.highlight_current(new Date(parseInt(F.target.getAttribute("data-date"),10)))}if(j.getAttribute("data-space")){B=h(j).offset().top}else{if(j.getAttribute("data-id")){B=h(j).parent().offset().top}}}}).mouseleave(function(){k.css("cursor","grab");clearInterval(b);b=false;r.clear_scroll_timeout()}).on("mousedown",".next",function(){if(b===false){b=setInterval(function(){if(b!==false){l.scrollLeft(l.scrollLeft()+n.width);r.scroll()}},100)}}).on("mousedown",".prev",function(){if(b===false){b=setInterval(function(){if(b!==false){l.scrollLeft(l.scrollLeft()-n.width);r.scroll()}},100)}});l.scroll(function(){if(b!==false){k.css("cursor","grabbing")}});var r={init:function(){if(w==="86400"){i.setHours(0,0,0,0)}else{i.setHours(i.getHours(),0,0,0)}l.scrollLeft(1);var F=i,G;r.set_current_date(x);v.find("td,th").remove();F.setTime(F.getTime()-(10*w*1000));A=F.getTime();p=F.getTime();for(G=0;G<50;G++){e=new Date(F.getTime()+(G*w*1000));r.generate_column(e)}r.load_remaining();l.scrollLeft(k.find("th:nth-child(9)").offset().left-l.offset().left+l.scrollLeft()+1)},slide_current:function(G){var F=k.find("th:nth-child("+(Math.round(l.scrollLeft()/n.width)+(3))+")");r.highlight_current(new Date(F.data("date")))},highlight_current:function(F){r.set_current_date(F);h(".er-timeline .current").removeClass("current");h('*[data-date="'+F.getTime()+'"]').addClass("current")},set_current_date:function(F){if(w==="3600"){z.html(F.getDate()+" "+er_date_picker_params.month_names[F.getMonth()]+" "+F.getFullYear())}else{z.html(er_date_picker_params.month_names[F.getMonth()]+" "+F.getFullYear())}o.val(F.getDate()+"."+(F.getMonth()+1)+"."+F.getFullYear())},scroll:function(){if(s===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){s=setInterval(function(){if(s!==false){r.add_new_column(l.scrollLeft()<2)}},38)}},add_new_column:function(F){if(F){i.setTime(i.getTime()-(w*1000));r.generate_column(i,true);r.set_current_date(i);v.find("th:last-child,td:last-child").remove();A-=(w*1000);e.setTime(e.getTime()-(w*1000))}else{e.setTime(e.getTime()+(w*1000));r.generate_column(e);r.set_current_date(e);v.find("th:first-child").remove();v.find("td:first-child").each(function(){var G=h(this).data("reservations");if(G&&G.length>0){h.each(G,function(H,I){if(y[I]&&typeof y[I]!=="undefined"){y[I].changed=true}})}}).remove();p+=(w*1000);i.setTime(i.getTime()+(w*1000))}},clear_scroll_timeout:function(){if(s!==false){clearInterval(s);s=false;r.load_remaining()}},load_remaining:function(){if(p===0||p>i.getTime()){r.load_data(i,new Date(p));p=i.getTime()}else{if(A<e.getTime()){r.load_data(new Date(A),new Date(e.getTime()+(w*1000)));A=e.getTime()}else{}}},load_data:function(G,F){h.ajax({url:D.ajax_url,data:{action:"easyreservations_timeline_data",security:D.nonce,start:G.getDate()+"."+(G.getMonth()+1)+"."+G.getFullYear(),start_hour:G.getHours(),end:F.getDate()+"."+(F.getMonth()+1)+"."+F.getFullYear(),end_hour:F.getHours(),interval:w},type:"POST",success:function(H){if(H.data){h.each(H.data,function(K,J){var I=D.resources[K].quantity;h.each(J,function(P,L){var N=new Date(parseInt(P,10)*1000),M="",O="";if(L<0){M="unavailable";O=0}else{O=I-L}h('td[data-date="'+(N.getTime()+(N.getTimezoneOffset()*1000*60))+'"][data-resource="'+K+'"]').removeClass("loading").addClass(M);h('tr.resource td[data-date="'+(N.getTime()+(N.getTimezoneOffset()*1000*60))+'"][data-resource="'+K+'"]').html('<div style="pointer-events:none">'+O+"</div>").addClass(L==I?"unavailable":"")})})}if(H.reservations){h.each(H.reservations,function(I,J){J.changed=true;r.add_reservation(J)});r.draw_reservations()}}})},draw_reservations:function(){var F=[];h.each(y,function(G,H){if(H&&H.changed){F.push(H.id)}});F.sort(function(H,G){return y[H].arrival<y[G].arrival?-1:1});h.each(F,function(G,H){if(H){if(!r.draw_reservation(y[H])){r.draw_reservations();return false}}})},recursively_remove_reservation:function(I){var J=parseInt(I.id,10),H=new Date(I.arrival),G=new Date(I.departure);if(w==="86400"){H.setHours(0,0,0);G.setHours(0,0,0)}else{H.setHours(H.getHours(),0,0);G.setHours(G.getHours(),0,0)}while(H<=G){var F=h('td[data-date="'+(H.getTime())+'"][data-resource="'+I.resource+'"][data-space="'+I.space+'"]');if(F.length>0){r.recursively_remove_reservations(F,I.depths,J)}H.setTime(H.getTime()+(w*1000))}return false},recursively_remove_reservations:function(G,K,L){var F=G.data("reservations"),J=[],H=false,I=0;if(F&&F.length>0){h.each(F,function(M,N){if(N){if(N===L||y[N].depths>=K){if(H===false){H=y[N].depths}H=Math.min(H,y[N].depths);q=true;y[N].changed=true}else{J.push(N);I=Math.max(I,y[N].depths)}}})}G.data("reservations",J);G.height(n.height+n.height*I);if(H!==false){return r.recursively_remove_reservations(G.next(),H,L)}return true},draw_reservation:function(H){var F=parseInt(H.id,10),I=new Date(H.arrival),J=new Date(H.departure),K=h('<div class="reservation">'),G=(H.departure-H.arrival),M=(((G/1000)/w)*n.width)-(w==="86400"?2:1),P=false,Q=[],N=0;q=false;h('.reservation[data-id="'+F+'"]').remove();if(w==="86400"){I.setHours(0,0,0);J.setHours(0,0,0)}else{I.setHours(I.getHours(),0,0);J.setHours(J.getHours(),0,0)}while(I<=J){var O=h('td[data-date="'+(I.getTime())+'"][data-resource="'+H.resource+'"][data-space="'+H.space+'"]');if(O&&O.length>0){var L=O.data("reservations");if(L.length>0){h.each(L,function(R,S){if(S&&S!==F){if(y[S].arrival>H.arrival&&y[S].arrival<H.departure&&y[S].departure>H.arrival){r.recursively_remove_reservations(O,N,S)}else{if(y[S].departure<=H.arrival||y[S].arrival>=H.departure){}else{Q[y[S].depths]=1}}}})}if(P===false){K.css("left",((((H.arrival-I.getTime())/1000)/w)*n.width)-1+"px");P=O}if(h.inArray(F,L)<0){L.push(F);O.data("reservations",L)}}I.setTime(I.getTime()+(w*1000))}if(P===false){delete y[F]}else{if(q){return false}else{K.html('<span class="wrapper"><span>#'+F+" "+H.title+"</span></span>").draggable({snap:C?false:"td.cell,.reservation",snapTolerance:3,grid:C?[96,28]:false,containment:a,revert:"invalid",stack:".reservation",scope:"reservations",start:function(R,S){E=S.originalPosition;f=S.offset},drag:function(T,U){var X=parseInt(U.helper.attr("data-id"),10),R=y[X],W=w/n.width*(U.position.left-U.originalPosition.left),S=d-l.offset().left,V=l.scrollLeft();g.html(easyFormatTime(new Date(R.arrival+(W*1000)))+" - "+easyFormatTime(new Date(R.departure+(W*1000)))).css({top:c,left:Math.min(d-130,l.width())}).show();if(B!==false){U.position.top=B-f.top+E.top}if(S<10||l.width()-S<10){l.scrollLeft(l.scrollLeft()+(S<10?n.width*-1:n.width));if(s===false){}}},stop:function(){g.hide()}}).resizable({handles:"e, w",grid:C?[96,28]:false,maxWidth:n.width*50,minHeight:0,minWidth:4,start:function(S,Y){var T=parseInt(Y.originalElement.attr("data-id"),10),U=h(this),Z=Y.originalElement.parent(),X=h(j).hasClass("ui-resizable-w");if(er_both_params.resources[y[T].resource].availability_by==="unit"){var W=Z.data("reservations"),R=[],V;if(X&&W.length>0){W.reverse()}h.each(W,function(aa,ab){if(V||ab===T){V=true;R.push(ab)}});while(Z.length>0){if(R.length>0){h.each(R,function(aa,ab){if(ab!==T){if(X){}else{}Z={length:0};return false}})}if(Z.length>0){if(X){Z=Z.prev()}else{Z=Z.next()}R=Z.data("reservations")}}}Y.helper.attr("style","left: "+Y.helper.css("left")+";width: "+Y.helper.css("width"))},resize:function(U,W){var X=parseInt(W.element.attr("data-id"),10),S=y[X],R=w/n.width*(W.position.left-W.originalPosition.left),V=w/n.width*(W.size.width+2),T="";if(W.position.left-W.originalPosition.left!==0){T=easyFormatTime(new Date(S.arrival+(R*1000)))}else{if(W.size.width-W.originalSize.width!==0){T=easyFormatTime(new Date(S.arrival+(V*1000)))}else{T=easyFormatTime(new Date(S.arrival+(R*1000)));T+=" - ";T+=easyFormatTime(new Date(S.arrival+(V*1000)))}}g.html(T).css({top:c,left:Math.min(d-130,l.width())}).show()},stop:function(T,V){var W=parseInt(V.element.attr("data-id"),10),R=w/n.width*(V.position.left-V.originalPosition.left),U=w/n.width*(V.size.width+2),S={id:W,arrival:y[W].arrival+(R*1000),departure:y[W].arrival+(R*1000)+(U*1000),resource:y[W].resource,space:y[W].space};if(er_both_params.resources[y[W].resource].availability_by!=="unit"||r.check_availability(S)){r.recursively_remove_reservation(y[W]);y[W].arrival=S.arrival;y[W].departure=S.departure;y[W].changed=true;r.draw_reservations()}else{V.originalElement.animate({width:V.originalSize.width,left:V.originalPosition.left},500,function(){})}g.hide()}}).css("min-width",M+"px").css("max-width",M+"px").css("top","0px").css("position","absolute").attr("data-tip",H.id).attr("data-id",H.id);P.append(K);while(Q[N]===1){N++}if(N>0){if(P.height()<n.height+n.height*N){P.height(n.height+n.height*N+1)}K.css("top",(n.height+1)*N+"px")}H.depths=N;H.changed=false;console.log("did draw "+F+"at depths "+N);y[F]=H}}return P},add_reservation:function(F){var G=parseInt(F.id,10);if(!h.isNumeric(F.arrival)){F.id=G;F.arrival=new Date(F.arrival).getTime();F.departure=new Date(F.departure).getTime();F.resource=parseInt(F.resource,10);F.space=parseInt(F.space,10)}F.changed=true;y[G]=F},check_availability:function(F){var H=parseInt(F.id,10),G=true;h.each(y,function(I,J){if(J&&J.resource===F.resource&&J.space===F.space&&J.id!==H&&(F.arrival<J.departure&&F.departure>J.arrival)){console.log("checkAvailabilty false because of");console.log(J);G=false;return false}});return G},generate_column:function(K,J){var G="",O="",H=1,L=0,M=K.getDay()===0?6:K.getDay()-1;if(w==="86400"){G=h('<th><div class="date"><div>'+easyFormatDate(K,"d")+"</div><span>"+er_date_picker_params.day_names_min[M]+"</span></div></th>");if(K.getDate()===1){O="first"}}else{G=h("<th>"+easyFormatDate(K,"H")+"</th>");if(K.getHours()===0){O="first"}}if(O==="first"){G.append(h('<div class="first-of-month"></div>'))}if(K.getDate()===x.getDate()&&K.getMonth()===x.getMonth()&&K.getFullYear()===x.getFullYear()&&(w==="86400"||K.getHours()===x.getHours())){var N=h('<div class="today"></div>'),F=h('<div class="overlay"></div>'),I=0;if(w==="86400"){I=n.width/86400*(x.getHours()*3600+x.getMinutes()*60)}else{I=n.width/3600*(x.getMinutes()*60)}N.css("left",I);F.css("left",I).css("width",I).css("margin-left",-I);G.append(N).append(F);O+=" today"}else{if(K<x){O+=" past"}}if(w==="86400"&&(K.getDay()===0||K.getDay()===6)){O+=" weekend"}G.addClass(O).attr("data-date",K.getTime()+(K.getTimezoneOffset()*1000*60)+3600000);O+=" loading";if(J){k.prepend(G)}else{k.append(G)}h.each(D.resources,function(S,R){var Q=h('<td class="resource"><div style="height:20px;pointer-events:none"></div></td>').addClass(O).attr("data-resource",S).attr("data-date",K.getTime()+(K.getTimezoneOffset()*1000*60)+3600000);if(J){a.find("tr:nth-child("+H+")").prepend(Q)}else{a.find("tr:nth-child("+H+")").append(Q)}for(L=1;L<=(R.availability_by==="unit"?R.quantity:1);L++){var P=h('<td class="cell"></td>').addClass(O).attr("data-resource",S).data("reservations",[]).attr("data-space",L).attr("data-date",K.getTime()+(K.getTimezoneOffset()*1000*60)+3600000);H++;if(J){a.find("tr:nth-child("+H+")").prepend(P)}else{a.find("tr:nth-child("+H+")").append(P)}P.droppable({scope:"reservations",drop:function(V,W){var T=h(this);if(j.getAttribute("data-space")){T=h(j)}var Y=parseInt(W.draggable.attr("data-id"),10),X=w/n.width*(W.position.left-E.left),U={id:Y,arrival:y[Y].arrival+(X*1000),departure:y[Y].departure+(X*1000),resource:parseInt(T.attr("data-resource"),10),space:parseInt(T.attr("data-space"),10)};if(er_both_params.resources[U.resource].availability_by!=="unit"||r.check_availability(U)){r.recursively_remove_reservation(y[Y]);y[Y].arrival=U.arrival;y[Y].departure=U.departure;y[Y].resource=U.resource;y[Y].space=U.space;y[Y].changed=true;W.draggable.remove();r.draw_reservations()}else{W.draggable.animate({top:E.top-1,left:E.left},500,function(){})}},over:function(T,U){console.log(123)}})}H++});if(J){if(p===0||p-(w*1000*10)>K.getTime()){r.load_data(i,new Date(p));p=K.getTime()}}else{if(A+(w*1000*10)<K.getTime()){r.load_data(new Date(A),new Date(e.getTime()+(w*1000)));A=K.getTime()}}}};r.init()})(jQuery,er_timeline_params);