var tag_before="",tag_edit=false,savedSelection=false,insert_began=[];function bindFormtag(){jQuery("formtag").off("click").on("click",function(){tag_before=this;var d=jQuery(this).html().replace("[","").replace("]","");var a={},e=0,c,b;c=/(\w+)\s*=\s*"([^"]*)"(?:\s|$)|(\w+)\s*=\s*\'([^\']*)\'(?:\s|$)|(\w+)\s*=\s*([^\s\'"]+)(?:\s|$)|"([^"]*)"(?:\s|$)|(\S+)(?:\s|$)/g;d=d.replace(/[\u00a0\u200b]/g," ");while((b=c.exec(d))){if(b[1]){a[b[1]]=b[2]}else{if(b[3]){a[b[3]]=b[4]}else{if(b[5]){a[b[5]]=b[6]}else{if(b[7]){a[e]=b[7];e++}else{if(b[8]){a[e]=b[8];e++}}}}}}tag_edit=true;generateTagEdit(a[0],a)})}bindFormtag();jQuery("table.formtable tbody tr").on("click",function(){if(jQuery(this).attr("attr")){generateTagEdit(jQuery(this).attr("attr"))}else{if(jQuery(this).attr("bttr")){var c={b:{0:"<strong>",1:"</strong>"},i:{0:"<i>",1:"</i>"},label:{0:"<label>",1:"</label>"},small:{0:"<small>",1:"</small>"},row:{0:'<div class="row">',1:"</div>"},div:{0:'<div class="content">',1:"</div>"},h1:{0:"<h1>",1:"</h1>"},h2:{0:"<h2>",1:"</h2>"}},b=jQuery(this).attr("bttr");if(c[b]){var a=false;if(c[b][1]){a=c[b][1]}insertTag(b,c[b][0],a)}}}}).on("mouseenter mouseleave",function(){var a=jQuery(this).attr("attr");jQuery('formtag[attr="'+a+'"]').toggleClass("taghover")});jQuery("#form_container").on("click",function(){savedSelection=saveSelection()}).on("keydown",function(d){if(d.which===13){if(window.getSelection){var c=window.getSelection(),a=c.getRangeAt(0),b=document.createElement("br"),f=document.createTextNode("\n");a.insertNode(b);a.insertNode(f);a.setStartAfter(b);a.setEndAfter(b);a.collapse(false);c.removeAllRanges();c.addRange(a)}return false}});function generateTagEdit(c,a){if(fields[c]){var e="Add";if(a){e="Edit"}jQuery("*[name=deltag]").remove();var d='<h3 name="deltag">'+e+" "+fields[c]["name"]+' field</h3><div name="deltag"><input type="hidden" name="0" value="'+c+'">';d+='<p class="desc">'+fields[c]["desc"]+"</p>";var b=fields[c]["options"];if(typeof b=="function"){d+=b(a)}else{jQuery.each(b,function(g,f){if(f.title&&f.input!="check"){d+="<h4>"+f.title+"</h4>"}d+="<p>";var h=false,i="";if(f["class"]){i=' class="'+f["class"]+'"'}if(a&&a[g]){h=a[g]}else{if(f["default"]){h=f["default"]}else{h=""}}if(typeof f.input=="function"){d+=f.input(a)}else{if(f.input=="text"){d+='<input type="text" name="'+g+'" value="'+h+'"'+i+">"}else{if(f.input=="amount"){d+='<input type="number" name="'+g+'" value="'+h+'"'+i+">"}else{if(f.input=="textarea"){d+='<textarea name="'+g+'"'+i+">"+h+"</textarea>"}else{if(f.input=="check"){if(a&&a[g]||(!a&&f.checked)){h='checked="checked" '}else{h=""}d+='<label class="wrapper"><input type="checkbox" name="'+g+'" value="'+f["default"]+'" '+h+i+">"+f.title+"</label>"}else{if(f.input=="select"){d+='<select name="'+g+'"'+i+">";d+=generateOptions(f.options,h);d+="</select>"}}}}}}d+="</p>"})}d+='<div class="easy-ui" style="margin-top: 5px">';d+='<a href="javascript:" class="button-primary" onclick="submitTag();">'+e+"</a>&nbsp;";d+='<a href="javascript:" class="button" onclick="deactivateTag();">Cancel</a>';d+="</div>";d+="</div>";jQuery("#accordion").prepend(d).accordion("destroy").accordion({heightStyle:"content",autoHeight:false,icons:{header:"ui-icon-plus",activeHeader:"ui-icon-minus"}})}}function submitTag(){var b="";var a=false;jQuery("*[name=deltag] :input:not(.not)").each(function(c,d){if(d.value!=""&&(d.type!="checkbox"||d.checked==true)){if(!a){a=d.value}if(d.name=="*"||(!isNaN(parseFloat(d.name))&&isFinite(d.name))){if(jQuery(this).hasClass("quote")){b+='"'+d.value+'" '}else{b+=d.value+" "}}else{b+=d.name+'="'+d.value+'" '}}});if(fields[a]&&fields[a]["generate"]){b+=fields[a]["generate"]()}b=b.substr(0,b.length-1);b="["+b+"]";if(tag_edit){jQuery(tag_before).html(b)}else{insertAtCaret('<formtag attr="'+a+'">'+b+"</formtag>")}deactivateTag();bindFormtag()}function deactivateTag(){tag_edit=false;jQuery("*[name=deltag]").fadeOut("fast");jQuery("#accordion").accordion("destroy").accordion({heightStyle:"content",autoHeight:false,icons:{header:"ui-icon-plus",activeHeader:"ui-icon-minus"}})}function insertAtCaret(a){if(savedSelection){restoreSelection(a)}else{jQuery("#form_container").prepend(a)}}if(window.getSelection){saveSelection=function(){var d=window.getSelection(),b=[];if(d.rangeCount){for(var c=0,a=d.rangeCount;c<a;++c){b.push(d.getRangeAt(c))}}return b};restoreSelection=function(h){var b=window.getSelection();b.removeAllRanges();for(var e=0,g=savedSelection.length;e<g;++e){b.addRange(savedSelection[e])}var f=b.getRangeAt(0);f.collapse(false);var c=document.createElement("div");c.innerHTML=h;var j=document.createDocumentFragment(),d,a;while((d=c.firstChild)){a=j.appendChild(d)}f.insertNode(j);b.removeAllRanges()};insertTag=function(d,g,b){if(savedSelection){var e=window.getSelection();e.removeAllRanges();for(var c=0,a=savedSelection.length;c<a;++c){e.addRange(savedSelection[c])}if(!e.type||e.type=="None"||e.type=="Caret"){if(b&&insert_began[g]){insert_began[g]=null;document.execCommand("insertText",true,b);jQuery('tr[bttr="'+d+'"] tag').text(g)}else{if(b){insert_began[g]=1;jQuery('tr[bttr="'+d+'"] tag').text(b)}document.execCommand("insertText",true,g)}}else{var f=window.getSelection();f=g+f;if(b){f+=b}document.execCommand("insertText",true,f)}savedSelection=saveSelection()}else{jQuery("#form_container").prepend(g)}}}else{if(document.selection&&document.selection.createRange){saveSelection=function(){var a=document.selection;return(a.type!="None")?a.createRange():null};restoreSelection=function(a){if(savedSelection){savedSelection.select();document.selection.createRange().text=a}};insertTag=function(){alert("Function not available in your browser")}}}function htmlForTextWithEmbeddedNewlines(e){var d=[];var b=e.split(/\n/);var a=jQuery(document.createElement("div"));for(var c=0;c<b.length;c++){d.push(a.text(b[c]).html())}return d.join("<br>\n")};