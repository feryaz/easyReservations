(function(h,A){var f=h(".er-overview-tooltip"),B=h(".er-overview"),o=h("#overview-datepicker"),l=B.find("div.timeline"),s=B.find("div.header"),x=s.find(".date"),t=l.find("table"),k=l.find("thead tr"),a=t.find("tbody"),w=[],v=new Date(),i=new Date(),e=false,C=false,g=false,q=false,d=0,c=0,z=false,b=false,r=false,n={height:27,width:96},j=0,p=0,y=0,u=A.default_interval;B.insertAfter("hr.wp-header-end");f.insertAfter("hr.wp-header-end");s.bind("click",function(){o.datepicker("show")});o.bind("change",function(){i=h(this).datepicker("getDate");m.init()});l.find("thead").on({mousedown:function(D){b=l.scrollLeft()+D.pageX}});h(window).mouseup(function(){k.css("cursor","grab");clearInterval(b);b=false;m.clear_scroll_timeout()});B.mousemove(function(D){d=D.pageX;c=D.pageY;if(b&&h.isNumeric(b)&&D.which===1){l.scrollLeft(b-D.pageX<1?1:b-D.pageX);if(r!==false){k.css("cursor","grabbing");m.scroll()}}if(j!==D.target){j=D.target;if(D.target.getAttribute("data-date")){m.highlight_current(new Date(parseInt(D.target.getAttribute("data-date"),10)))}if(D.target.getAttribute("data-space")||D.target.getAttribute("data-id")){z=h(D.target).offset().top}}}).mouseleave(function(){k.css("cursor","grab");clearInterval(b);b=false;m.clear_scroll_timeout()}).on("mousedown",".next",function(){if(b===false){b=setInterval(function(){if(b!==false){l.scrollLeft(l.scrollLeft()+n.width);m.scroll()}},100)}}).on("mousedown",".prev",function(){if(b===false){b=setInterval(function(){if(b!==false){l.scrollLeft(l.scrollLeft()-n.width);m.scroll()}},100)}});l.scroll(function(){if(b!==false){k.css("cursor","grabbing");m.scroll()}});var m={init:function(){if(u==="86400"){i.setHours(0,0,0,0)}else{i.setHours(i.getHours(),0,0,0)}l.scrollLeft(1);var D=i,E;m.set_current_date(v);t.find("td,th").remove();D.setTime(D.getTime()-(10*u*1000));y=D.getTime();p=D.getTime();for(E=0;E<50;E++){e=new Date(D.getTime()+(E*u*1000));m.generate_column(e)}m.load_remaining();l.scrollLeft(k.find("th:nth-child(9)").offset().left-l.offset().left+l.scrollLeft()+1)},slide_current:function(E){var D=k.find("th:nth-child("+(Math.round(l.scrollLeft()/n.width)+(3))+")");m.highlight_current(new Date(D.data("date")))},highlight_current:function(D){m.set_current_date(D);h(".er-overview .current").removeClass("current");h('*[data-date="'+D.getTime()+'"]').addClass("current")},set_current_date:function(D){if(u==="3600"){x.html(D.getDate()+" "+er_date_picker_params.month_names[D.getMonth()]+" "+D.getFullYear())}else{x.html(er_date_picker_params.month_names[D.getMonth()]+" "+D.getFullYear())}o.val(D.getDate()+"."+(D.getMonth()+1)+"."+D.getFullYear())},scroll:function(){if(r===false&&(l.scrollLeft()<2||l[0].scrollWidth-(l.width()+l.scrollLeft())<2)){r=setInterval(function(){if(r!==false){if(l.scrollLeft()<2){i.setTime(i.getTime()-(u*1000));m.generate_column(i,true);m.set_current_date(i);t.find("th:last-child,td:last-child").remove();y-=(u*1000);e.setTime(e.getTime()-(u*1000))}else{if(l[0].scrollWidth-(l.width()+l.scrollLeft())<2){e.setTime(e.getTime()+(u*1000));m.generate_column(e);m.set_current_date(e);t.find("th:first-child,td:first-child").each(function(){var D=h(this).data("reservations");if(D&&D.length>0){h.each(D,function(E,F){if(w[F]&&typeof w[F]!=="undefined"){w[F].changed=true}})}}).remove();p+=(u*1000);i.setTime(i.getTime()+(u*1000))}}}},35)}},clear_scroll_timeout:function(){if(r!==false){clearInterval(r);r=false;m.load_remaining()}},load_remaining:function(){if(p===0||p>i.getTime()){m.load_data(i,new Date(p));p=i.getTime()}else{if(y<e.getTime()){m.load_data(new Date(y),new Date(e.getTime()+(u*1000)));y=e.getTime()}else{}}},load_data:function(E,D){h.ajax({url:A.ajax_url,data:{action:"easyreservations_overview_data",security:A.nonce,start:E.getDate()+"."+(E.getMonth()+1)+"."+E.getFullYear(),start_hour:E.getHours(),end:D.getDate()+"."+(D.getMonth()+1)+"."+D.getFullYear(),end_hour:D.getHours(),interval:u},type:"POST",success:function(F){if(F.data){h.each(F.data,function(I,H){var G=A.resources[I].quantity;h.each(H,function(N,J){var L=new Date(parseInt(N,10)*1000),K="",M="";if(J<0){K="unavailable";M=0}else{M=G-J}h('td[data-date="'+(L.getTime()+(L.getTimezoneOffset()*1000*60))+'"][data-resource="'+I+'"]').removeClass("loading").addClass(K);h('tr.header td[data-date="'+(L.getTime()+(L.getTimezoneOffset()*1000*60))+'"][data-resource="'+I+'"]').html('<div style="pointer-events:none">'+M+"</div>").addClass(J==G?"unavailable":"")})})}if(F.reservations){h.each(F.reservations,function(G,H){H.changed=true;m.add_reservation(H)});m.draw_reservations()}}})},draw_reservations:function(){var D=[];h.each(w,function(E,F){if(F&&F.changed){D.push(F.id)}});D.sort(function(F,E){return w[F].arrival<w[E].arrival?-1:1});h.each(D,function(E,F){if(F){if(!m.draw_reservation(w[F])){m.draw_reservations();return false}}})},recursively_remove_reservation:function(G){var H=parseInt(G.id,10),F=new Date(G.arrival),E=new Date(G.departure);if(u==="86400"){F.setHours(0,0,0);E.setHours(0,0,0)}else{F.setHours(F.getHours(),0,0);E.setHours(E.getHours(),0,0)}while(F<=E){var D=h('td[data-date="'+(F.getTime())+'"][data-resource="'+G.resource+'"][data-space="'+G.space+'"]');if(D.length>0){m.recursively_remove_reservations(D,G.depths,H)}F.setTime(F.getTime()+(u*1000))}return false},recursively_remove_reservations:function(E,H,I){var D=E.data("reservations"),F=false,G=0;if(D.length>0){h.each(D,function(J,K){if(K){if(K===I||w[K].depths>=H){if(F===false){F=w[K].depths}F=Math.min(F,w[K].depths);q=true;w[K].changed=true;D.splice(J,1)}else{G=Math.max(G,w[K].depths)}}})}E.data("reservations",D);E.height(n.height+n.height*G);if(F!==false){return m.recursively_remove_reservations(E.next(),F,I)}return true},draw_reservation:function(F){var D=parseInt(F.id,10),G=new Date(F.arrival),H=new Date(F.departure),I=h('<div class="reservation">'),E=(F.departure-F.arrival),K=(((E/1000)/u)*n.width)-(u==="86400"?2:1),N=false,O=[],L=0;q=false;h('.reservation[data-id="'+D+'"]').remove();if(u==="86400"){G.setHours(0,0,0);H.setHours(0,0,0)}else{G.setHours(G.getHours(),0,0);H.setHours(H.getHours(),0,0)}while(G<=H){var M=h('td[data-date="'+(G.getTime())+'"][data-resource="'+F.resource+'"][data-space="'+F.space+'"]');if(M.length>0){var J=M.data("reservations");if(J.length>0){h.each(J,function(P,Q){if(Q&&Q!==D){if(w[Q].arrival>F.arrival&&w[Q].departure>F.arrival){m.recursively_remove_reservations(M,L,Q)}else{if(w[Q].departure<=F.arrival){console.log("could go in "+w[Q].depths+" because of "+Q)}else{O[w[Q].depths]=1;console.log(D+" cannot go in "+w[Q].depths+" because of "+Q)}}}})}if(N===false){I.css("left",((((F.arrival-G.getTime())/1000)/u)*n.width)-1+"px");N=M}if(h.inArray(D,J)<0){J.push(D);M.data("reservations",J)}}G.setTime(G.getTime()+(u*1000))}if(N===false){delete w[D]}else{if(q){return false}else{I.html("#"+D+" "+F.title).draggable({snapTolerance:3,appendTo:"td.cell",containment:a,revert:"invalid",stack:".reservation",scope:"reservations",snap:"td.cell,.reservation",start:function(P,Q){C=Q.originalPosition;g=Q.offset},drag:function(Q,R){var T=parseInt(R.helper.attr("data-id"),10),P=w[T],S=u/n.width*(R.position.left-R.originalPosition.left);f.html(easyFormatTime(new Date(P.arrival+(S*1000)))+" - "+easyFormatTime(new Date(P.departure+(S*1000)))).css({top:c,left:d-130}).show();if(z!==false){R.position.top=z-g.top+C.top}},stop:function(){f.hide()}}).resizable({containment:a,handles:"e",maxWidth:n.width*50,minWidth:4,start:function(S,T){var U=parseInt(T.originalElement.attr("data-id"),10),R=h(this),P=T.originalElement.parent();while(P.length>0){var Q=P.find(".reservation");P=P.next();if(Q.length>0){h.each(Q,function(V,W){var X=parseInt(h(W).attr("data-id"));if(X!==U){R.resizable("option","maxWidth",(w[X].arrival-w[U].departure)/(u*1000)*n.width+T.originalSize.width+1);P={length:0};return false}})}}T.helper.attr("style","left: "+T.helper.css("left"))},resize:function(Q,R){var T=parseInt(R.element.attr("data-id"),10),P=w[T],S=u/n.width*(R.size.width+1);f.html(easyFormatTime(new Date(P.arrival+(S*1000)))).css({top:c,left:d-130}).show()},stop:function(Q,R){var T=parseInt(R.element.attr("data-id"),10),P=w[T],S=u/n.width*(R.size.width+1);P.departure=P.arrival+(S*1000);m.draw_reservation(P);f.hide()}}).css("min-width",K+"px").css("max-width",K+"px").css("position","absolute").attr("data-tip",F.id).attr("data-id",F.id);N.append(I);while(O[L]===1){L++}if(L>0){if(N.height()<n.height+n.height*L){N.height(n.height+n.height*L)}I.css("top",n.height*L+"px")}F.depths=L;F.changed=false;console.log("did draw "+D+"at depths "+L);w[D]=F}}return N},add_reservation:function(D){var E=parseInt(D.id,10);if(!h.isNumeric(D.arrival)){D.id=E;D.arrival=new Date(D.arrival).getTime();D.departure=new Date(D.departure).getTime();D.resource=parseInt(D.resource,10);D.space=parseInt(D.space,10)}D.changed=true;w[E]=D},check_availability:function(D){var F=parseInt(D.id,10),E=true;h.each(w,function(G,H){if(H&&H.resource===D.resource&&H.space===D.space&&H.id!==F&&(D.arrival<H.departure&&D.departure>H.arrival)){E=false;return false}});return E},generate_column:function(I,H){var E="",M="",F=1,J=0,K=I.getDay()===0?6:I.getDay()-1;if(u==="86400"){E=h('<th><div class="date"><div>'+easyFormatDate(I,"d")+"</div><span>"+er_date_picker_params.day_names_min[K]+"</span></div></th>");if(I.getDate()===1){M="first"}}else{E=h("<th>"+easyFormatDate(I,"H")+"</th>");if(I.getHours()===0){M="first"}}if(M==="first"){E.append(h('<div class="first-of-month"></div>'))}if(I.getDate()===v.getDate()&&I.getMonth()===v.getMonth()&&I.getFullYear()===v.getFullYear()&&(u==="86400"||I.getHours()===v.getHours())){var L=h('<div class="today"></div>'),D=h('<div class="overlay"></div>'),G=0;if(u==="86400"){G=n.width/86400*(v.getHours()*3600+v.getMinutes()*60)}else{G=n.width/3600*(v.getMinutes()*60)}L.css("left",G);D.css("left",G).css("width",G).css("margin-left",-G);E.append(L).append(D);M+=" today"}else{if(I<v){M+=" past"}}if(u==="86400"&&(I.getDay()===0||I.getDay()===6)){M+=" weekend"}E.addClass(M).attr("data-date",I.getTime()+(I.getTimezoneOffset()*1000*60)+3600000);M+=" loading";if(H){k.prepend(E)}else{k.append(E)}h.each(A.resources,function(Q,P){var O=h('<td class="resource"><div style="height:20px;pointer-events:none"></div></td>').addClass(M).attr("data-resource",Q).attr("data-date",I.getTime()+(I.getTimezoneOffset()*1000*60)+3600000);if(H){a.find("tr:nth-child("+F+")").prepend(O)}else{a.find("tr:nth-child("+F+")").append(O)}for(J=1;J<=(P.availability_by==="unit"?P.quantity:1);J++){var N=h('<td class="cell" style="height:'+n.height+'px"></td>').addClass(M).attr("data-resource",Q).data("reservations",[]).attr("data-space",J).attr("data-date",I.getTime()+(I.getTimezoneOffset()*1000*60)+3600000);F++;if(H){a.find("tr:nth-child("+F+")").prepend(N)}else{a.find("tr:nth-child("+F+")").append(N)}N.droppable({scope:"reservations",drop:function(S,T){var V=parseInt(T.draggable.attr("data-id"),10),U=u/n.width*(T.position.left-C.left),R={id:V,arrival:w[V].arrival+(U*1000),departure:w[V].departure+(U*1000),resource:parseInt(h(this).attr("data-resource"),10),space:parseInt(h(this).attr("data-space"),10)};if(er_both_params.resources[R.resource].availability_by!=="unit"||m.check_availability(R)){console.log("recursivly delete");m.recursively_remove_reservation(w[V]);w[V].arrival=R.arrival;w[V].departure=R.departure;w[V].resource=R.resource;w[V].space=R.space;w[V].changed=true;T.draggable.remove();m.draw_reservations()}else{T.draggable.animate(C,500,function(){})}},over:function(R,S){}})}F++});if(H){if(p===0||p-(u*1000*10)>I.getTime()){m.load_data(i,new Date(p));p=I.getTime()}}else{if(y+(u*1000*10)<I.getTime()){m.load_data(new Date(y),new Date(e.getTime()+(u*1000)));y=I.getTime()}}}};m.init()})(jQuery,er_overview_params);