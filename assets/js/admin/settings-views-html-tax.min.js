(function(c,b,a){c(function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}const k=a.template("er-tax-table-row"),o=a.template("er-tax-table-row-empty"),f=a.template("er-tax-table-pagination"),m=c(".er_tax_rates"),g=c("#rates"),h=c("#rates-pagination"),l=c("#rates-search .er-tax-rates-search-field"),e=c(".button-primary[name=save]"),j=Backbone.Model.extend({changes:{},setRateAttribute:function(q,s,t){const p=_.indexBy(this.get("rates"),"id"),r={};if(p[q][s]!==t){r[q]={};r[q][s]=t;p[q][s]=t}this.logChanges(r)},logChanges:function(p){const q=this.changes||{};_.each(p,function(r,s){q[s]=_.extend(q[s]||{id:s},r)});this.changes=q;this.trigger("change:rates")},getFilteredRates:function(){const p=l.val().toLowerCase();let rates=this.get("rates");if(p.length){rates=_.filter(rates,function(q){const r=_.toArray(q).join(" ").toLowerCase();return(-1!==r.indexOf(p))})}rates=_.sortBy(rates,function(q){return parseInt(q.order,10)});return rates},block:function(){m.block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){m.unblock()},save:function(){}}),d=Backbone.View.extend({rowTemplate:k,per_page:b.limit,page:b.page,initialize:function(){const p=Math.ceil(_.toArray(this.model.get("rates")).length/this.per_page);this.qty_pages=0===p?1:p;this.page=this.sanitizePage(b.page);this.listenTo(this.model,"change:rates",this.setUnloadConfirmation);this.listenTo(this.model,"saved:rates",this.clearUnloadConfirmation);g.on("change autocompletechange",":input",{view:this},this.updateModelOnChange);l.on("keyup search",{view:this},this.onSearchField);h.on("click","a",{view:this},this.onPageChange);h.on("change","input",{view:this},this.onPageChange);c(window).on("beforeunload",{view:this},this.unloadConfirmation);e.on("click",{view:this},this.onSubmit);m.find(".insert").on("click",{view:this},this.onAddNewRow);m.find(".remove_tax_rates").on("click",{view:this},this.onDeleteRow);m.find(".export").on("click",{view:this},this.onExport)},render:function(){const s=this.model.getFilteredRates(),r=_.size(s),u=Math.ceil(r/this.per_page),q=0===r?0:this.per_page*(this.page-1),v=this.per_page*this.page,t=_.toArray(s).slice(q,v),p=this;this.$el.empty();if(t.length){c.each(t,function(x,w){p.$el.append(p.rowTemplate(w))})}else{p.$el.append(o())}if(u>1){h.html(f({qty_rates:r,current_page:this.page,qty_pages:u}))}else{h.empty();p.page=1}},updateUrl:function(){if(!window.history.replaceState){return}const p=l.val();let url=b.base_url;if(1<this.page){url+="&p="+encodeURIComponent(this.page)}if(p.length){url+="&s="+encodeURIComponent(p)}window.history.replaceState({},"",url)},onSubmit:function(p){p.data.view.clearUnloadConfirmation()},onAddNewRow:function(p){const u=p.data.view,s=u.model,x=_.indexBy(s.get("rates"),"id"),w={},z=_.size(x),y=_.extend({},b.default_rate,{id:"new-"+z+"-"+Date.now(),newRow:true}),q=g.children(".current");if(q.length){const t=q.last().data("id");const r=parseInt(x[t].order,10);y.order=1+r;const v=_.filter(x,function(A){return parseInt(A.order,10)>r});_.map(v,function(A){A.order++;w[A.id]=_.extend(w[A.id]||{},{order:A.order});return A})}else{y.order=1+_.max(_.pluck(x,"order"),function(A){return parseInt(A,10)});u.page=u.qty_pages}x[y.id]=y;w[y.id]=y;s.set("rates",x);s.logChanges(w);u.render()},onDeleteRow:function(u){const p=u.data.view,q=p.model,r=_.indexBy(q.get("rates"),"id"),t={},s=g.children(".current");u.preventDefault();if(s){s.each(function(){let currentId=c(this).data("id");delete r[currentId];t[currentId]=_.extend(t[currentId]||{},{deleted:"deleted"})});q.set("rates",r);q.logChanges(t);p.render()}else{window.alert(b.strings.no_rows_selected)}},onSearchField:function(p){p.data.view.updateUrl();p.data.view.render()},onPageChange:function(q){const p=c(q.currentTarget);q.preventDefault();q.data.view.page=p.data("goto")?p.data("goto"):p.val();q.data.view.render();q.data.view.updateUrl()},onExport:function(p){let csvData="data:application/csv;charset=utf-8,"+b.strings.csv_data_cols.join(",")+"\n";c.each(p.data.view.model.getFilteredRates(),function(r,q){let row=q.country+",";row+=q.state+",";row+=(q.postcode?q.postcode.join("; "):"")+",";row+=(q.city?q.city.join("; "):"")+",";row+=q.tax_rate+",";row+=q.name+",";row+=q.priority+",";row+=q.compound+",";row+=b.current_class;csvData+=row+"\n"});c(this).attr("href",encodeURI(csvData));return true},setUnloadConfirmation:function(){this.needsUnloadConfirm=true},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false},unloadConfirmation:function(p){if(p.data.view.needsUnloadConfirm){p.returnValue=b.strings.unload_confirmation_msg;window.event.returnValue=b.strings.unload_confirmation_msg;return b.strings.unload_confirmation_msg}},updateModelOnChange:function(s){const q=s.data.view.model,p=c(s.target),t=p.closest("tr").data("id"),r=p.data("attribute");let val=p.val();if("compound"===r||"flat"===r){if(p.is(":checked")){val=1}else{val=0}}q.setRateAttribute(t,r,val)},sanitizePage:function(p){p=parseInt(p,10);if(p<1){p=1}else{if(p>this.qty_pages){p=this.qty_pages}}return p}}),n=new j({rates:b.rates}),i=new d({model:n,el:"#rates"});i.render()})}(jQuery,htmlSettingsTaxLocalizeScript,wp));