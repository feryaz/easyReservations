(function(c,b,a){c(function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}var j=a.template("er-tax-table-row"),i=a.template("er-tax-table-row-empty"),f=a.template("er-tax-table-pagination"),g=c(".er_tax_rates"),e=c("#rates"),d=c("#rates-pagination"),h=c("#rates-search .er-tax-rates-search-field"),k=c(".button-primary[name=save]");ERTaxTableModelConstructor=Backbone.Model.extend({changes:{},setRateAttribute:function(m,o,p){var l=_.indexBy(this.get("rates"),"id"),n={};if(l[m][o]!==p){n[m]={};n[m][o]=p;l[m][o]=p}this.logChanges(n)},logChanges:function(l){var m=this.changes||{};_.each(l,function(n,o){m[o]=_.extend(m[o]||{id:o},n)});this.changes=m;this.trigger("change:rates")},getFilteredRates:function(){var m=this.get("rates"),l=h.val().toLowerCase();if(l.length){m=_.filter(m,function(o){var n=_.toArray(o).join(" ").toLowerCase();return(-1!==n.indexOf(l))})}m=_.sortBy(m,function(n){return parseInt(n.order,10)});return m},block:function(){g.block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){g.unblock()},save:function(){}}),ERTaxTableViewConstructor=Backbone.View.extend({rowTemplate:j,per_page:b.limit,page:b.page,initialize:function(){var l=Math.ceil(_.toArray(this.model.get("rates")).length/this.per_page);this.qty_pages=0===l?1:l;this.page=this.sanitizePage(b.page);this.listenTo(this.model,"change:rates",this.setUnloadConfirmation);this.listenTo(this.model,"saved:rates",this.clearUnloadConfirmation);e.on("change autocompletechange",":input",{view:this},this.updateModelOnChange);h.on("keyup search",{view:this},this.onSearchField);d.on("click","a",{view:this},this.onPageChange);d.on("change","input",{view:this},this.onPageChange);c(window).on("beforeunload",{view:this},this.unloadConfirmation);k.on("click",{view:this},this.onSubmit);g.find(".insert").on("click",{view:this},this.onAddNewRow);g.find(".remove_tax_rates").on("click",{view:this},this.onDeleteRow);g.find(".export").on("click",{view:this},this.onExport)},render:function(){var o=this.model.getFilteredRates(),l=_.size(o),p=Math.ceil(l/this.per_page),n=0===l?0:this.per_page*(this.page-1),q=this.per_page*this.page,r=_.toArray(o).slice(n,q),m=this;this.$el.empty();if(r.length){c.each(r,function(t,s){m.$el.append(m.rowTemplate(s))})}else{m.$el.append(i())}if(p>1){d.html(f({qty_rates:l,current_page:this.page,qty_pages:p}))}else{d.empty();m.page=1}},updateUrl:function(){if(!window.history.replaceState){return}var l=b.base_url,m=h.val();if(1<this.page){l+="&p="+encodeURIComponent(this.page)}if(m.length){l+="&s="+encodeURIComponent(m)}window.history.replaceState({},"",l)},onSubmit:function(l){l.data.view.clearUnloadConfirmation()},onAddNewRow:function(l){var s=l.data.view,p=s.model,u=_.indexBy(p.get("rates"),"id"),t={},w=_.size(u),v=_.extend({},b.default_rate,{id:"new-"+w+"-"+Date.now(),newRow:true}),m,q,r,o,n;m=e.children(".current");if(m.length){q=m.last().data("id");r=parseInt(u[q].order,10);v.order=1+r;o=_.filter(u,function(x){if(parseInt(x.order,10)>r){return true}return false});n=_.map(o,function(x){x.order++;t[x.id]=_.extend(t[x.id]||{},{order:x.order});return x})}else{v.order=1+_.max(_.pluck(u,"order"),function(x){return parseInt(x,10)});s.page=s.qty_pages}u[v.id]=v;t[v.id]=v;p.set("rates",u);p.logChanges(t);s.render()},onDeleteRow:function(r){var l=r.data.view,n=l.model,o=_.indexBy(n.get("rates"),"id"),q={},p,m;r.preventDefault();if(p=e.children(".current")){p.each(function(){m=c(this).data("id");delete o[m];q[m]=_.extend(q[m]||{},{deleted:"deleted"})});n.set("rates",o);n.logChanges(q);l.render()}else{window.alert(b.strings.no_rows_selected)}},onSearchField:function(l){l.data.view.updateUrl();l.data.view.render()},onPageChange:function(m){var l=c(m.currentTarget);m.preventDefault();m.data.view.page=l.data("goto")?l.data("goto"):l.val();m.data.view.render();m.data.view.updateUrl()},onExport:function(m){var l="data:application/csv;charset=utf-8,"+b.strings.csv_data_cols.join(",")+"\n";c.each(m.data.view.model.getFilteredRates(),function(p,n){var o="";o+=n.country+",";o+=n.state+",";o+=(n.postcode?n.postcode.join("; "):"")+",";o+=(n.city?n.city.join("; "):"")+",";o+=n.tax_rate+",";o+=n.name+",";o+=n.priority+",";o+=n.compound+",";o+=b.current_class;l+=o+"\n"});c(this).attr("href",encodeURI(l));return true},setUnloadConfirmation:function(){this.needsUnloadConfirm=true},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false},unloadConfirmation:function(l){if(l.data.view.needsUnloadConfirm){l.returnValue=b.strings.unload_confirmation_msg;window.event.returnValue=b.strings.unload_confirmation_msg;return b.strings.unload_confirmation_msg}},updateModelOnChange:function(o){var m=o.data.view.model,l=c(o.target),q=l.closest("tr").data("id"),n=l.data("attribute"),p=l.val();if("compound"===n||"flat"===n){if(l.is(":checked")){p=1}else{p=0}}m.setRateAttribute(q,n,p)},sanitizePage:function(l){l=parseInt(l,10);if(l<1){l=1}else{if(l>this.qty_pages){l=this.qty_pages}}return l}}),ERTaxTableModelInstance=new ERTaxTableModelConstructor({rates:b.rates}),ERTaxTableInstance=new ERTaxTableViewConstructor({model:ERTaxTableModelInstance,el:"#rates"});ERTaxTableInstance.render()})})(jQuery,htmlSettingsTaxLocalizeScript,wp);