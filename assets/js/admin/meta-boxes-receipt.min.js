jQuery(function(b){window.erTracks=window.erTracks||{};window.erTracks.recordEvent=window.erTracks.recordEvent||function(){};var a={init:function(){this.stupidtable.init();b("#easyreservations-order-items").on("click","button.add-line-item",this.add_line_item).on("click","button.add-coupon",this.add_coupon).on("click","a.remove-coupon",this.remove_coupon).on("click","button.refund-items",this.refund_items).on("click",".cancel-action",this.cancel).on("click",".refund-actions .cancel-action",this.track_cancel).on("click",".reservation-preview",this.preview_reservation).on("click","button.add-receipt-reservation",this.add_item).on("click","button.add-receipt-fee",this.add_fee).on("click","button.add-receipt-tax",this.add_tax).on("click","button.save-action",this.save_line_items).on("click","a.delete-receipt-tax",this.delete_tax).on("click","button.calculate-action",this.recalculate).on("click","a.edit-receipt-item",this.edit_item).on("click","a.recalculate-receipt-item",this.recalculate_item).on("click","a.delete-receipt-item",this.delete_item).on("click",".delete_refund",this.refunds.delete_refund).on("click","button.do-api-refund, button.do-manual-refund",this.refunds.do_refund).on("change",".refund input.refund_line_total, .refund input.refund_line_tax",this.refunds.input_changed).on("change keyup",".er-receipt-refund-items #refund_amount",this.refunds.amount_changed).on("keyup change",".split-input :input",function(){var c=b(this).parent().prev().find(":input");if(c&&(c.val()===""||c.is(".match-total"))){c.val(b(this).val()).addClass("match-total")}}).on("keyup",".split-input :input",function(){b(this).removeClass("match-total")}).on("click","button.add_receipt_item_meta",this.item_meta.add).on("click","button.remove_receipt_item_meta",this.item_meta.remove).on("er_receipt_items_reload",this.reload_items).on("er_receipt_items_reloaded",this.reloaded_items);b(document.body).on("er_backbone_modal_loaded",this.backbone.init).on("er_backbone_modal_response",this.backbone.response)},block:function(){b("#easyreservations-order-items").block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){b("#easyreservations-order-items").unblock()},reload_items:function(){const c={object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",action:"easyreservations_load_receipt_items",security:easyreservations_admin_meta_boxes.receipt_item_nonce};a.block();b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:c,type:"POST",success:function(d){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(d);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")}})},reloaded_items:function(){a.stupidtable.init()},add_line_item:function(){b("div.er-receipt-add-item").slideDown();b("div.er-receipt-data-row-toggle").not("div.er-receipt-add-item").slideUp();window.erTracks.recordEvent("receipt_edit_add_items_click",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()});return false},add_coupon:function(){window.erTracks.recordEvent("receipt_edit_add_coupon_click",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()});const d=window.prompt(easyreservations_admin_meta_boxes.i18n_apply_coupon);if(null==d){window.erTracks.recordEvent("receipt_edit_add_coupon_cancel",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}else{a.block();var c={action:"easyreservations_add_order_coupon",dataType:"json",order_id:easyreservations_admin_meta_boxes.post_id,security:easyreservations_admin_meta_boxes.receipt_item_nonce,coupon:d,user_id:b("#customer_user").val(),user_email:b("#_billing_email").val()};b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:c,type:"POST",success:function(e){if(e.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(e.data.html);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")}else{window.alert(e.data.error)}a.unblock()},complete:function(){window.erTracks.recordEvent("receipt_edit_added_coupon",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}})}return false},remove_coupon:function(){var d=b(this);a.block();var c={action:"easyreservations_remove_order_coupon",dataType:"json",order_id:easyreservations_admin_meta_boxes.post_id,security:easyreservations_admin_meta_boxes.receipt_item_nonce,coupon:d.data("code")};b.post(easyreservations_admin_meta_boxes.ajax_url,c,function(e){if(e.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(e.data.html);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")}else{window.alert(e.data.error)}a.unblock()})},refund_items:function(){b("div.er-receipt-refund-items").slideDown();b("div.er-receipt-data-row-toggle").not("div.er-receipt-refund-items").slideUp();b("div.er-receipt-totals-items").slideUp();b("#easyreservations-order-items").find("div.refund").show();b(".er-receipt-edit-line-item .er-receipt-edit-line-item-actions").hide();window.erTracks.recordEvent("receipt_edit_refund_button_click",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()});return false},cancel:function(){b("div.er-receipt-data-row-toggle").not("div.er-receipt-bulk-actions").slideUp();b("div.er-receipt-bulk-actions").slideDown();b("div.er-receipt-totals-items").slideDown();b("#easyreservations-order-items").find("div.refund").hide();b(".er-receipt-edit-line-item .er-receipt-edit-line-item-actions").show();if("true"===b(this).attr("data-reload")){a.reload_items()}window.erTracks.recordEvent("receipt_edit_add_items_cancelled",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()});return false},track_cancel:function(){window.erTracks.recordEvent("receipt_edit_refund_cancel",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})},preview_reservation:function(){var c=b(this),d=c.data("reservation-id");if(c.data("reservation-data")){b(this).ERBackboneModal({template:"er-modal-view-reservation",variable:c.data("reservation-data")})}else{c.addClass("disabled");b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:{reservation_id:d,action:"easyreservations_get_reservation_details",security:easyreservations_admin_meta_boxes.preview_nonce},type:"GET",success:function(e){c.removeClass("disabled");if(e.success){c.data("reservation-data",e.data);b(this).ERBackboneModal({template:"er-modal-view-reservation",variable:e.data})}}})}return false},add_item:function(){var d=window.prompt(easyreservations_admin_meta_boxes.i18n_add_reservation);if(null!==d){a.block();var c={action:"easyreservations_add_reservation_to_order",dataType:"json",order_id:b("#object_id").val(),reservation_id:d,security:easyreservations_admin_meta_boxes.receipt_item_nonce};b.post(easyreservations_admin_meta_boxes.ajax_url,c,function(e){if(e.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(e.data.html);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")}else{window.alert(e.data.error)}a.unblock()})}return false},add_fee:function(){window.erTracks.recordEvent("receipt_edit_add_fee_click",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()});var d=window.prompt(easyreservations_admin_meta_boxes.i18n_add_fee);if(null==d){window.erTracks.recordEvent("receipt_edit_add_fee_cancel",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}else{a.block();var c={action:"easyreservations_add_receipt_fee",dataType:"json",object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",security:easyreservations_admin_meta_boxes.receipt_item_nonce,amount:d};b.post(easyreservations_admin_meta_boxes.ajax_url,c,function(e){if(e.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(e.data.html);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips");window.erTracks.recordEvent("receipt_edit_added_fee",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}else{window.alert(e.data.error)}a.unblock()})}return false},add_tax:function(){b(this).ERBackboneModal({template:"er-modal-add-tax"});return false},edit_item:function(){b(this).closest("tr").find(".view").hide();b(this).closest("tr").find(".edit").show();b(this).hide();b("button.add-line-item").click();b("button.cancel-action").attr("data-reload",true);window.erTracks.recordEvent("receipt_edit_edit_item_click",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()});return false},delete_item:function(){var e=window.confirm(easyreservations_admin_meta_boxes.remove_item_notice);if(e){var c=b(this).closest("tr.item, tr.fee, tr.shipping");var f=c.attr("data-receipt_item_id");a.block();var d={object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",receipt_item_ids:f,action:"easyreservations_remove_receipt_item",security:easyreservations_admin_meta_boxes.receipt_item_nonce};if("true"===b("button.cancel-action").attr("data-reload")){d.items=b("table.easyreservations_receipt_items :input[name], .er-receipt-totals-items :input[name]").serialize()}b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:d,type:"POST",success:function(g){if(g.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(g.data.html);if(g.data.notes_html){b("ul.order_notes").empty();b("ul.order_notes").append(b(g.data.notes_html).find("li"))}a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")}else{window.alert(g.data.error)}a.unblock()},complete:function(){window.erTracks.recordEvent("receipt_edit_remove_item",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}})}return false},delete_tax:function(){if(window.confirm(easyreservations_admin_meta_boxes.i18n_delete_tax)){a.block();var c={object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",action:"easyreservations_remove_receipt_tax",rate_id:b(this).attr("data-rate_id"),security:easyreservations_admin_meta_boxes.receipt_item_nonce};b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:c,type:"POST",success:function(d){if(d.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(d.data.html);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")}else{window.alert(d.data.error)}a.unblock()},complete:function(){window.erTracks.recordEvent("receipt_edit_delete_tax",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}})}else{window.erTracks.recordEvent("receipt_edit_delete_tax_cancel",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}return false},recalculate_item:function(d){d.preventDefault();a.block();var c={object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",action:"easyreservations_recalc_line",items_id:b(this).attr("data-item-id"),security:easyreservations_admin_meta_boxes.calc_totals_nonce};b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:c,type:"POST",success:function(e){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(e);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips")},complete:function(e){window.erTracks.recordEvent("receipt_edit_recalc_line",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}})},recalculate:function(){if(window.confirm(easyreservations_admin_meta_boxes.calc_totals)){a.block();var c={object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",action:"easyreservations_calc_line_taxes",items:b("table.easyreservations_receipt_items :input[name], .er-receipt-totals-items :input[name]").serialize(),security:easyreservations_admin_meta_boxes.calc_totals_nonce};b(document.body).trigger("receipt-totals-recalculate-before",c);b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:c,type:"POST",success:function(d){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(d);a.reloaded_items();a.unblock();b(document.body).trigger("init_tooltips");b(document.body).trigger("receipt-totals-recalculate-success",d)},complete:function(d){b(document.body).trigger("receipt-totals-recalculate-complete",d);window.erTracks.recordEvent("receipt_edit_recalc_totals",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}})}else{window.erTracks.recordEvent("receipt_edit_recalc_totals",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}return false},save_line_items:function(){var c={object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",items:b("table.easyreservations_receipt_items :input[name], .er-receipt-totals-items :input[name]").serialize(),action:"easyreservations_save_receipt_items",security:easyreservations_admin_meta_boxes.receipt_item_nonce};a.block();b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:c,type:"POST",success:function(d){if(d.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(d.data.html);if(d.data.notes_html){b("ul.order_notes").empty();b("ul.order_notes").append(b(d.data.notes_html).find("li"))}a.reloaded_items();a.unblock()}else{a.unblock();window.alert(d.data.error)}},complete:function(){window.erTracks.recordEvent("receipt_edit_save_line_items",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}});b(this).trigger("items_saved");return false},refunds:{do_refund:function(){a.block();if(window.confirm(easyreservations_admin_meta_boxes.i18n_do_refund)){var e=b("input#refund_amount").val();var h=b("input#refund_reason").val();var d=b("input#refunded_amount").val();var g={};var c={};b(".refund input.refund_line_total").each(function(i,j){if(b(j).closest("tr").data("receipt_item_id")){g[b(j).closest("tr").data("receipt_item_id")]=accounting.unformat(j.value,er_admin_params.mon_decimal_point)}});b(".refund input.refund_line_tax").each(function(j,k){if(b(k).closest("tr").data("receipt_item_id")){var i=b(k).data("tax_id");if(!c[b(k).closest("tr").data("receipt_item_id")]){c[b(k).closest("tr").data("receipt_item_id")]={}}c[b(k).closest("tr").data("receipt_item_id")][i]=accounting.unformat(k.value,er_admin_params.mon_decimal_point)}});var f={action:"easyreservations_refund_line_items",order_id:easyreservations_admin_meta_boxes.post_id,refund_amount:e,refunded_amount:d,refund_reason:h,line_item_totals:JSON.stringify(g,null,""),line_item_tax_totals:JSON.stringify(c,null,""),api_refund:b(this).is(".do-api-refund"),security:easyreservations_admin_meta_boxes.receipt_item_nonce};b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:f,type:"POST",success:function(i){if(true===i.success){window.location.reload()}else{window.alert(i.data.error);a.reload_items();a.unblock()}},complete:function(){window.erTracks.recordEvent("receipt_edit_save_line_items",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val(),api_refund:f.api_refund,has_reason:Boolean(f.refund_reason.length)})}})}else{a.unblock()}},delete_refund:function(){if(window.confirm(easyreservations_admin_meta_boxes.i18n_delete_refund)){var e=b(this).closest("tr.refund");var c=e.attr("data-order_refund_id");a.block();var d={action:"easyreservations_delete_refund",refund_id:c,security:easyreservations_admin_meta_boxes.receipt_item_nonce};b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:d,type:"POST",success:function(){a.reload_items()}})}return false},input_changed:function(){var c=0;var d=b(".easyreservations_receipt_items").find("tr.item, tr.fee, tr.resource");d.each(function(){var e=b(this);var f=e.find(".refund input");f.each(function(g,h){c+=parseFloat(accounting.unformat(b(h).val()||0,er_admin_params.mon_decimal_point))})});b("#refund_amount").val(accounting.formatNumber(c,easyreservations_admin_meta_boxes.currency_format_num_decimals,"",er_admin_params.mon_decimal_point)).change()},amount_changed:function(){var c=accounting.unformat(b(this).val(),er_admin_params.mon_decimal_point);b("button .er-order-refund-amount .amount").text(accounting.formatMoney(c,{symbol:easyreservations_admin_meta_boxes.currency_format_symbol,decimal:easyreservations_admin_meta_boxes.currency_format_decimal_sep,thousand:easyreservations_admin_meta_boxes.currency_format_thousand_sep,precision:easyreservations_admin_meta_boxes.currency_format_num_decimals,format:easyreservations_admin_meta_boxes.currency_format}))}},item_meta:{add:function(){var f=b(this);var d=f.closest("tr.item");var g=d.find("tbody.meta_items");var e=g.find("tr").length+1;var c='<tr data-meta_id="0"><td><input type="text" maxlength="255" placeholder="'+er_admin_meta_boxes_order_params.placeholder_name+'" name="meta_key['+d.attr("data-receipt_item_id")+"][new-"+e+']" /><textarea placeholder="'+er_admin_meta_boxes_order_params.placeholder_value+'" name="meta_value['+d.attr("data-receipt_item_id")+"][new-"+e+']"></textarea></td><td width="1%"><button class="remove_receipt_item_meta button">&times;</button></td></tr>';g.append(c);return false},remove:function(){if(window.confirm(easyreservations_admin_meta_boxes.remove_item_meta)){const c=b(this).closest("tr");c.find(":input").val("");c.hide()}return false}},backbone:{init:function(d,c){if("wc-modal-add-products"===c){b(document.body).trigger("er-enhanced-select-init");b(this).on("change",".wc-product-search",function(){if(!b(this).closest("tr").is(":last-child")){return}var f=b(this).closest("table.widefat"),g=f.find("tbody"),e=g.find("tr").length,h=g.data("row").replace(/\[0\]/g,"["+e+"]");g.append("<tr>"+h+"</tr>");b(document.body).trigger("er-enhanced-select-init")})}},response:function(j,i,g){if("er-modal-add-tax"===i){a.backbone.add_tax(g.add_order_tax)}if("wc-modal-add-products"===i){var d=b(this).find("table.widefat"),h=d.find("tbody"),f=h.find("tr"),c=[];b(f).each(function(){var e=b(this).find(':input[name="item_id"]').val(),k=b(this).find(':input[name="item_qty"]').val();c.push({id:e,qty:k?k:1})});return a.backbone.add_items(c)}},add_items:function(c){a.block();var d={action:"easyreservations_add_order_item",order_id:easyreservations_admin_meta_boxes.post_id,security:easyreservations_admin_meta_boxes.receipt_item_nonce,data:c};if("true"===b("button.cancel-action").attr("data-reload")){d.items=b("table.easyreservations_receipt_items :input[name], .er-receipt-totals-items :input[name]").serialize()}b.ajax({type:"POST",url:easyreservations_admin_meta_boxes.ajax_url,data:d,success:function(e){if(e.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(e.data.html);if(e.data.notes_html){b("ul.order_notes").empty();b("ul.order_notes").append(b(e.data.notes_html).find("li"))}a.reloaded_items();a.unblock()}else{a.unblock();window.alert(e.data.error)}},complete:function(){window.erTracks.recordEvent("receipt_edit_add_resource",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})},dataType:"json"})},add_tax:function(e){if(!e){return false}var c=b(".receipt-tax-id").map(function(){return b(this).val()}).get();if(-1===b.inArray(e,c)){a.block();var d={action:"easyreservations_add_receipt_tax",rate_id:e,object_id:b("#object_id").val(),object_type:easyreservations_admin_meta_boxes.order?"order":"reservation",security:easyreservations_admin_meta_boxes.receipt_item_nonce};b.ajax({url:easyreservations_admin_meta_boxes.ajax_url,data:d,dataType:"json",type:"POST",success:function(f){if(f.success){b("#easyreservations-order-items").find(".inside").empty();b("#easyreservations-order-items").find(".inside").append(f.data.html);a.reloaded_items()}else{window.alert(f.data.error)}a.unblock()},complete:function(){window.erTracks.recordEvent("receipt_edit_add_tax",{object_id:easyreservations_admin_meta_boxes.post_id,object_type:easyreservations_admin_meta_boxes.post_type,status:b("#order_status,#reservation_status").val()})}})}else{window.alert(easyreservations_admin_meta_boxes.i18n_tax_rate_already_exists)}}},stupidtable:{init:function(){b(".easyreservations_receipt_items").stupidtable();b(".easyreservations_receipt_items").on("aftertablesort",this.add_arrows)},add_arrows:function(e,g){var d=b(this).find("th");var f=g.direction==="asc"?"&uarr;":"&darr;";var c=g.column;d.find(".er-arrow").remove();d.eq(c).append('<span class="er-arrow">'+f+"</span>")}}};a.init()});