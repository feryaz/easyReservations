(function(a){a.fn.isInViewport=function(){var c=a(this).offset().top;var e=c+a(this).outerHeight();var b=a(window).scrollTop();var d=b+a(window).height();return e>b&&c<d};a.fn.dateSelection=function(h){var z=a(this);var j=z.find(".datepicker");var D=false,C=false,p=false,m=false,f=false,u=false,d=false,r=false,B=false,n=er_datepicker_get_args();var A=a.extend({resource:0,arrivalHour:false,arrivalMinute:false,departureHour:false,departureMinute:false,minDate:n.minDate,init:true,departure:true,numberOfMonths:1,time:false},h);if(A.resource===0){A.resource=a("*[name=resource]").val()}z.find("div.arrival").bind("click",function(){v()});z.find("div.departure").bind("click",function(){if(u&&(d||!A.time)){b();if(!j.hasClass("hasDatepicker")){z.find(".departure .text .date").addClass("important").html(er_date_picker_params.wait);c(u);y()}else{z.find(".time-picker > td > div").slideUp(50,function(){j.find(".ui-state-active").removeClass("ui-state-highlight").removeClass("ui-state-active");a(this).closest(".time-picker").remove()})}}});a("*[name=resource]").bind("change",function(){A.resource=a(this).val();v()});if(A.init&&z.find("input[name=arrival]").val()===""){v()}function v(){z.find(".calendar").css("display","block");if(j.hasClass("hasDatepicker")){o(v)}else{z.find(".text .time").html("");D=false;m=false;x();b();z.find(".arrival .text .date").addClass("important").html(er_date_picker_params.wait);z.find("input[name=slot]").val(-1);c(u?u:0);y()}}function g(){if(!p){if(r){if(B||!A.time){o(s);p=true}else{i()}}else{if(u){if(d!==false||!A.time){if(A.departure){z.find(".departure .text .date").addClass("important").html(er_date_picker_params.wait);y()}else{if(j.hasClass("hasDatepicker")){o(g)}else{if(m){var F=D[u][d][0].departure.split(" ");var e=F[1].split(":");l(departure_string[0]);E(e[0],e[1])}s()}p=true}}else{i()}}}}}function i(){var H=a.datepicker.formatDate("DD, d M yy",j.datepicker("getDate"));z.find("a.ui-state-active").parent().parent().after('<tr class="time-picker"><td colspan="7"><div>'+H+'<div class="insert"></div></div></td></tr>');if(m){var e="";if(d!==false){a.each(D[u][d],function(M,J){var N=J.departure.split(" "),L=N[1].split(":"),K=easyFormatTime(L[0],L[1],er_both_params.time_format),O=J.availability<1?"unavailable":(J.availability<f?"partially":"available");if(N[0]!==r){return}e+='<li class="easy-button" data-hour="'+L[0]+'" data-minute="'+L[1]+'" data-id="'+J.key+'" class="'+O+'">'+K+"</li>"})}else{a.each(D[u],function(K,J){a.each(J,function(N,M){var P=K.split(":"),O=easyFormatTime(P[0],P[1],er_both_params.time_format),L="",S=M.availability<1?"unavailable":(M.availability<f?"partially":"available");if(!A.departure){var R=M.departure.split(" ");var Q=R[1].split(":");O+=" -";if(u!==R[0]){O+=" "+R[0]}O+=" "+easyFormatTime(Q[0],Q[1],er_both_params.time_format);L+=' data-departure=" '+R[0]+'"';L+=' data-departure-hour=" '+Q[0]+'"';L+=' data-departure-minute=" '+Q[1]+'"'}e+='<li class="easy-button" data-hour="'+P[0]+'" data-minute="'+P[1]+'" data-id="'+M.key+'" class="'+S+'" '+L+">"+O+"</li>";if(A.departure){return false}})})}if(e!==""){z.find(".time-picker .insert").html('<ul class="option-buttons">'+e+"</ul>");z.find(".time-picker > td > div").slideDown(350);z.find("ul.option-buttons li").bind("click",function(){if(d!==false){z.find("input[name=slot]").val(a(this).attr("data-id"));E(a(this).attr("data-hour"),a(this).attr("data-minute"))}else{if(!A.departure){z.find("input[name=slot]").val(a(this).attr("data-id"));l(a(this).attr("data-departure"));E(a(this).attr("data-departure-hour"),a(this).attr("data-departure-minute"))}t(a(this).attr("data-hour"),a(this).attr("data-minute"))}o(g)})}}else{if(D[r?r:u].availability&&D[r?r:u].availability===parseInt(D[r?r:u].availability,10)){z.find("div.time-prototype").contents().clone(true).appendTo(z.find(".time-picker .insert")).attr("disabled");var G;if(r){G=D[r].time}else{G=D[u].time}var F=D.first_possible.split(" ");if(F[0]===(r?r:u)){var I=F[1].split(":");G[0]=parseInt(G[0],10)<I[0]?parseInt(I[0],10):G[0]}z.find(".time-picker select[name=time_hour] option").each(function(){var J=parseInt(a(this).val());if(J<G[0]||J>G[1]){a(this).attr("disabled",true).prop("selected",false).css("display","none")}else{a(this).attr("disabled",false).css("display","block")}});z.find(".time-picker .apply-time").bind("click",function(){var J=z.find(".time-picker select[name=time_hour]");if(J.length>0){var K=parseInt(z.find(".time-picker select[name=time_minute]").val());if(d!==false){E(J.val(),K)}else{t(J.val(),K);if(A.departure){c(u)}}o(g)}})}else{var e="";a.each(D[r?r:u].availability,function(K,J){var L=K.split(" ");var M=L[0].split(":");var N=J<1?"unavailable":(J<f?"partially":"available");e+='<div class="time-option '+N+'" data-hour="'+M[0]+'" data-minute="'+M[1]+'">'+easyFormatTime(M[0],M[1])+"</div>"});z.find(".time-picker .insert").html('<div class="option-buttons">'+e+"</div>");z.find(".time-picker .time-option.available, .time-picker .time-option.partially").bind("click",function(){if(d!==false){E(a(this).attr("data-hour"),a(this).attr("data-minute"))}else{t(a(this).attr("data-hour"),a(this).attr("data-minute"));if(A.departure){c(u)}}o(g)})}z.find(".time-picker > td > div").slideDown(350)}}function y(F){var G="dd.mm.yy";if(er_both_params.date_format=="Y/m/d"){G="yy/mm/dd"}else{if(er_both_params.date_format=="m/d/Y"){G="mm/dd/yy"}else{if(er_both_params.date_format=="Y-m-d"){G="yy-mm-dd"}else{if(er_both_params.date_format=="d-m-Y"){G="dd-mm-yy"}}}}j.datepicker(a.extend({minDate:u?u:A.minDate,maxDate:F?F:null,dateFormat:G,numberOfMonths:A.numberOfMonths,beforeShowDay:k,onChangeMonthYear:function(H,J,I){if(!m||(!d&&A.time)||(u&&!A.time)){c(G.replace("dd","01").replace("mm",J).replace("yy",H))}z.find("div.time").slideUp(300);if(u&&(d||!A.time)){b();z.find(".departure .text .date").addClass("important").html(er_date_picker_params.wait)}else{x();z.find(".arrival .text .date").addClass("important").html(er_date_picker_params.wait)}},onSelect:q},n)).datepicker("setDate",null).slideDown("300");var e=j.parent().parent();if(f&&!e.isInViewport()){a([document.documentElement,document.body]).animate({scrollTop:e.offset().top-30},500)}j.find(".ui-datepicker").removeClass("ui-datepicker").addClass("easy-datepicker");j.find(".ui-state-active").removeClass("ui-state-highlight").removeClass("ui-state-hover").removeClass("ui-state-active");a.each(er_date_picker_params.datepicker,function(I,H){j.datepicker("option",I,a.parseJSON(H))})}function x(){u=false;d=false;z.find(".arrival .text .date").addClass("important").html(er_date_picker_params.select);z.find(".arrival .text .time").html("");z.find("input[name=arrival]").val("");z.find("input[name=departure_hour]").val("");z.find("input[name=departure_minute]").val("")}function b(){r=false;B=false;p=false;if(u){z.find(".departure .text .date").addClass("important").html(er_date_picker_params.select)}else{z.find(".departure .text .date").removeClass("important").html("&#8212;")}z.find(".departure .text .time").html("");z.find("input[name=departure]").val("");z.find("input[name=departure_hour]").val("");z.find("input[name=departure_minute]").val("");z.find(".departure").removeClass("active")}function w(e){u=e;z.find(".arrival .text .date").removeClass("important").html(e);z.find("input[name=arrival]").val(e);z.find("input[name=arrival_hour]").val("");z.find("input[name=arrival_minute]").val("")}function l(e){r=e;z.find("input[name=departure]").val(e);z.find(".departure").addClass("active");z.find(".departure .text .date").removeClass("important").html(e)}function t(e,G,F){e=easyAddZero(e);G=easyAddZero(G);if(!F){F=easyFormatTime(e,G)}d=e+":"+G;z.find("input[name=arrival_hour]").val(e);z.find("input[name=arrival_minute]").val(G);z.find(".arrival .text .time").html(F)}function E(e,G,F){e=easyAddZero(e);G=easyAddZero(G);if(!F){F=easyFormatTime(e,G)}B=e+":"+G;z.find("input[name=departure_hour]").val(e);z.find("input[name=departure_minute]").val(G);z.find(".departure .text .time").html(F)}function q(G,e){if(u&&(d!==false||!A.time)){if(r===G){b();z.find(".time-picker > td > div").slideUp(50,function(){j.find(".ui-state-active").removeClass("ui-state-highlight").removeClass("ui-state-active")});return false}l(G);if(A.time){setTimeout(i,1)}else{if(m){var F=false;a.each(D[u][d],function(I,H){var K=H.departure.split(" ");if(r===K[0]){var J=K.split(":");E(J[0],J[1]);return false}})}else{E(A.departureHour?A.departureHour:D[r].time[0],A.departureMinute?A.departureMinute:0)}o(g)}}else{if(u===G){x();z.find(".time-picker > td > div").slideUp(50,function(){j.find(".ui-state-active").removeClass("ui-state-highlight").removeClass("ui-state-active")});return false}w(G);if(A.time){setTimeout(i,1)}else{let hour=12;let minute=A.arrivalHour?A.arrivalMinute:0;if(m){let total=Object.keys(D[u])[0].split(":");hour=total[0];minute=total[1]}else{hour=A.arrivalHour?A.arrivalHour:D[u].time[1]}t(hour,minute);if(A.departure){z.find(".departure .text .date").addClass("important").html(er_date_picker_params.wait);c(u)}o(g)}}}function o(e){j.slideUp(350,function(){a(this).datepicker("destroy").removeClass("hasDatepicker").removeAttr("id");if(e){e()}})}function k(K){if(D){var G=easyFormatDate(K,false);if(m&&u&&d!==false){var F;if(d!==false&&A.time){F=D[u][d]}else{F=D[u][Object.keys(D[u])[0]]}var J=[false,"unavailable",""];a.each(F,function(M,L){var N=L.departure.split(" ");if(N[0]===G){J=[true,"available",""];return true}});return J}if(D.hasOwnProperty(G)){if(D[G].availability&&D[G].availability===parseInt(D[G].availability,10)){if(D[G].availability<0){return[false,"unavailable rule",""]}if(D[G].availability<1){return[false,"unavailable",""]}if(D[G].availability<f){return[true,"partially",""]}}else{var e=0;var H;if(m){var I=false;H=D[G][Object.keys(D[G])[0]];a.each(H,function(M,L){if(L.availability>0){I=true;e++}})}else{H=D[G].availability;a.each(H,function(M,L){if(L>0){I=true;e++}})}if(!I){return[false,"unavailable",""]}if(Object.keys(H).length>e){return[true,"partially",""]}}return[true,"available",""]}}return[false,"past",""]}function c(F){var e=Date.now();C=e;D=false;var G={action:"easyreservations_calendar",date:F===0?0:F,arrival:u&&(d!==false||!A.time)?u:0,arrivalTime:d,months:A.numberOfMonths,adults:a("*[name=adults]").val(),children:a("*[name=children]").val(),resource:A.resource,minDate:A.minDate,security:z.find('input[name="easy-date-selection-nonce"]').val()};if(!G.resource){alert("no resource field in form, please fix");return}a.post(er_both_params.ajaxurl,G,function(H){if(C===e){if(u&&(d||!A.time)){z.find(".departure .text .date").addClass("important").html(er_date_picker_params.select)}else{z.find(".arrival .text .date").html(er_date_picker_params.select)}D=H;m=D.hasOwnProperty("slots")&&D.slots;f=er_both_params.resources[A.resource]["quantity"];if(D.hasOwnProperty("max")&&D.max){j.datepicker("refresh")}else{j.datepicker("refresh")}j.find(".ui-datepicker-today a, .ui-datepicker-current-day a").removeClass("ui-state-highlight").removeClass("ui-state-hover").removeClass("ui-state-active")}})}function s(){z.find("input[name=arrival]").trigger("change")}}})(jQuery);